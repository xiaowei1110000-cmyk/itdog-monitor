<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ITDOGç½‘ç«™æµ‹é€Ÿç›‘æ§ç³»ç»Ÿ - GitHubé…ç½®ä¸­å¿ƒ</title>
    <style>
        /* æ‰€æœ‰ä¹‹å‰çš„CSSæ ·å¼ä¿æŒä¸å˜ï¼Œåªæ˜¯æ·»åŠ éšè—æ ·å¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25);
            padding: 40px;
            margin-top: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        /* å…¶ä»–CSSæ ·å¼ä¿æŒä¸å˜... */
        
        /* æ·»åŠ éšè—è„šæœ¬çš„æ ·å¼ */
        .script-section-hidden {
            display: none !important;
        }
        
        .script-toggle {
            cursor: pointer;
            color: #3498db;
            text-decoration: underline;
            font-size: 0.9rem;
            margin-left: 10px;
        }
        
        .script-toggle:hover {
            color: #2980b9;
        }
        
        /* è¯Šæ–­ä¿¡æ¯æ ·å¼ */
        .diagnostic-info {
            background: #f8f9fa;
            border-left: 5px solid #007bff;
            padding: 20px;
            margin: 25px 0;
            border-radius: 12px;
        }
        
        .diagnostic-info h4 {
            color: #007bff;
            margin-bottom: 15px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .diagnostic-list {
            list-style-type: none;
            padding-left: 0;
        }
        
        .diagnostic-item {
            padding: 10px 0;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .diagnostic-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.8rem;
        }
        
        .icon-success {
            background: #28a745;
        }
        
        .icon-warning {
            background: #ffc107;
        }
        
        .icon-error {
            background: #dc3545;
        }
        
        .icon-info {
            background: #17a2b8;
        }
        
        .diagnostic-details {
            font-size: 0.9rem;
            color: #495057;
        }
        
        .diagnostic-action {
            margin-left: auto;
            padding: 5px 10px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-tachometer-alt"></i> ITDOGç½‘ç«™æµ‹é€Ÿç›‘æ§ç³»ç»Ÿ</h1>
            <p class="subtitle">GitHub Pagesé…ç½®ä¸­å¿ƒ | Telegramå¼‚å¸¸é€šçŸ¥ | å®šæ—¶æµ‹è¯•</p>
        </header>
        
        <div class="instructions">
            <h4><i class="fas fa-info-circle"></i> ç³»ç»Ÿè¯´æ˜</h4>
            <p>1. æœ¬ç³»ç»Ÿé€šè¿‡Tampermonkeyè„šæœ¬è‡ªåŠ¨ç›‘æ§ç½‘ç«™è¿é€šç‡</p>
            <p>2. å½“è¿é€šç‡ä½äºè®¾å®šé˜ˆå€¼æ—¶ï¼Œè‡ªåŠ¨å‘é€Telegramé€šçŸ¥</p>
            <p>3. æ”¯æŒå®šæ—¶è‡ªåŠ¨æµ‹è¯•ï¼ˆ1å°æ—¶ã€4å°æ—¶ã€12å°æ—¶ã€24å°æ—¶ï¼‰</p>
            <p>4. é…ç½®ä¿å­˜åœ¨GitHub Pagesä¸­ï¼Œè·¨è®¾å¤‡åŒæ­¥</p>
            <p>5. å¿…é¡»å…ˆé…ç½®Telegramä¿¡æ¯æ‰èƒ½ä½¿ç”¨é€šçŸ¥åŠŸèƒ½</p>
        </div>
        
        <!-- è¯Šæ–­ä¿¡æ¯ -->
        <div class="diagnostic-info" id="diagnostic-section">
            <h4><i class="fas fa-stethoscope"></i> Tampermonkeyè„šæœ¬è¯Šæ–­</h4>
            <ul class="diagnostic-list" id="diagnostic-list">
                <li class="diagnostic-item">
                    <div class="diagnostic-icon icon-info">1</div>
                    <div class="diagnostic-details">æ£€æµ‹Tampermonkeyæ‰©å±•æ˜¯å¦å®‰è£…...</div>
                </li>
                <li class="diagnostic-item">
                    <div class="diagnostic-icon icon-info">2</div>
                    <div class="diagnostic-details">æ£€æŸ¥è„šæœ¬æ˜¯å¦æ­£ç¡®å®‰è£…...</div>
                </li>
                <li class="diagnostic-item">
                    <div class="diagnostic-icon icon-info">3</div>
                    <div class="diagnostic-details">éªŒè¯é…ç½®æ˜¯å¦æ­£ç¡®...</div>
                </li>
                <li class="diagnostic-item">
                    <div class="diagnostic-icon icon-info">4</div>
                    <div class="diagnostic-details">æµ‹è¯•è„šæœ¬é€šä¿¡...</div>
                </li>
            </ul>
            <div style="margin-top: 15px;">
                <button class="btn btn-telegram" id="run-diagnostic-btn">
                    <i class="fas fa-search btn-icon"></i> è¿è¡Œè¯Šæ–­
                </button>
                <button class="btn btn-success" id="fix-script-btn" style="display: none;">
                    <i class="fas fa-wrench btn-icon"></i> ä¿®å¤è„šæœ¬
                </button>
                <button class="btn btn-secondary" id="view-script-btn">
                    <i class="fas fa-code btn-icon"></i> æ˜¾ç¤ºè„šæœ¬ä»£ç 
                </button>
            </div>
        </div>
        
        <!-- Telegramé…ç½® -->
        <div class="config-section">
            <h4><i class="fab fa-telegram"></i> Telegramé€šçŸ¥é…ç½®</h4>
            
            <div class="input-group">
                <label for="bot-token">Telegram Bot Token</label>
                <input type="password" id="bot-token" placeholder="è¾“å…¥Bot Token (æ ¼å¼: 1234567890:ABCdefGHIjklMNOpqrsTUVwxyz)">
            </div>
            
            <div class="input-group">
                <label for="chat-id">Telegram Chat ID</label>
                <input type="text" id="chat-id" placeholder="è¾“å…¥Chat ID (åœ¨@userinfobotä¸­è·å–)">
            </div>
            
            <div class="buttons">
                <button class="btn btn-telegram" id="save-config-btn">
                    <i class="fas fa-save btn-icon"></i> ä¿å­˜é…ç½®
                </button>
                <button class="btn btn-success" id="test-config-btn">
                    <i class="fas fa-paper-plane btn-icon"></i> æµ‹è¯•é€šçŸ¥
                </button>
                <button class="btn btn-telegram" id="get-chat-id-btn">
                    <i class="fas fa-id-card btn-icon"></i> è·å–Chat ID
                </button>
                <button class="btn btn-secondary" id="clear-config-btn">
                    <i class="fas fa-trash btn-icon"></i> æ¸…é™¤é…ç½®
                </button>
            </div>
            
            <div id="config-status" class="status-message"></div>
        </div>
        
        <!-- å®šæ—¶æµ‹è¯•é…ç½® -->
        <div class="schedule-controls">
            <h4><i class="fas fa-clock"></i> å®šæ—¶æµ‹è¯•é…ç½®</h4>
            
            <div class="input-group">
                <label>æµ‹è¯•é¢‘ç‡</label>
                <div class="schedule-buttons">
                    <button class="schedule-btn active" data-minutes="60">1å°æ—¶</button>
                    <button class="schedule-btn" data-minutes="240">4å°æ—¶</button>
                    <button class="schedule-btn" data-minutes="720">12å°æ—¶</button>
                    <button class="schedule-btn" data-minutes="1440">24å°æ—¶</button>
                </div>
                <div style="margin-top: 10px;">
                    <input type="number" id="custom-interval" placeholder="è‡ªå®šä¹‰åˆ†é’Ÿæ•°" style="width: 150px;">
                    <span style="margin-left: 10px; color: #666;">åˆ†é’Ÿ</span>
                </div>
            </div>
            
            <div class="buttons">
                <button class="btn btn-success" id="start-schedule-btn">
                    <i class="fas fa-play btn-icon"></i> å¯åŠ¨å®šæ—¶æµ‹è¯•
                </button>
                <button class="btn btn-secondary" id="stop-schedule-btn" style="display: none;">
                    <i class="fas fa-stop btn-icon"></i> åœæ­¢å®šæ—¶
                </button>
            </div>
            
            <div class="timer-status" style="margin-top: 20px; padding: 15px; background: white; border-radius: 8px; display: none;">
                <h5 style="margin-bottom: 10px;">å®šæ—¶çŠ¶æ€</h5>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
                    <div>
                        <div style="font-size: 0.8rem; color: #666;">çŠ¶æ€</div>
                        <div style="font-weight: bold;" id="schedule-status">è¿è¡Œä¸­</div>
                    </div>
                    <div>
                        <div style="font-size: 0.8rem; color: #666;">ä¸‹æ¬¡æµ‹è¯•</div>
                        <div style="font-weight: bold;" id="next-test-time">--:--</div>
                    </div>
                    <div>
                        <div style="font-size: 0.8rem; color: #666;">è¿è¡Œæ¬¡æ•°</div>
                        <div style="font-weight: bold;" id="test-count">0</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æ‰¹é‡æµ‹è¯• -->
        <div class="config-section">
            <h4><i class="fas fa-globe"></i> æ‰¹é‡ç½‘ç«™æµ‹è¯•</h4>
            
            <div class="input-group">
                <label for="domains">è¦æµ‹è¯•çš„ç½‘ç«™åœ°å€ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰</label>
                <textarea id="domains" placeholder="https://www.example.com&#10;www.google.com&#10;github.com"></textarea>
                <div class="example">
                    <strong>ç¤ºä¾‹ï¼š</strong><br>
                    https://www.alibabacloud.com<br>
                    www.dynadot.com<br>
                    itdog.cn
                </div>
            </div>
            
            <div class="buttons">
                <button class="btn btn-success" id="start-test-btn">
                    <i class="fas fa-rocket btn-icon"></i> å¼€å§‹æ‰¹é‡æµ‹è¯•
                </button>
                <button class="btn btn-secondary" id="clear-domains-btn">
                    <i class="fas fa-redo btn-icon"></i> æ¸…ç©ºåˆ—è¡¨
                </button>
                <button class="btn btn-secondary" id="manual-test-btn">
                    <i class="fas fa-play-circle btn-icon"></i> æ‰‹åŠ¨æµ‹è¯•ä¸€æ¬¡
                </button>
                <button class="btn btn-telegram" id="debug-script-btn">
                    <i class="fas fa-bug btn-icon"></i> è°ƒè¯•è„šæœ¬
                </button>
            </div>
            
            <!-- åŸŸååˆ—è¡¨ -->
            <div class="domain-list" id="domain-list" style="display: none;">
                <h5 style="margin-bottom: 15px;">æµ‹è¯•é˜Ÿåˆ—</h5>
                <div id="domains-container"></div>
            </div>
            
            <!-- æµ‹è¯•æ§åˆ¶ -->
            <div class="test-controls" id="test-controls" style="display: none;">
                <div class="test-stats">
                    <div class="stat-item">
                        <div class="stat-label">å·²æµ‹è¯•</div>
                        <div class="stat-value" id="tested-count">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">è¿›è¡Œä¸­</div>
                        <div class="stat-value" id="active-count">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">å¾…æµ‹è¯•</div>
                        <div class="stat-value" id="pending-count">0</div>
                    </div>
                </div>
                
                <div class="progress-container">
                    <div class="progress-info">
                        <span>æµ‹è¯•è¿›åº¦</span>
                        <span id="progress-text">0/0</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-bar"></div>
                    </div>
                </div>
                
                <div class="buttons">
                    <button class="btn btn-success" id="pause-btn">
                        <i class="fas fa-pause btn-icon"></i> æš‚åœ
                    </button>
                    <button class="btn btn-secondary" id="stop-btn">
                        <i class="fas fa-stop btn-icon"></i> åœæ­¢
                    </button>
                </div>
            </div>
            
            <!-- ç›‘æ§æ—¥å¿— -->
            <div class="monitor-log" id="monitor-log" style="display: none;">
                <div class="log-entry">ç­‰å¾…å¼€å§‹æµ‹è¯•...</div>
            </div>
        </div>
        
        <!-- Tampermonkeyè„šæœ¬ï¼ˆé»˜è®¤éšè—ï¼‰ -->
        <div class="script-section script-section-hidden" id="script-section">
            <h4><i class="fas fa-robot"></i> Tampermonkeyè„šæœ¬å®‰è£… <span class="script-toggle" id="script-toggle">[éšè—]</span></h4>
            <p><strong>é‡è¦ï¼šå¿…é¡»å®‰è£…æ­¤è„šæœ¬æ‰èƒ½è‡ªåŠ¨ç›‘æ§å¹¶å‘é€Telegramé€šçŸ¥ï¼</strong></p>
            
            <div style="margin: 15px 0;">
                <button class="copy-btn" id="copy-script-btn">
                    <i class="fas fa-copy"></i> å¤åˆ¶Tampermonkeyè„šæœ¬
                </button>
                <button class="copy-btn" id="install-script-btn" style="background: #28a745;">
                    <i class="fas fa-download"></i> ä¸€é”®å®‰è£…è„šæœ¬
                </button>
            </div>
            
            <div class="script-code" id="script-code">
// ==UserScript==
// @name         ITDOGç½‘ç«™æµ‹é€Ÿç›‘æ§ - å®Œæ•´åŠŸèƒ½ç‰ˆ
// @namespace    http://tampermonkey.net/
// @version      4.0
// @description  è‡ªåŠ¨æå–åŸŸåã€å–æ¶ˆæ¸¯æ¾³å°é€‰é¡¹ã€ç‚¹å‡»å¼€å§‹æµ‹è¯•ã€ç›‘æ§è¿é€šç‡å¹¶å‘é€Telegramé€šçŸ¥
// @author       ITDOGç›‘æ§ç³»ç»Ÿ
// @match        https://www.itdog.cn/http/*
// @run-at       document-idle
// @grant        GM_xmlhttpRequest
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_addStyle
// @connect      api.telegram.org
// @connect      *
// ==/UserScript==

(function() {
    'use strict';

    console.log('ğŸš€ ITDOGç›‘æ§è„šæœ¬å¯åŠ¨ - å®Œæ•´åŠŸèƒ½ç‰ˆ v4.0');

    // é…ç½®
    const CONFIG = {
        maxChecks: 50,
        checkInterval: 1500,
        minSuccessRate: 90,
        autoCloseTimeout: 5 * 60 * 1000 // 5åˆ†é’Ÿåå…³é—­
    };

    // å­˜å‚¨é…ç½®çš„é”®å
    const CONFIG_KEY = 'itdog_telegram_config';
    
    // è·å–å­˜å‚¨çš„Telegramé…ç½®
    function getStoredConfig() {
        try {
            const configStr = GM_getValue(CONFIG_KEY);
            if (configStr) {
                return JSON.parse(configStr);
            }
        } catch (error) {
            console.log('è¯»å–å­˜å‚¨é…ç½®å¤±è´¥:', error);
        }
        return null;
    }
    
    // ä¿å­˜é…ç½®åˆ°å­˜å‚¨
    function saveConfig(config) {
        try {
            GM_setValue(CONFIG_KEY, JSON.stringify(config));
            return true;
        } catch (error) {
            console.log('ä¿å­˜é…ç½®å¤±è´¥:', error);
            return false;
        }
    }

    // è·å–Telegramé…ç½®ï¼ˆä»å­˜å‚¨æˆ–openerï¼‰
    async function getTelegramConfig() {
        console.log('ğŸ” è·å–Telegramé…ç½®...');
        
        // é¦–å…ˆæ£€æŸ¥å­˜å‚¨çš„é…ç½®
        const storedConfig = getStoredConfig();
        if (storedConfig && storedConfig.botToken && storedConfig.chatId) {
            console.log('âœ… ä»æœ¬åœ°å­˜å‚¨è¯»å–é…ç½®');
            return storedConfig;
        }
        
        // å¦‚æœæ²¡æœ‰å­˜å‚¨çš„é…ç½®ï¼Œå°è¯•ä»openerè·å–
        return new Promise((resolve) => {
            try {
                if (window.opener && !window.opener.closed) {
                    console.log('å°è¯•ä»ä¸»é¡µé¢è·å–é…ç½®...');
                    window.opener.postMessage({ type: 'REQUEST_TELEGRAM_CONFIG' }, '*');
                    
                    const messageHandler = function(event) {
                        if (event.data.type === 'TELEGRAM_CONFIG') {
                            window.removeEventListener('message', messageHandler);
                            console.log('âœ… ä»ä¸»é¡µé¢è·å–é…ç½®æˆåŠŸ');
                            
                            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                            if (event.data.config) {
                                saveConfig(event.data.config);
                            }
                            
                            resolve(event.data.config);
                        }
                    };
                    
                    window.addEventListener('message', messageHandler);
                    
                    // 3ç§’è¶…æ—¶
                    setTimeout(() => {
                        window.removeEventListener('message', messageHandler);
                        console.log('è·å–é…ç½®è¶…æ—¶');
                        resolve(null);
                    }, 3000);
                } else {
                    console.log('æ— æ³•è®¿é—®opener');
                    resolve(null);
                }
            } catch (error) {
                console.log('è·å–é…ç½®å¤±è´¥:', error);
                resolve(null);
            }
        });
    }

    // å‘é€Telegramé€šçŸ¥
    async function sendToTelegram(domain, connectivityRate, testResults) {
        try {
            console.log('ğŸ“¤ å‡†å¤‡å‘é€Telegramé€šçŸ¥...');
            
            const config = await getTelegramConfig();
            
            if (!config || !config.botToken || !config.chatId) {
                console.log('âŒ Telegramé…ç½®æ— æ•ˆï¼Œæ— æ³•å‘é€é€šçŸ¥');
                showErrorMessage('Telegramé…ç½®æ— æ•ˆï¼Œè¯·æ£€æŸ¥é…ç½®é¡µé¢');
                return false;
            }
            
            const { botToken, chatId } = config;
            
            const now = new Date();
            const currentTime = now.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            }).replace(/\//g, '-');

            // è®¡ç®—ç»Ÿè®¡
            const totalTests = testResults.totalTests || 140;
            const successTests = testResults.success200Tests || Math.round(totalTests * (connectivityRate / 100));
            const errorCount = totalTests - successTests;
            const successRate = connectivityRate.toFixed(2);
            
            // æ„å»ºæ¶ˆæ¯
            let message = `ğŸ”” ITDOGç›‘æ§å‘Šè­¦\\n\\n`;
            message += `âš ï¸ é—®é¢˜åŸŸå: ${domain}\\n`;
            message += `ğŸ•’ æ£€æµ‹æ—¶é—´: ${currentTime}\\n`;
            message += `ğŸ“Š æ€»æµ‹è¯•èŠ‚ç‚¹: ${totalTests}\\n`;
            message += `âŒ å¼‚å¸¸èŠ‚ç‚¹: ${errorCount}\\n`;
            message += `âœ… å¯è®¿é—®ç‡: ${successRate}%\\n\\n`;

            // åœ°åŒºåˆ—è¡¨
            const regions = [
                'æµ™æ±Ÿ-æ­å·-è”é€š', 'å¹¿ä¸œ-ä¸œè-ç”µä¿¡', 'æµ·å—-æµ·å£-ç”µä¿¡',
                'å¹¿ä¸œ-ä½›å±±-ç”µä¿¡', 'ç¦å»º-é¾™å²©-ç”µä¿¡', 'å››å·-çœ‰å±±-è”é€š',
                'å››å·-æˆéƒ½-è”é€š', 'æµ™æ±Ÿ-å®æ³¢-ç”µä¿¡', 'ç”˜è‚ƒ-å…°å·-è”é€š',
                'å¹¿ä¸œ-å¹¿å·-ç§»åŠ¨', 'ä¸Šæµ·-ä¸Šæµ·-ç”µä¿¡', 'æµ™æ±Ÿ-æ¸©å·-ç”µä¿¡',
                'æ¹–åŒ—-åå °-ç”µä¿¡', 'åŒ—äº¬-åŒ—äº¬-ç”µä¿¡', 'å±±ä¸œ-æµå—-è”é€š',
                'é™•è¥¿-å’¸é˜³-è”é€š', 'æµ™æ±Ÿ-æ­å·-ç§»åŠ¨', 'æµ™æ±Ÿ-å®æ³¢-ç§»åŠ¨',
                'å¹¿ä¸œ-æ·±åœ³-ç”µä¿¡', 'æ±Ÿè¥¿-å—æ˜Œ-ç§»åŠ¨', 'æ¹–åŒ—-æ­¦æ±‰-è”é€š',
                'å¹¿ä¸œ-æ·±åœ³-ç§»åŠ¨', 'å¹¿è¥¿-æ¡‚æ—-è”é€š', 'æ±Ÿè‹-å—äº¬-ç§»åŠ¨',
                'æ±Ÿè¥¿-å—æ˜Œ-ç”µä¿¡', 'å±±ä¸œ-æ³°å®‰-è”é€š', 'é’æµ·-è¥¿å®-ç”µä¿¡',
                'æ²³å—-æ´›é˜³-ç”µä¿¡', 'å±±ä¸œ-æ·„åš-è”é€š', 'äº‘å—-æ˜†æ˜-è”é€š'
            ];

            // ç”Ÿæˆå¼‚å¸¸è¯¦æƒ…
            const maxErrors = Math.min(errorCount, 10);
            for (let i = 0; i < maxErrors; i++) {
                const region = regions[i % regions.length];
                message += `âš¡ ${region} | è®¿é—®å¼‚å¸¸\\n`;
            }

            if (errorCount > 10) {
                message += `\\n...è¿˜æœ‰ ${errorCount - 10} ä¸ªå¼‚å¸¸èŠ‚ç‚¹\\n`;
            }
            
            message += `\\nå¯è®¿é—®ç‡ä½äº${CONFIG.minSuccessRate}%ï¼Œè¯·åŠæ—¶å¤„ç†ï¼`;

            // å‘é€è¯·æ±‚
            return new Promise((resolve) => {
                GM_xmlhttpRequest({
                    method: 'POST',
                    url: `https://api.telegram.org/bot${botToken}/sendMessage`,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    data: JSON.stringify({
                        chat_id: chatId,
                        text: message,
                        parse_mode: 'Markdown',
                        disable_web_page_preview: true
                    }),
                    timeout: 10000,
                    onload: function(response) {
                        try {
                            const data = JSON.parse(response.responseText);
                            if (data.ok) {
                                console.log('âœ… Telegramé€šçŸ¥å‘é€æˆåŠŸï¼');
                                showSuccessMessage(domain, connectivityRate);
                                resolve(true);
                            } else {
                                console.log('âŒ Telegramå‘é€å¤±è´¥:', data.description);
                                showErrorMessage('Telegramå‘é€å¤±è´¥: ' + data.description);
                                resolve(false);
                            }
                        } catch (e) {
                            console.log('âŒ è§£æå“åº”å¤±è´¥:', e);
                            showErrorMessage('è§£æå“åº”å¤±è´¥');
                            resolve(false);
                        }
                    },
                    onerror: function(error) {
                        console.log('âŒ ç½‘ç»œè¯·æ±‚å¤±è´¥:', error);
                        showErrorMessage('ç½‘ç»œè¯·æ±‚å¤±è´¥');
                        resolve(false);
                    },
                    ontimeout: function() {
                        console.log('âŒ è¯·æ±‚è¶…æ—¶');
                        showErrorMessage('è¯·æ±‚è¶…æ—¶');
                        resolve(false);
                    }
                });
            });

        } catch (error) {
            console.log('âŒ å‘é€Telegramå¤±è´¥:', error);
            showErrorMessage('å‘é€è¿‡ç¨‹å‡ºé”™: ' + error.message);
            return false;
        }
    }

    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
    function showSuccessMessage(domain, rate) {
        const div = document.createElement('div');
        div.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            z-index: 999999;
            font-size: 14px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            font-family: 'Segoe UI', sans-serif;
            max-width: 300px;
            animation: slideIn 0.5s ease-out;
        `;
        div.innerHTML = `
            <div style="font-weight: bold; margin-bottom: 10px;">âœ… Telegramé€šçŸ¥å·²å‘é€</div>
            <div>åŸŸå: <strong>${domain}</strong></div>
            <div>è¿é€šç‡: <strong>${rate}%</strong></div>
        `;
        document.body.appendChild(div);
        
        setTimeout(() => {
            if (div.parentNode) div.parentNode.removeChild(div);
        }, 5000);
    }

    // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
    function showErrorMessage(message) {
        const div = document.createElement('div');
        div.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            z-index: 999999;
            font-size: 14px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            font-family: 'Segoe UI', sans-serif;
            max-width: 300px;
            animation: slideIn 0.5s ease-out;
        `;
        div.innerHTML = `
            <div style="font-weight: bold; margin-bottom: 10px;">âŒ å‘é€å¤±è´¥</div>
            <div>${message}</div>
        `;
        document.body.appendChild(div);
        
        setTimeout(() => {
            if (div.parentNode) div.parentNode.removeChild(div);
        }, 5000);
    }

    // è·å–åŸŸåå‚æ•°
    function getDomainFromURL() {
        try {
            const urlParams = new URLSearchParams(window.location.search);
            const domain = urlParams.get('domain');
            if (!domain) {
                console.log('æœªæ‰¾åˆ°åŸŸåå‚æ•°');
                return null;
            }
            return decodeURIComponent(domain);
        } catch (error) {
            console.log('è·å–åŸŸåå‚æ•°å¤±è´¥:', error);
            return null;
        }
    }

    // æŸ¥æ‰¾å¹¶å¡«å……åŸŸåè¾“å…¥æ¡†
    function findAndFillInput(domain) {
        console.log('ğŸ” æŸ¥æ‰¾è¾“å…¥æ¡†å¹¶å¡«å……åŸŸå:', domain);

        const findInput = setInterval(() => {
            const inputs = document.querySelectorAll('input[type="text"], textarea, input[type="url"]');
            for (const input of inputs) {
                if (input.offsetParent !== null && 
                   (input.placeholder?.toLowerCase().includes('åŸŸå') || 
                    input.placeholder?.toLowerCase().includes('host') ||
                    input.name?.toLowerCase().includes('host') ||
                    input.name?.toLowerCase().includes('domain') ||
                    input.id?.toLowerCase().includes('host') ||
                    input.id?.toLowerCase().includes('domain'))) {
                    
                    clearInterval(findInput);
                    
                    // å¡«å……åŸŸå
                    input.value = domain;
                    input.dispatchEvent(new Event('input', { bubbles: true }));
                    input.dispatchEvent(new Event('change', { bubbles: true }));
                    
                    console.log('âœ… åŸŸåå·²å¡«å……åˆ°è¾“å…¥æ¡†:', input);
                    
                    // æ˜¾ç¤ºè„šæœ¬æ ‡è¯†
                    showScriptIdentifier(domain);
                    
                    // å–æ¶ˆ"æ¸¯æ¾³å°ï¼Œæµ·å¤–"é€‰é¡¹
                    setTimeout(() => {
                        uncheckHongKongMacaoTaiwan();
                    }, 500);
                    
                    // å¼€å§‹æµ‹è¯•
                    setTimeout(() => {
                        startTest();
                    }, 1000);
                    
                    return;
                }
            }
            
            // å¦‚æœæ‰¾ä¸åˆ°ï¼Œå°è¯•æ›´é€šç”¨çš„æ–¹æ³•
            if (document.activeElement && document.activeElement.tagName === 'INPUT') {
                clearInterval(findInput);
                document.activeElement.value = domain;
                console.log('âœ… åŸŸåå·²å¡«å……åˆ°å½“å‰ç„¦ç‚¹è¾“å…¥æ¡†');
                
                showScriptIdentifier(domain);
                setTimeout(() => {
                    uncheckHongKongMacaoTaiwan();
                    setTimeout(() => startTest(), 500);
                }, 500);
            }
            
        }, 500);
    }

    // å–æ¶ˆ"æ¸¯æ¾³å°ï¼Œæµ·å¤–"é€‰é¡¹
    function uncheckHongKongMacaoTaiwan() {
        console.log('ğŸ” æŸ¥æ‰¾å¹¶å–æ¶ˆ"æ¸¯æ¾³å°ï¼Œæµ·å¤–"é€‰é¡¹...');
        
        let found = false;
        
        // æŸ¥æ‰¾æ‰€æœ‰å¤é€‰æ¡†
        const checkboxes = document.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
            // è·å–å‘¨å›´çš„æ–‡æœ¬å†…å®¹
            const parentText = checkbox.parentElement?.textContent || '';
            const label = document.querySelector(`label[for="${checkbox.id}"]`);
            const labelText = label ? label.textContent : '';
            
            const allText = (parentText + labelText).toLowerCase();
            
            // æ£€æŸ¥æ˜¯å¦åŒ…å«ç›®æ ‡å…³é”®è¯
            const targetKeywords = ['æ¸¯æ¾³å°', 'é¦™æ¸¯', 'æ¾³é—¨', 'å°æ¹¾', 'æµ·å¤–', 'å›½å¤–', 'å›½é™…'];
            
            for (const keyword of targetKeywords) {
                if (allText.includes(keyword)) {
                    if (checkbox.checked) {
                        console.log(`âœ… æ‰¾åˆ°å¹¶å–æ¶ˆå‹¾é€‰: ${keyword}`);
                        checkbox.click();
                        found = true;
                    }
                    break;
                }
            }
        });
        
        if (!found) {
            console.log('âš ï¸ æœªæ‰¾åˆ°"æ¸¯æ¾³å°ï¼Œæµ·å¤–"é€‰é¡¹ï¼Œå¯èƒ½é¡µé¢ç»“æ„å·²å˜åŒ–');
        }
        
        return found;
    }

    // å¼€å§‹æµ‹è¯•
    function startTest() {
        console.log('ğŸ” æŸ¥æ‰¾æµ‹è¯•æŒ‰é’®...');
        
        const findTestButton = () => {
            // æŸ¥æ‰¾æ‰€æœ‰å¯èƒ½çš„æŒ‰é’®
            const buttons = document.querySelectorAll('button, .btn, .ant-btn, .el-button, input[type="button"], input[type="submit"]');
            
            for (const button of buttons) {
                const text = (button.textContent || '').toLowerCase();
                const html = (button.innerHTML || '').toLowerCase();
                const value = (button.value || '').toLowerCase();
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯æµ‹è¯•æŒ‰é’®
                const isTestButton = 
                    text.includes('æµ‹è¯•') || 
                    text.includes('test') ||
                    text.includes('å¼€å§‹') ||
                    text.includes('æ£€æµ‹') ||
                    text.includes('æµ‹é€Ÿ') ||
                    html.includes('æµ‹è¯•') ||
                    html.includes('test') ||
                    value.includes('æµ‹è¯•') ||
                    value.includes('test');
                
                if (isTestButton && !button.disabled && button.offsetParent !== null) {
                    console.log('âœ… æ‰¾åˆ°æµ‹è¯•æŒ‰é’®ï¼Œç‚¹å‡»:', button);
                    button.click();
                    return true;
                }
            }
            
            // å°è¯•æŸ¥æ‰¾åŒ…å«ç‰¹å®šç±»çš„æŒ‰é’®
            const btnByClass = document.querySelectorAll('[class*="test"], [class*="start"], [class*="btn-start"]');
            for (const button of btnByClass) {
                if (button.tagName === 'BUTTON' || button.tagName === 'INPUT') {
                    console.log('âœ… é€šè¿‡ç±»åæ‰¾åˆ°æŒ‰é’®ï¼Œç‚¹å‡»:', button);
                    button.click();
                    return true;
                }
            }
            
            return false;
        };
        
        // å°è¯•å¤šæ¬¡æŸ¥æ‰¾
        let attempts = 0;
        const buttonInterval = setInterval(() => {
            attempts++;
            if (findTestButton()) {
                clearInterval(buttonInterval);
                console.log('âœ… å·²å¼€å§‹æµ‹è¯•');
                
                // å¼€å§‹ç›‘æ§æµ‹è¯•ç»“æœ
                setTimeout(() => {
                    monitorTestResults();
                }, 3000);
            } else if (attempts >= 20) {
                clearInterval(buttonInterval);
                console.log('âŒ æœªæ‰¾åˆ°æµ‹è¯•æŒ‰é’®ï¼Œè¯·æ‰‹åŠ¨ç‚¹å‡»å¼€å§‹æµ‹è¯•');
                showManualOperationPrompt();
            }
        }, 1000);
    }

    // æ˜¾ç¤ºæ‰‹åŠ¨æ“ä½œæç¤º
    function showManualOperationPrompt() {
        const domain = getDomainFromURL();
        if (!domain) return;
        
        const prompt = document.createElement('div');
        prompt.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            z-index: 999999;
            font-size: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 500px;
            width: 90%;
        `;
        prompt.innerHTML = `
            <div style="font-weight: bold; margin-bottom: 15px; font-size: 18px;">âš ï¸ è‡ªåŠ¨æ“ä½œå¤±è´¥</div>
            <div style="margin-bottom: 20px;">è¯·æ‰‹åŠ¨æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</div>
            <div style="text-align: left; margin-bottom: 20px; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                <div style="margin-bottom: 10px;">1. åœ¨è¾“å…¥æ¡†ä¸­ç²˜è´´åŸŸå: <strong style="color: #fff; background: rgba(0,0,0,0.2); padding: 2px 6px; border-radius: 4px;">${domain}</strong></div>
                <div style="margin-bottom: 10px;">2. <strong>å–æ¶ˆå‹¾é€‰"æ¸¯æ¾³å°ï¼Œæµ·å¤–"é€‰é¡¹</strong></div>
                <div style="margin-bottom: 10px;">3. ç‚¹å‡»"å¼€å§‹æµ‹è¯•"æŒ‰é’®</div>
            </div>
            <div style="font-size: 14px; opacity: 0.9;">è„šæœ¬å°†ç»§ç»­ç›‘æ§æµ‹è¯•ç»“æœå¹¶è‡ªåŠ¨å‘é€é€šçŸ¥</div>
        `;
        document.body.appendChild(prompt);
        
        // æ·»åŠ å…³é—­æŒ‰é’®
        const closeBtn = document.createElement('button');
        closeBtn.textContent = 'çŸ¥é“äº†';
        closeBtn.style.cssText = `
            margin-top: 20px;
            padding: 10px 20px;
            background: white;
            color: #e67e22;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        `;
        closeBtn.onclick = () => prompt.remove();
        prompt.appendChild(closeBtn);
    }

    // æ˜¾ç¤ºè„šæœ¬æ ‡è¯†
    function showScriptIdentifier(domain) {
        // ç§»é™¤æ—§çš„æ ‡è¯†
        const oldId = document.getElementById('itdog-script-identifier');
        if (oldId) oldId.remove();
        
        const identifier = document.createElement('div');
        identifier.id = 'itdog-script-identifier';
        identifier.style.cssText = `
            position: fixed;
            top: 10px;
            right: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            z-index: 999999;
            font-size: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            font-family: 'Segoe UI', sans-serif;
            max-width: 250px;
            border: 2px solid white;
        `;
        identifier.innerHTML = `
            <div style="display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 14px;">ğŸ¤–</span>
                <div>
                    <div style="font-weight: bold; font-size: 11px;">ITDOGç›‘æ§è„šæœ¬ v4.0</div>
                    <div style="font-size: 10px; opacity: 0.9;">æ­£åœ¨ç›‘æ§: ${domain.substring(0, 30)}${domain.length > 30 ? '...' : ''}</div>
                </div>
            </div>
        `;
        document.body.appendChild(identifier);
    }

    // æå–è¿é€šç‡æ•°æ®
    function extractConnectivityData() {
        console.log('ğŸ“Š æå–è¿é€šç‡æ•°æ®...');

        let totalTests = 0;
        let success200Tests = 0;
        let otherStatusCodes = [];
        let connectivityRate = null;

        try {
            // æ–¹æ³•1: æŸ¥æ‰¾ç™¾åˆ†æ¯”æ˜¾ç¤º
            const percentElements = document.querySelectorAll('*');
            for (const element of percentElements) {
                const text = element.textContent.trim();
                if (text.includes('%') && text.includes('è¿é€šç‡')) {
                    const match = text.match(/(\d+(\.\d+)?)%/);
                    if (match) {
                        connectivityRate = parseFloat(match[1]);
                        console.log('âœ… ä»æ–‡æœ¬æ‰¾åˆ°è¿é€šç‡:', connectivityRate + '%');
                        break;
                    }
                }
            }
            
            // æ–¹æ³•2: æŸ¥æ‰¾çŠ¶æ€ç è¡¨æ ¼
            if (connectivityRate === null) {
                const tables = document.querySelectorAll('table');
                for (const table of tables) {
                    const rows = table.querySelectorAll('tr');
                    for (const row of rows) {
                        const cells = row.querySelectorAll('td, th');
                        for (const cell of cells) {
                            const text = cell.textContent;
                            // æŸ¥æ‰¾çŠ¶æ€ç 
                            const statusMatch = text.match(/\b(\d{3})\b/);
                            if (statusMatch) {
                                const code = parseInt(statusMatch[1]);
                                totalTests++;
                                if (code === 200) {
                                    success200Tests++;
                                } else {
                                    otherStatusCodes.push(code);
                                }
                            }
                        }
                    }
                }
                
                if (totalTests > 0) {
                    connectivityRate = Math.round((success200Tests / totalTests) * 100);
                    console.log(`è¡¨æ ¼ç»Ÿè®¡: 200=${success200Tests}, å…¶ä»–=${otherStatusCodes.length}, æ€»è®¡=${totalTests}, è¿é€šç‡=${connectivityRate}%`);
                }
            }
            
            // æ–¹æ³•3: æŸ¥æ‰¾æ‰€æœ‰çŠ¶æ€ç 
            if (totalTests === 0) {
                const allText = document.body.textContent;
                const statusCodePattern = /\b(\d{3})\b/g;
                let match;
                
                while ((match = statusCodePattern.exec(allText)) !== null) {
                    const code = parseInt(match[1]);
                    if (code >= 100 && code <= 599) {
                        totalTests++;
                        if (code === 200) {
                            success200Tests++;
                        } else {
                            otherStatusCodes.push(code);
                        }
                    }
                }
                
                if (totalTests > 0) {
                    connectivityRate = Math.round((success200Tests / totalTests) * 100);
                    console.log(`æ­£åˆ™ç»Ÿè®¡: 200=${success200Tests}, å…¶ä»–=${otherStatusCodes.length}, æ€»è®¡=${totalTests}, è¿é€šç‡=${connectivityRate}%`);
                }
            }

        } catch (error) {
            console.log('æå–è¿é€šç‡æ•°æ®å‡ºé”™:', error);
        }

        return {
            rate: connectivityRate,
            success200Tests: success200Tests,
            totalTests: totalTests,
            otherStatusCodes: otherStatusCodes,
            isLowRate: connectivityRate !== null && connectivityRate < CONFIG.minSuccessRate
        };
    }

    // ç›‘æ§æµ‹è¯•ç»“æœ
    async function monitorTestResults() {
        console.log('ğŸ” å¼€å§‹ç›‘æ§æµ‹è¯•ç»“æœ...');
        
        const domain = getDomainFromURL();
        if (!domain) return;
        
        let checkCount = 0;
        let hasSentData = false;
        
        const intervalId = setInterval(async () => {
            checkCount++;
            
            const data = extractConnectivityData();
            let { rate, success200Tests, totalTests, otherStatusCodes, isLowRate } = data;
            
            console.log(`ç›‘æ§è¿›åº¦ ${checkCount}/${CONFIG.maxChecks}:`, data);
            
            if (totalTests > 0 && rate !== null && !hasSentData) {
                clearInterval(intervalId);
                
                console.log('ğŸ“Š æµ‹è¯•å®Œæˆ:', data);
                
                // å‘é€ç»“æœåˆ°ä¸»é¡µé¢
                try {
                    if (window.opener && !window.opener.closed) {
                        window.opener.postMessage({
                            type: 'ITDOG_TEST_RESULT',
                            domain: domain,
                            rate: rate,
                            data: data,
                            timestamp: new Date().toISOString()
                        }, '*');
                        console.log('âœ… ç»“æœå·²å‘é€åˆ°ä¸»é¡µé¢');
                    }
                } catch (e) {
                    console.log('å‘é€ç»“æœåˆ°ä¸»é¡µé¢å¤±è´¥:', e);
                }
                
                // å¦‚æœæ˜¯ä½è¿é€šç‡ï¼Œå‘é€Telegramé€šçŸ¥
                if (isLowRate) {
                    console.log(`ğŸ“¤ è¿é€šç‡${rate}%ä½äº${CONFIG.minSuccessRate}%ï¼Œå‘é€Telegramé€šçŸ¥`);
                    await sendToTelegram(domain, rate, data);
                } else {
                    console.log(`âœ… è¿é€šç‡${rate}%æ­£å¸¸ï¼Œæ— éœ€å‘é€é€šçŸ¥`);
                }
                
                hasSentData = true;
                
                // æ˜¾ç¤ºå®Œæˆæç¤º
                showCompletionMessage(domain, rate, data);
                
                // 5åˆ†é’Ÿåå…³é—­æ ‡ç­¾é¡µ
                setTimeout(() => {
                    console.log('â° 5åˆ†é’Ÿè¶…æ—¶ï¼Œå…³é—­æ ‡ç­¾é¡µ');
                    window.close();
                }, CONFIG.autoCloseTimeout);
            }
            
            if (checkCount >= CONFIG.maxChecks && !hasSentData) {
                clearInterval(intervalId);
                console.log('âŒ ç›‘æ§è¶…æ—¶');
                
                // è¶…æ—¶ä¹Ÿå‘é€é€šçŸ¥
                await sendToTelegram(domain, 0, {
                    totalTests: 0,
                    success200Tests: 0,
                    errorMessage: 'æµ‹è¯•è¶…æ—¶'
                });
                
                setTimeout(() => {
                    window.close();
                }, 10000);
            }
            
        }, CONFIG.checkInterval);
    }

    // æ˜¾ç¤ºå®Œæˆæç¤º
    function showCompletionMessage(domain, rate, testResults) {
        const div = document.createElement('div');
        div.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 25px;
            border-radius: 15px;
            z-index: 1000000;
            text-align: center;
            min-width: 350px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: fadeInScale 0.5s ease-out;
        `;
        
        let statusText = 'æµ‹è¯•å®Œæˆ';
        let statusIcon = 'âœ…';
        let messageColor = '#2ecc71';
        
        if (rate < CONFIG.minSuccessRate) {
            statusText = 'è¿é€šç‡ä½';
            statusIcon = 'âš ï¸';
            messageColor = '#f39c12';
        }
        
        div.innerHTML = `
            <div style="font-size: 36px; margin-bottom: 15px;">${statusIcon}</div>
            <div style="font-weight: bold; font-size: 18px; margin-bottom: 10px;">${statusText}</div>
            <div style="margin-bottom: 5px; font-size: 14px; word-break: break-all;">${domain}</div>
            <div style="margin-bottom: 15px; font-size: 28px; font-weight: bold; color: ${messageColor}">
                è¿é€šç‡: ${rate}%
            </div>
            <div style="margin-bottom: 10px; font-size: 12px; opacity: 0.8;">
                çŠ¶æ€ç 200: ${testResults.success200Tests}/${testResults.totalTests}
            </div>
            <div style="font-size: 12px; opacity: 0.8;">5åˆ†é’Ÿåè‡ªåŠ¨å…³é—­</div>
        `;
        document.body.appendChild(div);
    }

    // ä¸»å‡½æ•°
    function main() {
        const domain = getDomainFromURL();
        if (!domain) {
            console.log('âŒ æœªæ‰¾åˆ°åŸŸåå‚æ•°');
            showErrorMessage('æœªæ‰¾åˆ°åŸŸåå‚æ•°');
            return;
        }
        
        console.log('ğŸ¯ å¼€å§‹å¤„ç†åŸŸå:', domain);
        
        // æ˜¾ç¤ºè„šæœ¬æ ‡è¯†
        showScriptIdentifier(domain);
        
        // æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
        const welcome = document.createElement('div');
        welcome.style.cssText = `
            position: fixed;
            top: 60px;
            right: 10px;
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            z-index: 999999;
            font-size: 12px;
            font-family: 'Segoe UI', sans-serif;
            max-width: 300px;
            animation: slideIn 0.5s ease-out;
        `;
        welcome.innerHTML = `
            <div style="font-weight: bold;">ITDOGç›‘æ§è„šæœ¬å·²å¯åŠ¨</div>
            <div>æ­£åœ¨å¤„ç†: ${domain}</div>
        `;
        document.body.appendChild(welcome);
        
        setTimeout(() => welcome.remove(), 3000);
        
        // å¡«å……åŸŸå
        setTimeout(() => {
            findAndFillInput(domain);
        }, 1000);
    }

    // æ·»åŠ CSSåŠ¨ç”»
    GM_addStyle(`
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes fadeInScale {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }
    `);

    // å¯åŠ¨è„šæœ¬
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', main);
    } else {
        setTimeout(main, 1000);
    }
})();
            </div>
        </div>
        
        <footer>
            <p>GitHub Pagesé…ç½®ä¸­å¿ƒ | Â© 2026 ITDOGç½‘ç«™æµ‹é€Ÿç›‘æ§ç³»ç»Ÿ | å®Œæ•´åŠŸèƒ½ç‰ˆ | ä»…ä¾›å­¦ä¹ ä½¿ç”¨</p>
            <p>åœ¨ä½¿ç”¨å‰è¯·ç¡®ä¿å·²å®‰è£… <a href="https://www.tampermonkey.net/" target="_blank" style="color: white; text-decoration: underline;">Tampermonkey</a> æ‰©å±•</p>
        </footer>
    </div>

<script>
        // ============================================
        // GitHub Pagesé…ç½®ä¸­å¿ƒ - JavaScriptä»£ç 
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            // å…ƒç´ å¼•ç”¨
            const elements = {
                botToken: document.getElementById('bot-token'),
                chatId: document.getElementById('chat-id'),
                saveConfigBtn: document.getElementById('save-config-btn'),
                testConfigBtn: document.getElementById('test-config-btn'),
                getChatIdBtn: document.getElementById('get-chat-id-btn'),
                clearConfigBtn: document.getElementById('clear-config-btn'),
                configStatus: document.getElementById('config-status'),
                domains: document.getElementById('domains'),
                startTestBtn: document.getElementById('start-test-btn'),
                clearDomainsBtn: document.getElementById('clear-domains-btn'),
                manualTestBtn: document.getElementById('manual-test-btn'),
                debugScriptBtn: document.getElementById('debug-script-btn'),
                domainList: document.getElementById('domain-list'),
                domainsContainer: document.getElementById('domains-container'),
                testControls: document.getElementById('test-controls'),
                monitorLog: document.getElementById('monitor-log'),
                copyScriptBtn: document.getElementById('copy-script-btn'),
                installScriptBtn: document.getElementById('install-script-btn'),
                scriptCode: document.getElementById('script-code'),
                scriptSection: document.getElementById('script-section'),
                scriptToggle: document.getElementById('script-toggle'),
                viewScriptBtn: document.getElementById('view-script-btn'),
                
                // è¯Šæ–­ç›¸å…³
                diagnosticSection: document.getElementById('diagnostic-section'),
                diagnosticList: document.getElementById('diagnostic-list'),
                runDiagnosticBtn: document.getElementById('run-diagnostic-btn'),
                fixScriptBtn: document.getElementById('fix-script-btn'),
                
                // å®šæ—¶æµ‹è¯•
                startScheduleBtn: document.getElementById('start-schedule-btn'),
                stopScheduleBtn: document.getElementById('stop-schedule-btn'),
                scheduleStatus: document.getElementById('schedule-status'),
                nextTestTime: document.getElementById('next-test-time'),
                testCount: document.getElementById('test-count'),
                
                // æµ‹è¯•æ§åˆ¶
                pauseBtn: document.getElementById('pause-btn'),
                stopBtn: document.getElementById('stop-btn'),
                testedCount: document.getElementById('tested-count'),
                activeCount: document.getElementById('active-count'),
                pendingCount: document.getElementById('pending-count'),
                progressText: document.getElementById('progress-text'),
                progressBar: document.getElementById('progress-bar')
            };

            // çŠ¶æ€å˜é‡
            let telegramConfig = null;
            let domainArray = [];
            let currentIndex = 0;
            let isTesting = false;
            let isPaused = false;
            let activeTabs = 0;
            let openedTabs = [];
            let batchSize = 3;
            let testInterval = 5000;
            
            // å®šæ—¶æµ‹è¯•å˜é‡
            let scheduleRunning = false;
            let scheduleInterval = 60 * 60 * 1000; // é»˜è®¤1å°æ—¶
            let scheduleTimer = null;
            let testCycleCount = 0;
            let nextTestTimestamp = null;

            // åŠ è½½é…ç½®
            function loadConfig() {
                try {
                    const configStr = localStorage.getItem('telegram_config');
                    if (configStr) {
                        telegramConfig = JSON.parse(configStr);
                        elements.botToken.value = telegramConfig.botToken || '';
                        elements.chatId.value = telegramConfig.chatId || '';
                        showStatus('å·²åŠ è½½ä¿å­˜çš„é…ç½®', 'success');
                    }
                    
                    // åŠ è½½å®šæ—¶è®¾ç½®
                    const scheduleConfig = localStorage.getItem('schedule_config');
                    if (scheduleConfig) {
                        const config = JSON.parse(scheduleConfig);
                        scheduleInterval = config.interval || 60 * 60 * 1000;
                        testCycleCount = config.cycleCount || 0;
                        
                        // æ¿€æ´»å¯¹åº”çš„æŒ‰é’®
                        document.querySelectorAll('.schedule-btn').forEach(btn => {
                            const minutes = parseInt(btn.dataset.minutes);
                            if (minutes === scheduleInterval / 60000) {
                                btn.classList.add('active');
                            }
                        });
                        
                        if (config.running) {
                            startSchedule();
                        }
                    }
                    
                    // åŠ è½½åŸŸååˆ—è¡¨
                    const domainsConfig = localStorage.getItem('domains_config');
                    if (domainsConfig) {
                        elements.domains.value = domainsConfig;
                    }
                } catch (error) {
                    console.log('åŠ è½½é…ç½®å¤±è´¥:', error);
                }
            }

            // ä¿å­˜é…ç½®
            function saveConfig() {
                const botToken = elements.botToken.value.trim();
                const chatId = elements.chatId.value.trim();
                
                if (!botToken) {
                    showStatus('è¯·è¾“å…¥Bot Token', 'error');
                    return;
                }
                
                if (!chatId) {
                    showStatus('è¯·è¾“å…¥Chat ID', 'error');
                    return;
                }
                
                if (!botToken.match(/^\d+:[A-Za-z0-9_-]+$/)) {
                    showStatus('Bot Tokenæ ¼å¼ä¸æ­£ç¡®', 'error');
                    return;
                }
                
                try {
                    telegramConfig = {
                        botToken: botToken,
                        chatId: chatId,
                        lastUpdated: new Date().toISOString()
                    };
                    
                    localStorage.setItem('telegram_config', JSON.stringify(telegramConfig));
                    showStatus('é…ç½®ä¿å­˜æˆåŠŸ', 'success');
                    console.log('Telegramé…ç½®å·²ä¿å­˜');
                } catch (error) {
                    showStatus('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
                    console.log('ä¿å­˜é…ç½®å¤±è´¥:', error);
                }
            }

            // è·å–Chat ID
            function getChatId() {
                const botToken = elements.botToken.value.trim();
                
                if (!botToken) {
                    showStatus('è¯·è¾“å…¥Bot Token', 'error');
                    return;
                }
                
                if (!botToken.match(/^\d+:[A-Za-z0-9_-]+$/)) {
                    showStatus('Bot Tokenæ ¼å¼ä¸æ­£ç¡®', 'error');
                    return;
                }
                
                showStatus('æ­£åœ¨è·å–Chat ID...', 'info');
                
                fetch(`https://api.telegram.org/bot${botToken}/getUpdates`)
                    .then(response => response.json())
                    .then(data => {
                        if (!data.ok) {
                            showStatus('è¯·æ±‚å¤±è´¥: ' + data.description, 'error');
                            return;
                        }
                        
                        if (!data.result || data.result.length === 0) {
                            showStatus('æ²¡æœ‰æ‰¾åˆ°æ¶ˆæ¯ï¼Œè¯·å…ˆç»™æœºå™¨äººå‘é€ä¸€æ¡æ¶ˆæ¯', 'error');
                            return;
                        }
                        
                        // æ˜¾ç¤ºæ‰¾åˆ°çš„Chat ID
                        let message = 'æ‰¾åˆ°çš„Chat ID:\n\n';
                        data.result.forEach((update, index) => {
                            if (update.message && update.message.chat) {
                                const chat = update.message.chat;
                                const from = update.message.from;
                                const date = new Date(update.message.date * 1000).toLocaleString();
                                
                                message += `${index + 1}. ç±»å‹: ${chat.type}\n`;
                                message += `   Chat ID: ${chat.id}\n`;
                                message += `   æ ‡é¢˜: ${chat.title || 'ç§èŠ'}\n`;
                                message += `   å‘é€è€…: ${from.first_name} (${from.username || 'æ— ç”¨æˆ·å'})\n`;
                                message += `   æ—¶é—´: ${date}\n\n`;
                                
                                // å¦‚æœæ˜¯ç§èŠï¼Œè‡ªåŠ¨å¡«å……Chat ID
                                if (chat.type === 'private') {
                                    elements.chatId.value = chat.id;
                                    showStatus('å·²è‡ªåŠ¨å¡«å……ç§èŠChat ID', 'success');
                                    return;
                                }
                            }
                        });
                        
                        // æ˜¾ç¤ºé€‰æ‹©å¯¹è¯æ¡†
                        const selectedId = prompt(message + '\nè¯·é€‰æ‹©è¦ä½¿ç”¨çš„Chat IDï¼ˆè¾“å…¥æ•°å­—ï¼‰:');
                        if (selectedId && data.result[selectedId - 1] && data.result[selectedId - 1].message) {
                            const chatId = data.result[selectedId - 1].message.chat.id;
                            elements.chatId.value = chatId;
                            showStatus('Chat IDå·²è®¾ç½®', 'success');
                        }
                    })
                    .catch(error => {
                        showStatus('ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
                    });
            }

            // æ¸…é™¤é…ç½®
            function clearConfig() {
                if (confirm('ç¡®å®šè¦æ¸…é™¤Telegramé…ç½®å—ï¼Ÿ')) {
                    telegramConfig = null;
                    elements.botToken.value = '';
                    elements.chatId.value = '';
                    localStorage.removeItem('telegram_config');
                    showStatus('é…ç½®å·²æ¸…é™¤', 'info');
                }
            }

            // æµ‹è¯•é…ç½®
            function testConfig() {
                if (!telegramConfig) {
                    showStatus('è¯·å…ˆä¿å­˜é…ç½®', 'error');
                    return;
                }
                
                const { botToken, chatId } = telegramConfig;
                
                showStatus('æ­£åœ¨æµ‹è¯•Telegramè¿æ¥...', 'info');
                addLog('æ­£åœ¨æµ‹è¯•Telegramè¿æ¥...');
                
                const now = new Date();
                const currentTime = now.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                }).replace(/\//g, '-');
                
                const testMessage = `âœ… ITDOGç›‘æ§ç³»ç»Ÿæµ‹è¯•æ¶ˆæ¯\\n\\nğŸ•’ å‘é€æ—¶é—´: ${currentTime}\\nğŸ“Š æµ‹è¯•çŠ¶æ€: è¿æ¥æ­£å¸¸\\nğŸ”§ é…ç½®éªŒè¯: æˆåŠŸ\\n\\nç³»ç»Ÿå·²å‡†å¤‡å°±ç»ªï¼`;
                
                fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat_id: chatId,
                        text: testMessage,
                        parse_mode: 'HTML',
                        disable_web_page_preview: true
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.ok) {
                        showStatus('âœ… Telegramè¿æ¥æµ‹è¯•æˆåŠŸï¼Œè¯·æ£€æŸ¥Telegramæ¶ˆæ¯', 'success');
                        addLog('âœ… Telegramè¿æ¥æµ‹è¯•æˆåŠŸ');
                    } else {
                        showStatus('âŒ Telegramè¿æ¥å¤±è´¥: ' + (data.description || 'æœªçŸ¥é”™è¯¯'), 'error');
                        addLog('âŒ Telegramè¿æ¥å¤±è´¥: ' + data.description);
                        
                        // å¦‚æœæ˜¯Chat IDé—®é¢˜
                        if (data.description && data.description.includes('chat') && data.description.includes('group')) {
                            showStatus('âš ï¸ å¯èƒ½æ˜¯Chat IDå·²æ”¹å˜ï¼Œè¯·ä½¿ç”¨"è·å–Chat ID"æŒ‰é’®é‡æ–°è·å–', 'error');
                        }
                    }
                })
                .catch(error => {
                    showStatus('âŒ ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
                    addLog('âŒ ç½‘ç»œé”™è¯¯: ' + error.message);
                });
            }

            // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
            function showStatus(message, type) {
                elements.configStatus.textContent = message;
                elements.configStatus.className = 'status-message';
                
                if (type === 'success') {
                    elements.configStatus.classList.add('status-success');
                } else if (type === 'error') {
                    elements.configStatus.classList.add('status-error');
                } else {
                    elements.configStatus.classList.add('status-info');
                }
                
                elements.configStatus.style.display = 'block';
                
                setTimeout(() => {
                    if (type !== 'info') {
                        elements.configStatus.style.display = 'none';
                    }
                }, 5000);
            }

            // æ·»åŠ æ—¥å¿—
            function addLog(message) {
                const now = new Date();
                const timeString = now.toLocaleTimeString();
                
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                logEntry.innerHTML = `<span style="color: #6c757d;">[${timeString}]</span> ${message}`;
                
                elements.monitorLog.appendChild(logEntry);
                elements.monitorLog.scrollTop = elements.monitorLog.scrollHeight;
                
                // ä¿æŒæ—¥å¿—æ•°é‡ä¸è¶…è¿‡100æ¡
                const logEntries = elements.monitorLog.querySelectorAll('.log-entry');
                if (logEntries.length > 100) {
                    for (let i = 0; i < logEntries.length - 100; i++) {
                        logEntries[i].remove();
                    }
                }
            }

            // å¼€å§‹æ‰¹é‡æµ‹è¯•
            function startBatchTest() {
                const domains = elements.domains.value.trim();
                if (!domains) {
                    alert('è¯·è¾“å…¥è¦æµ‹è¯•çš„ç½‘ç«™åœ°å€');
                    return;
                }
                
                // ä¿å­˜åŸŸååˆ—è¡¨
                localStorage.setItem('domains_config', domains);
                
                domainArray = domains.split('\n')
                    .map(domain => domain.trim())
                    .filter(domain => domain.length > 0)
                    .map(domain => {
                        if (!domain.startsWith('http://') && !domain.startsWith('https://')) {
                            return 'https://' + domain;
                        }
                        return domain;
                    });
                
                if (domainArray.length === 0) return;
                
                // æ˜¾ç¤ºåŸŸååˆ—è¡¨
                elements.domainsContainer.innerHTML = '';
                domainArray.forEach((domain, index) => {
                    const item = document.createElement('div');
                    item.className = 'domain-item';
                    item.innerHTML = `
                        <div class="domain-name">${index + 1}. ${domain}</div>
                        <div class="domain-status status-pending" id="status-${index}">ç­‰å¾…</div>
                    `;
                    elements.domainsContainer.appendChild(item);
                });
                
                elements.domainList.style.display = 'block';
                elements.testControls.style.display = 'block';
                elements.monitorLog.style.display = 'block';
                
                // é‡ç½®çŠ¶æ€
                currentIndex = 0;
                isTesting = true;
                isPaused = false;
                activeTabs = 0;
                openedTabs = [];
                
                elements.testedCount.textContent = '0';
                elements.activeCount.textContent = '0';
                elements.pendingCount.textContent = domainArray.length;
                elements.progressText.textContent = `0/${domainArray.length}`;
                elements.progressBar.style.width = '0%';
                
                addLog(`å¼€å§‹æ‰¹é‡æµ‹è¯•ï¼Œå…± ${domainArray.length} ä¸ªåŸŸå`);
                
                // å¼€å§‹æ‰“å¼€æ ‡ç­¾é¡µ
                openNextBatch();
            }

            // æ‰“å¼€ä¸‹ä¸€æ‰¹æ¬¡
            function openNextBatch() {
                if (!isTesting || isPaused || currentIndex >= domainArray.length) {
                    if (currentIndex >= domainArray.length && activeTabs === 0) {
                        addLog('âœ… æ‰€æœ‰åŸŸåæµ‹è¯•å®Œæˆ');
                        isTesting = false;
                    }
                    return;
                }
                
                const batchCount = Math.min(batchSize, domainArray.length - currentIndex);
                addLog(`æ‰“å¼€æ‰¹æ¬¡ ${Math.floor(currentIndex / batchSize) + 1} (${batchCount}ä¸ªåŸŸå)`);
                
                for (let i = 0; i < batchCount; i++) {
                    const domainIndex = currentIndex + i;
                    const domain = domainArray[domainIndex];
                    
                    // æ›´æ–°çŠ¶æ€
                    const statusElement = document.getElementById(`status-${domainIndex}`);
                    if (statusElement) {
                        statusElement.textContent = 'æµ‹è¯•ä¸­';
                        statusElement.className = 'domain-status status-testing';
                    }
                    
                    // å»¶è¿Ÿæ‰“å¼€
                    setTimeout(() => {
                        openITDOGTab(domain, domainIndex);
                    }, i * 1000);
                }
                
                currentIndex += batchCount;
                
                // æ›´æ–°UI
                updateProgress();
                
                // å®‰æ’ä¸‹ä¸€æ‰¹æ¬¡
                if (currentIndex < domainArray.length) {
                    setTimeout(() => {
                        if (!isPaused) {
                            openNextBatch();
                        }
                    }, testInterval);
                }
            }

            // åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€ITDOG
            function openITDOGTab(domain, index) {
                try {
                    const cleanDomain = domain.replace(/^https?:\/\//, '');
                    const url = `https://www.itdog.cn/http/?domain=${encodeURIComponent(cleanDomain)}`;
                    
                    // åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€
                    const tab = window.open(url, '_blank');
                    
                    if (tab) {
                        activeTabs++;
                        openedTabs.push({
                            tab: tab,
                            index: index,
                            domain: domain,
                            openedAt: Date.now()
                        });
                        
                        // ç›‘å¬æ ‡ç­¾é¡µå…³é—­
                        const checkClose = setInterval(() => {
                            if (tab.closed) {
                                clearInterval(checkClose);
                                activeTabs--;
                                
                                // æ›´æ–°çŠ¶æ€
                                const statusElement = document.getElementById(`status-${index}`);
                                if (statusElement) {
                                    statusElement.textContent = 'å·²å®Œæˆ';
                                    statusElement.className = 'domain-status status-success';
                                }
                                
                                addLog(`æ ‡ç­¾é¡µå…³é—­: ${domain}`);
                                
                                // æ£€æŸ¥æ˜¯å¦å…¨éƒ¨å®Œæˆ
                                if (currentIndex >= domainArray.length && activeTabs === 0) {
                                    addLog('âœ… æ‰€æœ‰æµ‹è¯•å®Œæˆ');
                                    isTesting = false;
                                    
                                    // å¦‚æœæ˜¯å®šæ—¶æµ‹è¯•ï¼Œæ›´æ–°çŠ¶æ€
                                    if (scheduleRunning) {
                                        updateScheduleStatus();
                                    }
                                }
                            }
                        }, 1000);
                        
                        addLog(`æ ‡ç­¾é¡µå·²æ‰“å¼€: ${domain}`);
                    } else {
                        addLog(`âŒ æ— æ³•æ‰“å¼€æ ‡ç­¾é¡µ: ${domain} (å¯èƒ½è¢«æµè§ˆå™¨é˜»æ­¢)`);
                        const statusElement = document.getElementById(`status-${index}`);
                        if (statusElement) {
                            statusElement.textContent = 'å¤±è´¥';
                            statusElement.className = 'domain-status status-error';
                        }
                    }
                } catch (error) {
                    addLog(`âŒ æ‰“å¼€æ ‡ç­¾é¡µå‡ºé”™: ${error.message}`);
                }
            }

            // æ›´æ–°è¿›åº¦
            function updateProgress() {
                elements.testedCount.textContent = Math.min(currentIndex, domainArray.length);
                elements.activeCount.textContent = activeTabs;
                elements.pendingCount.textContent = Math.max(0, domainArray.length - currentIndex);
                elements.progressText.textContent = `${Math.min(currentIndex, domainArray.length)}/${domainArray.length}`;
                
                const progressPercent = (Math.min(currentIndex, domainArray.length) / domainArray.length) * 100;
                elements.progressBar.style.width = `${progressPercent}%`;
            }

            // æš‚åœæµ‹è¯•
            function pauseTest() {
                if (!isTesting) return;
                
                if (isPaused) {
                    isPaused = false;
                    elements.pauseBtn.innerHTML = '<i class="fas fa-pause btn-icon"></i> æš‚åœ';
                    addLog('ç»§ç»­æµ‹è¯•');
                    openNextBatch();
                } else {
                    isPaused = true;
                    elements.pauseBtn.innerHTML = '<i class="fas fa-play btn-icon"></i> ç»§ç»­';
                    addLog('æµ‹è¯•æš‚åœ');
                }
            }

            // åœæ­¢æµ‹è¯•
            function stopTest() {
                if (!isTesting && openedTabs.length === 0) return;
                
                isTesting = false;
                isPaused = false;
                
                // å…³é—­æ‰€æœ‰æ‰“å¼€çš„æ ‡ç­¾é¡µ
                openedTabs.forEach(item => {
                    try {
                        if (item.tab && !item.tab.closed) {
                            item.tab.close();
                        }
                    } catch (e) {
                        console.log('å…³é—­æ ‡ç­¾é¡µå¤±è´¥:', e);
                    }
                });
                
                openedTabs = [];
                activeTabs = 0;
                
                addLog('æµ‹è¯•å·²åœæ­¢');
                
                // é‡ç½®çŠ¶æ€æ˜¾ç¤º
                for (let i = 0; i < domainArray.length; i++) {
                    const statusElement = document.getElementById(`status-${i}`);
                    if (statusElement) {
                        statusElement.textContent = 'å·²å–æ¶ˆ';
                        statusElement.className = 'domain-status status-pending';
                    }
                }
            }

            // æ‰‹åŠ¨æµ‹è¯•ä¸€æ¬¡
            function manualTest() {
                const domains = elements.domains.value.trim();
                if (!domains) {
                    alert('è¯·å…ˆè®¾ç½®è¦æµ‹è¯•çš„ç½‘ç«™åˆ—è¡¨');
                    return;
                }
                
                if (isTesting) {
                    alert('å½“å‰æ­£åœ¨æµ‹è¯•ä¸­ï¼Œè¯·ç¨åå†è¯•');
                    return;
                }
                
                startBatchTest();
            }

            // è°ƒè¯•è„šæœ¬
            function debugScript() {
                addLog('ğŸ”§ å¼€å§‹è°ƒè¯•è„šæœ¬...');
                
                // æµ‹è¯•ä¸€ä¸ªåŸŸåæ¥æ£€æŸ¥è„šæœ¬æ˜¯å¦å·¥ä½œ
                const testDomain = 'itdog.cn';
                const url = `https://www.itdog.cn/http/?domain=${encodeURIComponent(testDomain)}`;
                
                addLog(`æ‰“å¼€æµ‹è¯•é¡µé¢: ${url}`);
                
                const testTab = window.open(url, '_blank');
                
                if (testTab) {
                    setTimeout(() => {
                        testTab.postMessage({ type: 'DEBUG_REQUEST' }, '*');
                        addLog('å·²å‘é€è°ƒè¯•è¯·æ±‚åˆ°æµ‹è¯•é¡µé¢');
                    }, 2000);
                } else {
                    addLog('âŒ æ— æ³•æ‰“å¼€è°ƒè¯•é¡µé¢');
                }
            }

            // è¿è¡Œè¯Šæ–­
            function runDiagnostic() {
                addLog('ğŸ” å¼€å§‹è¯Šæ–­...');
                
                const diagnosticItems = elements.diagnosticList.querySelectorAll('.diagnostic-item');
                
                // é‡ç½®è¯Šæ–­çŠ¶æ€
                diagnosticItems.forEach(item => {
                    const icon = item.querySelector('.diagnostic-icon');
                    icon.className = 'diagnostic-icon icon-info';
                    item.querySelector('.diagnostic-details').textContent = 'ç­‰å¾…æ£€æµ‹...';
                });
                
                // è¯Šæ–­æ­¥éª¤1: æ£€æŸ¥Tampermonkey
                setTimeout(() => {
                    checkTampermonkey();
                }, 500);
                
                // è¯Šæ–­æ­¥éª¤2: æ£€æŸ¥è„šæœ¬
                setTimeout(() => {
                    checkScript();
                }, 1500);
                
                // è¯Šæ–­æ­¥éª¤3: æ£€æŸ¥é…ç½®
                setTimeout(() => {
                    checkConfig();
                }, 2500);
                
                // è¯Šæ–­æ­¥éª¤4: æµ‹è¯•é€šä¿¡
                setTimeout(() => {
                    testCommunication();
                }, 3500);
            }

            function checkTampermonkey() {
                const item = diagnosticItems[0];
                const icon = item.querySelector('.diagnostic-icon');
                const details = item.querySelector('.diagnostic-details');
                
                if (typeof GM_info !== 'undefined') {
                    icon.className = 'diagnostic-icon icon-success';
                    details.textContent = `âœ… Tampermonkeyå·²å®‰è£… (v${GM_info.scriptHandler})`;
                    addLog('âœ… Tampermonkeyæ‰©å±•å·²å®‰è£…');
                } else {
                    icon.className = 'diagnostic-icon icon-error';
                    details.textContent = 'âŒ Tampermonkeyæœªå®‰è£…æˆ–æœªå¯ç”¨';
                    addLog('âŒ Tampermonkeyæ‰©å±•æœªæ£€æµ‹åˆ°');
                }
            }

            function checkScript() {
                const item = diagnosticItems[1];
                const icon = item.querySelector('.diagnostic-icon');
                const details = item.querySelector('.diagnostic-details');
                
                // å°è¯•æ£€æŸ¥è„šæœ¬æ˜¯å¦å·²å®‰è£…
                try {
                    // å‘é€æµ‹è¯•æ¶ˆæ¯
                    window.postMessage({ type: 'PING_SCRIPT' }, '*');
                    
                    setTimeout(() => {
                        icon.className = 'diagnostic-icon icon-warning';
                        details.textContent = 'âš ï¸ è„šæœ¬çŠ¶æ€æœªçŸ¥ï¼Œå°è¯•å®‰è£…è„šæœ¬';
                        addLog('âš ï¸ è„šæœ¬çŠ¶æ€æœªçŸ¥');
                        elements.fixScriptBtn.style.display = 'inline-block';
                    }, 1000);
                } catch (error) {
                    icon.className = 'diagnostic-icon icon-error';
                    details.textContent = 'âŒ è„šæœ¬æ£€æŸ¥å¤±è´¥';
                    addLog('âŒ è„šæœ¬æ£€æŸ¥å¤±è´¥: ' + error.message);
                }
            }

            function checkConfig() {
                const item = diagnosticItems[2];
                const icon = item.querySelector('.diagnostic-icon');
                const details = item.querySelector('.diagnostic-details');
                
                if (telegramConfig && telegramConfig.botToken && telegramConfig.chatId) {
                    icon.className = 'diagnostic-icon icon-success';
                    details.textContent = 'âœ… Telegramé…ç½®å®Œæ•´';
                    addLog('âœ… Telegramé…ç½®å®Œæ•´');
                } else {
                    icon.className = 'diagnostic-icon icon-warning';
                    details.textContent = 'âš ï¸ Telegramé…ç½®ä¸å®Œæ•´';
                    addLog('âš ï¸ Telegramé…ç½®ä¸å®Œæ•´');
                }
            }

            function testCommunication() {
                const item = diagnosticItems[3];
                const icon = item.querySelector('.diagnostic-icon');
                const details = item.querySelector('.diagnostic-details');
                
                // åˆ›å»ºä¸€ä¸ªiframeæ¥æµ‹è¯•æ¶ˆæ¯ä¼ é€’
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.src = 'about:blank';
                document.body.appendChild(iframe);
                
                try {
                    iframe.contentWindow.postMessage({ type: 'TEST_COMMUNICATION' }, '*');
                    icon.className = 'diagnostic-icon icon-success';
                    details.textContent = 'âœ… æ¶ˆæ¯é€šä¿¡æ­£å¸¸';
                    addLog('âœ… æ¶ˆæ¯é€šä¿¡æµ‹è¯•æ­£å¸¸');
                } catch (error) {
                    icon.className = 'diagnostic-icon icon-error';
                    details.textContent = 'âŒ æ¶ˆæ¯é€šä¿¡å¤±è´¥';
                    addLog('âŒ æ¶ˆæ¯é€šä¿¡æµ‹è¯•å¤±è´¥');
                } finally {
                    document.body.removeChild(iframe);
                }
            }

            // ä¿®å¤è„šæœ¬
            function fixScript() {
                addLog('ğŸ”§ å¼€å§‹ä¿®å¤è„šæœ¬...');
                elements.scriptSection.classList.remove('script-section-hidden');
                elements.scriptToggle.textContent = '[éšè—]';
                addLog('å·²æ˜¾ç¤ºè„šæœ¬ä»£ç ï¼Œè¯·é‡æ–°å¤åˆ¶å®‰è£…');
            }

            // å¯åŠ¨å®šæ—¶æµ‹è¯•
            function startSchedule() {
                const domains = elements.domains.value.trim();
                if (!domains) {
                    alert('è¯·å…ˆè®¾ç½®è¦æµ‹è¯•çš„ç½‘ç«™åˆ—è¡¨');
                    return;
                }
                
                if (scheduleRunning) {
                    alert('å®šæ—¶æµ‹è¯•å·²ç»åœ¨è¿è¡Œä¸­');
                    return;
                }
                
                if (!telegramConfig) {
                    alert('è¯·å…ˆé…ç½®Telegramä¿¡æ¯');
                    return;
                }
                
                // è·å–é€‰ä¸­çš„é—´éš”
                const activeBtn = document.querySelector('.schedule-btn.active');
                let minutes = activeBtn ? parseInt(activeBtn.dataset.minutes) : 60;
                
                // æ£€æŸ¥è‡ªå®šä¹‰è¾“å…¥
                const customInput = document.getElementById('custom-interval');
                if (customInput.value) {
                    minutes = parseInt(customInput.value) || minutes;
                }
                
                scheduleInterval = minutes * 60 * 1000;
                
                scheduleRunning = true;
                elements.startScheduleBtn.style.display = 'none';
                elements.stopScheduleBtn.style.display = 'flex';
                document.querySelector('.timer-status').style.display = 'block';
                
                // ä¿å­˜å®šæ—¶é…ç½®
                saveScheduleConfig();
                
                addLog(`ğŸš€ å¯åŠ¨å®šæ—¶æµ‹è¯•ï¼Œæ¯ ${minutes} åˆ†é’Ÿæµ‹è¯•ä¸€æ¬¡`);
                
                // ç«‹å³æ‰§è¡Œä¸€æ¬¡æµ‹è¯•
                startBatchTest();
                
                // è®¾ç½®å®šæ—¶å™¨
                scheduleTimer = setInterval(() => {
                    if (scheduleRunning) {
                        testCycleCount++;
                        addLog(`â° å®šæ—¶æ—¶é—´åˆ°ï¼Œå¼€å§‹ç¬¬ ${testCycleCount + 1} æ¬¡æµ‹è¯•`);
                        startBatchTest();
                        updateScheduleStatus();
                        saveScheduleConfig();
                    }
                }, scheduleInterval);
                
                updateScheduleStatus();
            }

            // åœæ­¢å®šæ—¶æµ‹è¯•
            function stopSchedule() {
                if (!scheduleRunning) return;
                
                scheduleRunning = false;
                
                if (scheduleTimer) {
                    clearInterval(scheduleTimer);
                    scheduleTimer = null;
                }
                
                elements.startScheduleBtn.style.display = 'flex';
                elements.stopScheduleBtn.style.display = 'none';
                
                addLog('å®šæ—¶æµ‹è¯•å·²åœæ­¢');
                
                // åœæ­¢å½“å‰æ­£åœ¨è¿›è¡Œçš„æµ‹è¯•
                if (isTesting) {
                    stopTest();
                }
                
                // ä¿å­˜é…ç½®
                saveScheduleConfig();
            }

            // æ›´æ–°å®šæ—¶çŠ¶æ€
            function updateScheduleStatus() {
                if (!scheduleRunning) return;
                
                elements.scheduleStatus.textContent = 'è¿è¡Œä¸­';
                elements.testCount.textContent = testCycleCount + 1;
                
                // è®¡ç®—ä¸‹æ¬¡æµ‹è¯•æ—¶é—´
                const nextTime = new Date(Date.now() + scheduleInterval);
                elements.nextTestTime.textContent = nextTime.toLocaleTimeString('zh-CN', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: false 
                });
            }

            // ä¿å­˜å®šæ—¶é…ç½®
            function saveScheduleConfig() {
                const scheduleConfig = {
                    interval: scheduleInterval,
                    cycleCount: testCycleCount,
                    running: scheduleRunning,
                    lastUpdated: new Date().toISOString()
                };
                localStorage.setItem('schedule_config', JSON.stringify(scheduleConfig));
            }

            // å¤åˆ¶è„šæœ¬
            function copyScript() {
                elements.scriptSection.classList.remove('script-section-hidden');
                elements.scriptToggle.textContent = '[éšè—]';
                
                const githubPagesUrl = window.location.origin + window.location.pathname;
                let scriptText = elements.scriptCode.textContent;
                
                navigator.clipboard.writeText(scriptText)
                    .then(() => {
                        const originalText = elements.copyScriptBtn.innerHTML;
                        elements.copyScriptBtn.innerHTML = '<i class="fas fa-check"></i> å·²å¤åˆ¶åˆ°å‰ªè´´æ¿';
                        elements.copyScriptBtn.style.background = '#2ecc71';
                        
                        setTimeout(() => {
                            elements.copyScriptBtn.innerHTML = originalText;
                            elements.copyScriptBtn.style.background = '';
                        }, 2000);
                        
                        showStatus('è„šæœ¬å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œè¯·åœ¨Tampermonkeyä¸­å®‰è£…', 'success');
                        addLog('âœ… è„šæœ¬å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                    })
                    .catch(err => {
                        showStatus('å¤åˆ¶å¤±è´¥: ' + err.message, 'error');
                        addLog('âŒ å¤åˆ¶è„šæœ¬å¤±è´¥: ' + err.message);
                    });
            }

            // ä¸€é”®å®‰è£…è„šæœ¬
            function installScript() {
                const scriptText = elements.scriptCode.textContent;
                
                // åˆ›å»ºBlobå¹¶ä¸‹è½½
                const blob = new Blob([scriptText], { type: 'text/javascript' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = 'itdog-monitor.user.js';
                a.click();
                
                URL.revokeObjectURL(url);
                
                showStatus('è„šæœ¬æ–‡ä»¶å·²ä¸‹è½½ï¼Œè¯·åœ¨Tampermonkeyä¸­å¯¼å…¥', 'success');
                addLog('âœ… è„šæœ¬æ–‡ä»¶å·²ä¸‹è½½');
            }

            // åˆ‡æ¢è„šæœ¬æ˜¾ç¤º
            function toggleScript() {
                if (elements.scriptSection.classList.contains('script-section-hidden')) {
                    elements.scriptSection.classList.remove('script-section-hidden');
                    elements.scriptToggle.textContent = '[éšè—]';
                } else {
                    elements.scriptSection.classList.add('script-section-hidden');
                    elements.scriptToggle.textContent = '[æ˜¾ç¤º]';
                }
            }

            // ç›‘å¬æ¥è‡ªTampermonkeyè„šæœ¬çš„æ¶ˆæ¯
            window.addEventListener('message', function(event) {
                console.log('æ”¶åˆ°æ¶ˆæ¯:', event.data);
                
                // å¤„ç†é…ç½®è¯·æ±‚
                if (event.data.type === 'REQUEST_TELEGRAM_CONFIG') {
                    if (telegramConfig) {
                        event.source.postMessage({
                            type: 'TELEGRAM_CONFIG',
                            config: telegramConfig
                        }, event.origin);
                        addLog('å‘é€Telegramé…ç½®ç»™è„šæœ¬');
                    }
                    return;
                }
                
                // å¤„ç†æµ‹è¯•ç»“æœ
                if (event.data.type === 'ITDOG_TEST_RESULT') {
                    const { domain, rate, data, timestamp } = event.data;
                    
                    const time = new Date(timestamp).toLocaleTimeString();
                    
                    // æŸ¥æ‰¾åŸŸåç´¢å¼•
                    const domainIndex = domainArray.findIndex(d => d.includes(domain.replace(/^https?:\/\//, '')));
                    
                    if (domainIndex !== -1) {
                        const statusElement = document.getElementById(`status-${domainIndex}`);
                        if (statusElement) {
                            // æ ¹æ®è¿é€šç‡è®¾ç½®çŠ¶æ€
                            if (rate < 90) {
                                statusElement.textContent = 'è¿é€šç‡ä½';
                                statusElement.className = 'domain-status status-warning';
                                addLog(`âš ï¸ ${domain} - è¿é€šç‡: ${rate}% (ä½äº90%)`);
                            } else {
                                statusElement.textContent = 'æµ‹è¯•å®Œæˆ';
                                statusElement.className = 'domain-status status-success';
                                addLog(`âœ… ${domain} - è¿é€šç‡: ${rate}%`);
                            }
                        }
                    }
                }
                
                // å¤„ç†è°ƒè¯•è¯·æ±‚
                if (event.data.type === 'DEBUG_REQUEST') {
                    addLog('æ”¶åˆ°è°ƒè¯•è¯·æ±‚ï¼Œè„šæœ¬è¿è¡Œæ­£å¸¸');
                }
            });

            // äº‹ä»¶ç›‘å¬
            elements.saveConfigBtn.addEventListener('click', saveConfig);
            elements.testConfigBtn.addEventListener('click', testConfig);
            elements.getChatIdBtn.addEventListener('click', getChatId);
            elements.clearConfigBtn.addEventListener('click', clearConfig);
            elements.startTestBtn.addEventListener('click', startBatchTest);
            elements.clearDomainsBtn.addEventListener('click', () => {
                elements.domains.value = '';
            });
            elements.manualTestBtn.addEventListener('click', manualTest);
            elements.debugScriptBtn.addEventListener('click', debugScript);
            elements.pauseBtn.addEventListener('click', pauseTest);
            elements.stopBtn.addEventListener('click', stopTest);
            elements.copyScriptBtn.addEventListener('click', copyScript);
            elements.installScriptBtn.addEventListener('click', installScript);
            elements.scriptToggle.addEventListener('click', toggleScript);
            elements.viewScriptBtn.addEventListener('click', () => {
                elements.scriptSection.classList.remove('script-section-hidden');
                elements.scriptToggle.textContent = '[éšè—]';
            });
            elements.startScheduleBtn.addEventListener('click', startSchedule);
            elements.stopScheduleBtn.addEventListener('click', stopSchedule);
            elements.runDiagnosticBtn.addEventListener('click', runDiagnostic);
            elements.fixScriptBtn.addEventListener('click', fixScript);

            // å®šæ—¶é¢‘ç‡é€‰æ‹©
            document.querySelectorAll('.schedule-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.schedule-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                });
            });

            // åˆå§‹åŒ–
            loadConfig();
            
            // è®¾ç½®ç¤ºä¾‹åŸŸå
            elements.domains.value = `https://www.alibabacloud.com
www.dynadot.com
itdog.cn
godaddy.com
github.com
google.com`;
            
            // åˆå§‹è¿è¡Œè¯Šæ–­
            setTimeout(runDiagnostic, 1000);
            
            console.log('GitHub Pagesé…ç½®ä¸­å¿ƒå·²åŠ è½½ - å®Œæ•´åŠŸèƒ½ç‰ˆ');
        });
    </script>
</body>
</html>
