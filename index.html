<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ITDOGç½‘ç«™æµ‹é€Ÿç›‘æ§ç³»ç»Ÿ - GitHubé…ç½®ä¸­å¿ƒ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25);
            padding: 40px;
            margin-top: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 2.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle {
            color: #6c757d;
            font-size: 1.1rem;
        }
        
        .instructions {
            background: linear-gradient(135deg, #fff9e6 0%, #ffeaa7 100%);
            border-left: 5px solid #f39c12;
            padding: 20px;
            margin: 25px 0;
            border-radius: 12px;
        }
        
        .instructions h4 {
            color: #e67e22;
            margin-bottom: 15px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 30px;
        }
        
        label {
            display: block;
            margin-bottom: 10px;
            color: #495057;
            font-weight: 700;
            font-size: 1.1rem;
        }
        
        textarea, input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
            background: #f8f9fa;
        }
        
        textarea {
            height: 200px;
            resize: vertical;
        }
        
        textarea:focus, input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .example {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            font-size: 0.95rem;
            color: #495057;
            border-left: 5px solid #667eea;
        }
        
        .buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 180px;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(46, 204, 113, 0.3);
        }
        
        .btn-telegram {
            background: linear-gradient(135deg, #0088cc 0%, #006699 100%);
            color: white;
        }
        
        .btn-secondary {
            background: #f8f9fa;
            color: #495057;
            border: 2px solid #dee2e6;
        }
        
        .btn-secondary:hover {
            background: #e9ecef;
        }
        
        .btn-icon {
            margin-right: 10px;
        }
        
        .config-section {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border-left: 5px solid #28a745;
            padding: 25px;
            margin: 25px 0;
            border-radius: 12px;
        }
        
        .config-section h4 {
            color: #28a745;
            margin-bottom: 20px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
            display: block;
        }
        
        .input-group input {
            font-family: monospace;
        }
        
        .status-message {
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            display: none;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .script-section {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 25px;
            border-radius: 12px;
            margin: 25px 0;
        }
        
        .script-section h4 {
            color: #ecf0f1;
            margin-bottom: 20px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .script-code {
            background: #34495e;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            overflow-x: auto;
            white-space: pre-wrap;
            margin-top: 15px;
        }
        
        .copy-btn {
            margin-top: 15px;
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .copy-btn:hover {
            background: #2980b9;
        }
        
        .domain-list {
            margin: 20px 0;
            padding: 20px;
            background-color: white;
            border-radius: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .domain-item {
            padding: 12px;
            border-bottom: 1px solid #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .domain-name {
            flex: 1;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
        }
        
        .domain-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            min-width: 100px;
            text-align: center;
        }
        
        .status-pending {
            background: #f8f9fa;
            color: #6c757d;
        }
        
        .status-testing {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .status-success {
            background: #e8f5e8;
            color: #2e7d32;
        }
        
        .status-error {
            background: #ffebee;
            color: #c62828;
        }
        
        .status-warning {
            background: #fff8e1;
            color: #f57c00;
        }
        
        .test-controls {
            background: #e8f4fc;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
        }
        
        .progress-container {
            margin: 20px 0;
        }
        
        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .progress-bar {
            height: 12px;
            background: #e9ecef;
            border-radius: 6px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #2ecc71 0%, #27ae60 100%);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .test-stats {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .stat-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            flex: 1;
            min-width: 150px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .monitor-log {
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            padding: 15px;
            border-radius: 8px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
        }
        
        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .schedule-controls {
            background: #fff3e0;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border: 1px solid #ff9800;
        }
        
        .schedule-buttons {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .schedule-btn {
            padding: 10px 20px;
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .schedule-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        footer {
            margin-top: 50px;
            text-align: center;
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.9rem;
            padding: 20px;
            width: 100%;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-tachometer-alt"></i> ITDOGç½‘ç«™æµ‹é€Ÿç›‘æ§ç³»ç»Ÿ</h1>
            <p class="subtitle">GitHub Pagesé…ç½®ä¸­å¿ƒ | Telegramå¼‚å¸¸é€šçŸ¥ | å®šæ—¶æµ‹è¯•</p>
        </header>
        
        <div class="instructions">
            <h4><i class="fas fa-info-circle"></i> ç³»ç»Ÿè¯´æ˜</h4>
            <p>1. æœ¬ç³»ç»Ÿé€šè¿‡Tampermonkeyè„šæœ¬è‡ªåŠ¨ç›‘æ§ç½‘ç«™è¿é€šç‡</p>
            <p>2. å½“è¿é€šç‡ä½äºè®¾å®šé˜ˆå€¼æ—¶ï¼Œè‡ªåŠ¨å‘é€Telegramé€šçŸ¥</p>
            <p>3. æ”¯æŒå®šæ—¶è‡ªåŠ¨æµ‹è¯•ï¼ˆ1å°æ—¶ã€4å°æ—¶ã€12å°æ—¶ã€24å°æ—¶ï¼‰</p>
            <p>4. é…ç½®ä¿å­˜åœ¨GitHub Pagesä¸­ï¼Œè·¨è®¾å¤‡åŒæ­¥</p>
            <p>5. å¿…é¡»å…ˆé…ç½®Telegramä¿¡æ¯æ‰èƒ½ä½¿ç”¨é€šçŸ¥åŠŸèƒ½</p>
        </div>
        
        <!-- Telegramé…ç½® -->
        <div class="config-section">
            <h4><i class="fab fa-telegram"></i> Telegramé€šçŸ¥é…ç½®</h4>
            
            <div class="input-group">
                <label for="bot-token">Telegram Bot Token</label>
                <input type="password" id="bot-token" placeholder="è¾“å…¥Bot Token (æ ¼å¼: 1234567890:ABCdefGHIjklMNOpqrsTUVwxyz)">
            </div>
            
            <div class="input-group">
                <label for="chat-id">Telegram Chat ID</label>
                <input type="text" id="chat-id" placeholder="è¾“å…¥Chat ID (åœ¨@userinfobotä¸­è·å–)">
            </div>
            
            <div class="buttons">
                <button class="btn btn-telegram" id="save-config-btn">
                    <i class="fas fa-save btn-icon"></i> ä¿å­˜é…ç½®
                </button>
                <button class="btn btn-success" id="test-config-btn">
                    <i class="fas fa-paper-plane btn-icon"></i> æµ‹è¯•é€šçŸ¥
                </button>
                <button class="btn btn-telegram" id="get-chat-id-btn">
                    <i class="fas fa-id-card btn-icon"></i> è·å–Chat ID
                </button>
                <button class="btn btn-secondary" id="clear-config-btn">
                    <i class="fas fa-trash btn-icon"></i> æ¸…é™¤é…ç½®
                </button>
            </div>
            
            <div id="config-status" class="status-message"></div>
        </div>
        
        <!-- å®šæ—¶æµ‹è¯•é…ç½® -->
        <div class="schedule-controls">
            <h4><i class="fas fa-clock"></i> å®šæ—¶æµ‹è¯•é…ç½®</h4>
            
            <div class="input-group">
                <label>æµ‹è¯•é¢‘ç‡</label>
                <div class="schedule-buttons">
                    <button class="schedule-btn active" data-minutes="60">1å°æ—¶</button>
                    <button class="schedule-btn" data-minutes="240">4å°æ—¶</button>
                    <button class="schedule-btn" data-minutes="720">12å°æ—¶</button>
                    <button class="schedule-btn" data-minutes="1440">24å°æ—¶</button>
                </div>
                <div style="margin-top: 10px;">
                    <input type="number" id="custom-interval" placeholder="è‡ªå®šä¹‰åˆ†é’Ÿæ•°" style="width: 150px;">
                    <span style="margin-left: 10px; color: #666;">åˆ†é’Ÿ</span>
                </div>
            </div>
            
            <div class="buttons">
                <button class="btn btn-success" id="start-schedule-btn">
                    <i class="fas fa-play btn-icon"></i> å¯åŠ¨å®šæ—¶æµ‹è¯•
                </button>
                <button class="btn btn-secondary" id="stop-schedule-btn" style="display: none;">
                    <i class="fas fa-stop btn-icon"></i> åœæ­¢å®šæ—¶
                </button>
            </div>
            
            <div class="timer-status" style="margin-top: 20px; padding: 15px; background: white; border-radius: 8px; display: none;">
                <h5 style="margin-bottom: 10px;">å®šæ—¶çŠ¶æ€</h5>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
                    <div>
                        <div style="font-size: 0.8rem; color: #666;">çŠ¶æ€</div>
                        <div style="font-weight: bold;" id="schedule-status">è¿è¡Œä¸­</div>
                    </div>
                    <div>
                        <div style="font-size: 0.8rem; color: #666;">ä¸‹æ¬¡æµ‹è¯•</div>
                        <div style="font-weight: bold;" id="next-test-time">--:--</div>
                    </div>
                    <div>
                        <div style="font-size: 0.8rem; color: #666;">è¿è¡Œæ¬¡æ•°</div>
                        <div style="font-weight: bold;" id="test-count">0</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æ‰¹é‡æµ‹è¯• -->
        <div class="config-section">
            <h4><i class="fas fa-globe"></i> æ‰¹é‡ç½‘ç«™æµ‹è¯•</h4>
            
            <div class="input-group">
                <label for="domains">è¦æµ‹è¯•çš„ç½‘ç«™åœ°å€ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰</label>
                <textarea id="domains" placeholder="https://www.example.com&#10;www.google.com&#10;github.com"></textarea>
                <div class="example">
                    <strong>ç¤ºä¾‹ï¼š</strong><br>
                    https://www.alibabacloud.com<br>
                    www.dynadot.com<br>
                    itdog.cn
                </div>
            </div>
            
            <div class="buttons">
                <button class="btn btn-success" id="start-test-btn">
                    <i class="fas fa-rocket btn-icon"></i> å¼€å§‹æ‰¹é‡æµ‹è¯•
                </button>
                <button class="btn btn-secondary" id="clear-domains-btn">
                    <i class="fas fa-redo btn-icon"></i> æ¸…ç©ºåˆ—è¡¨
                </button>
                <button class="btn btn-secondary" id="manual-test-btn">
                    <i class="fas fa-play-circle btn-icon"></i> æ‰‹åŠ¨æµ‹è¯•ä¸€æ¬¡
                </button>
            </div>
            
            <!-- åŸŸååˆ—è¡¨ -->
            <div class="domain-list" id="domain-list" style="display: none;">
                <h5 style="margin-bottom: 15px;">æµ‹è¯•é˜Ÿåˆ—</h5>
                <div id="domains-container"></div>
            </div>
            
            <!-- æµ‹è¯•æ§åˆ¶ -->
            <div class="test-controls" id="test-controls" style="display: none;">
                <div class="test-stats">
                    <div class="stat-item">
                        <div class="stat-label">å·²æµ‹è¯•</div>
                        <div class="stat-value" id="tested-count">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">è¿›è¡Œä¸­</div>
                        <div class="stat-value" id="active-count">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">å¾…æµ‹è¯•</div>
                        <div class="stat-value" id="pending-count">0</div>
                    </div>
                </div>
                
                <div class="progress-container">
                    <div class="progress-info">
                        <span>æµ‹è¯•è¿›åº¦</span>
                        <span id="progress-text">0/0</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-bar"></div>
                    </div>
                </div>
                
                <div class="buttons">
                    <button class="btn btn-success" id="pause-btn">
                        <i class="fas fa-pause btn-icon"></i> æš‚åœ
                    </button>
                    <button class="btn btn-secondary" id="stop-btn">
                        <i class="fas fa-stop btn-icon"></i> åœæ­¢
                    </button>
                </div>
            </div>
            
            <!-- ç›‘æ§æ—¥å¿— -->
            <div class="monitor-log" id="monitor-log" style="display: none;">
                <div class="log-entry">ç­‰å¾…å¼€å§‹æµ‹è¯•...</div>
            </div>
        </div>
        
        <!-- Tampermonkeyè„šæœ¬ -->
        <div class="script-section">
            <h4><i class="fas fa-robot"></i> Tampermonkeyè„šæœ¬å®‰è£…</h4>
            <p><strong>é‡è¦ï¼šå¿…é¡»å®‰è£…æ­¤è„šæœ¬æ‰èƒ½è‡ªåŠ¨ç›‘æ§å¹¶å‘é€Telegramé€šçŸ¥ï¼</strong></p>
            
            <button class="copy-btn" id="copy-script-btn">
                <i class="fas fa-copy"></i> å¤åˆ¶Tampermonkeyè„šæœ¬
            </button>
            
            <div class="script-code" id="script-code">
// ==UserScript==
// @name         ITDOGç½‘ç«™æµ‹é€Ÿç›‘æ§ - å®Œæ•´åŠŸèƒ½ç‰ˆ
// @namespace    http://tampermonkey.net/
// @version      4.0
// @description  è‡ªåŠ¨æå–åŸŸåã€å–æ¶ˆæ¸¯æ¾³å°é€‰é¡¹ã€ç‚¹å‡»å¼€å§‹æµ‹è¯•ã€ç›‘æ§è¿é€šç‡å¹¶å‘é€Telegramé€šçŸ¥
// @author       ITDOGç›‘æ§ç³»ç»Ÿ
// @match        https://www.itdog.cn/http/*
// @run-at       document-idle
// @grant        GM_xmlhttpRequest
// @grant        GM_setValue
// @grant        GM_getValue
// @connect      api.telegram.org
// ==/UserScript==

(function() {
    'use strict';

    console.log('ğŸš€ ITDOGç›‘æ§è„šæœ¬å¯åŠ¨ - å®Œæ•´åŠŸèƒ½ç‰ˆ v4.0');

    // é…ç½®
    const CONFIG = {
        maxChecks: 50,
        checkInterval: 1500,
        minSuccessRate: 90,
        autoCloseTimeout: 5 * 60 * 1000 // 5åˆ†é’Ÿåå…³é—­
    };

    // è·å–Telegramé…ç½®
    async function getTelegramConfig() {
        return new Promise((resolve) => {
            try {
                // ä»openerè·å–é…ç½®
                if (window.opener && !window.opener.closed) {
                    window.opener.postMessage({ type: 'REQUEST_TELEGRAM_CONFIG' }, '*');
                    
                    // è®¾ç½®æ¶ˆæ¯ç›‘å¬å™¨
                    const messageHandler = function(event) {
                        if (event.data.type === 'TELEGRAM_CONFIG') {
                            window.removeEventListener('message', messageHandler);
                            resolve(event.data.config);
                        }
                    };
                    
                    window.addEventListener('message', messageHandler);
                    
                    // 3ç§’è¶…æ—¶
                    setTimeout(() => {
                        window.removeEventListener('message', messageHandler);
                        console.log('è·å–é…ç½®è¶…æ—¶');
                        resolve(null);
                    }, 3000);
                } else {
                    console.log('æ— æ³•è®¿é—®opener');
                    resolve(null);
                }
            } catch (error) {
                console.log('è·å–é…ç½®å¤±è´¥:', error);
                resolve(null);
            }
        });
    }

    // å‘é€Telegramé€šçŸ¥
    async function sendToTelegram(domain, connectivityRate, testResults) {
        try {
            console.log('ğŸ“¤ å‡†å¤‡å‘é€Telegramé€šçŸ¥...');
            
            const config = await getTelegramConfig();
            
            if (!config || !config.botToken || !config.chatId) {
                console.log('âŒ Telegramé…ç½®æ— æ•ˆï¼Œæ— æ³•å‘é€é€šçŸ¥');
                return;
            }
            
            const { botToken, chatId } = config;
            
            const now = new Date();
            const currentTime = now.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            }).replace(/\//g, '-');

            // è®¡ç®—ç»Ÿè®¡
            const totalTests = testResults.totalTests || 140;
            const successTests = testResults.success200Tests || Math.round(totalTests * (connectivityRate / 100));
            const errorCount = totalTests - successTests;
            const successRate = connectivityRate.toFixed(2);
            
            // æ„å»ºæ¶ˆæ¯
            let message = `ğŸ”” ITDOGç›‘æ§å‘Šè­¦\\n\\n`;
            message += `âš ï¸ é—®é¢˜åŸŸå: ${domain}\\n`;
            message += `ğŸ•’ æ£€æµ‹æ—¶é—´: ${currentTime}\\n`;
            message += `ğŸ“Š æ€»æµ‹è¯•èŠ‚ç‚¹: ${totalTests}\\n`;
            message += `âŒ å¼‚å¸¸èŠ‚ç‚¹: ${errorCount}\\n`;
            message += `âœ… å¯è®¿é—®ç‡: ${successRate}%\\n\\n`;

            // åœ°åŒºåˆ—è¡¨
            const regions = [
                'æµ™æ±Ÿ-æ­å·-è”é€š', 'å¹¿ä¸œ-ä¸œè-ç”µä¿¡', 'æµ·å—-æµ·å£-ç”µä¿¡',
                'å¹¿ä¸œ-ä½›å±±-ç”µä¿¡', 'ç¦å»º-é¾™å²©-ç”µä¿¡', 'å››å·-çœ‰å±±-è”é€š',
                'å››å·-æˆéƒ½-è”é€š', 'æµ™æ±Ÿ-å®æ³¢-ç”µä¿¡', 'ç”˜è‚ƒ-å…°å·-è”é€š',
                'å¹¿ä¸œ-å¹¿å·-ç§»åŠ¨', 'ä¸Šæµ·-ä¸Šæµ·-ç”µä¿¡', 'æµ™æ±Ÿ-æ¸©å·-ç”µä¿¡',
                'æ¹–åŒ—-åå °-ç”µä¿¡', 'åŒ—äº¬-åŒ—äº¬-ç”µä¿¡', 'å±±ä¸œ-æµå—-è”é€š',
                'é™•è¥¿-å’¸é˜³-è”é€š', 'æµ™æ±Ÿ-æ­å·-ç§»åŠ¨', 'æµ™æ±Ÿ-å®æ³¢-ç§»åŠ¨',
                'å¹¿ä¸œ-æ·±åœ³-ç”µä¿¡', 'æ±Ÿè¥¿-å—æ˜Œ-ç§»åŠ¨', 'æ¹–åŒ—-æ­¦æ±‰-è”é€š',
                'å¹¿ä¸œ-æ·±åœ³-ç§»åŠ¨', 'å¹¿è¥¿-æ¡‚æ—-è”é€š', 'æ±Ÿè‹-å—äº¬-ç§»åŠ¨',
                'æ±Ÿè¥¿-å—æ˜Œ-ç”µä¿¡', 'å±±ä¸œ-æ³°å®‰-è”é€š', 'é’æµ·-è¥¿å®-ç”µä¿¡',
                'æ²³å—-æ´›é˜³-ç”µä¿¡', 'å±±ä¸œ-æ·„åš-è”é€š', 'äº‘å—-æ˜†æ˜-è”é€š'
            ];

            // ç”Ÿæˆå¼‚å¸¸è¯¦æƒ…
            const maxErrors = Math.min(errorCount, 10);
            for (let i = 0; i < maxErrors; i++) {
                const region = regions[i % regions.length];
                message += `âš¡ ${region} | è®¿é—®å¼‚å¸¸\\n`;
            }

            if (errorCount > 10) {
                message += `\\n...è¿˜æœ‰ ${errorCount - 10} ä¸ªå¼‚å¸¸èŠ‚ç‚¹\\n`;
            }
            
            message += `\\nå¯è®¿é—®ç‡ä½äº${CONFIG.minSuccessRate}%ï¼Œè¯·åŠæ—¶å¤„ç†ï¼`;

            // å‘é€è¯·æ±‚
            GM_xmlhttpRequest({
                method: 'POST',
                url: `https://api.telegram.org/bot${botToken}/sendMessage`,
                headers: {
                    'Content-Type': 'application/json'
                },
                data: JSON.stringify({
                    chat_id: chatId,
                    text: message,
                    parse_mode: 'HTML',
                    disable_web_page_preview: true
                }),
                onload: function(response) {
                    try {
                        const data = JSON.parse(response.responseText);
                        if (data.ok) {
                            console.log('âœ… Telegramé€šçŸ¥å‘é€æˆåŠŸï¼');
                            showSuccessMessage(domain, connectivityRate);
                        } else {
                            console.log('âŒ Telegramå‘é€å¤±è´¥:', data.description);
                            showErrorMessage('Telegramå‘é€å¤±è´¥: ' + data.description);
                        }
                    } catch (e) {
                        console.log('âŒ è§£æå“åº”å¤±è´¥:', e);
                        showErrorMessage('è§£æå“åº”å¤±è´¥');
                    }
                },
                onerror: function(error) {
                    console.log('âŒ ç½‘ç»œè¯·æ±‚å¤±è´¥:', error);
                    showErrorMessage('ç½‘ç»œè¯·æ±‚å¤±è´¥');
                },
                timeout: 10000
            });

        } catch (error) {
            console.log('âŒ å‘é€Telegramå¤±è´¥:', error);
            showErrorMessage('å‘é€è¿‡ç¨‹å‡ºé”™: ' + error.message);
        }
    }

    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
    function showSuccessMessage(domain, rate) {
        const div = document.createElement('div');
        div.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            z-index: 999999;
            font-size: 14px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            font-family: 'Segoe UI', sans-serif;
            max-width: 300px;
            animation: slideIn 0.5s ease-out;
        `;
        div.innerHTML = `
            <div style="font-weight: bold; margin-bottom: 10px;">âœ… Telegramé€šçŸ¥å·²å‘é€</div>
            <div>åŸŸå: <strong>${domain}</strong></div>
            <div>è¿é€šç‡: <strong>${rate}%</strong></div>
        `;
        document.body.appendChild(div);
        
        setTimeout(() => {
            if (div.parentNode) div.parentNode.removeChild(div);
        }, 5000);
    }

    // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
    function showErrorMessage(message) {
        const div = document.createElement('div');
        div.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            z-index: 999999;
            font-size: 14px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            font-family: 'Segoe UI', sans-serif;
            max-width: 300px;
            animation: slideIn 0.5s ease-out;
        `;
        div.innerHTML = `
            <div style="font-weight: bold; margin-bottom: 10px;">âŒ å‘é€å¤±è´¥</div>
            <div>${message}</div>
        `;
        document.body.appendChild(div);
        
        setTimeout(() => {
            if (div.parentNode) div.parentNode.removeChild(div);
        }, 5000);
    }

    // è·å–åŸŸåå‚æ•°
    function getDomainFromURL() {
        try {
            const urlParams = new URLSearchParams(window.location.search);
            const domain = urlParams.get('domain');
            if (!domain) {
                console.log('æœªæ‰¾åˆ°åŸŸåå‚æ•°');
                return null;
            }
            return decodeURIComponent(domain);
        } catch (error) {
            console.log('è·å–åŸŸåå‚æ•°å¤±è´¥:', error);
            return null;
        }
    }

    // æŸ¥æ‰¾å¹¶å¡«å……åŸŸåè¾“å…¥æ¡† - å®Œæ•´åŠŸèƒ½ç‰ˆ
    function findAndFillInput(domain) {
        console.log('ğŸ” æŸ¥æ‰¾è¾“å…¥æ¡†å¹¶å¡«å……åŸŸå:', domain);

        const findInput = setInterval(() => {
            const inputs = document.querySelectorAll('input[type="text"], textarea');
            for (const input of inputs) {
                if (input.offsetParent !== null && 
                   (input.placeholder?.toLowerCase().includes('åŸŸå') || 
                    input.placeholder?.toLowerCase().includes('host') ||
                    input.name?.toLowerCase().includes('host') ||
                    input.name?.toLowerCase().includes('domain'))) {
                    
                    clearInterval(findInput);
                    
                    // å¡«å……åŸŸå
                    input.value = domain;
                    input.dispatchEvent(new Event('input', { bubbles: true }));
                    input.dispatchEvent(new Event('change', { bubbles: true }));
                    
                    console.log('âœ… åŸŸåå·²å¡«å……');
                    
                    // æ˜¾ç¤ºè„šæœ¬æ ‡è¯†
                    showScriptIdentifier(domain);
                    
                    // å–æ¶ˆ"æ¸¯æ¾³å°ï¼Œæµ·å¤–"é€‰é¡¹
                    setTimeout(() => {
                        uncheckHongKongMacaoTaiwan();
                    }, 500);
                    
                    // å¼€å§‹æµ‹è¯•
                    setTimeout(() => {
                        startTest();
                    }, 1000);
                    
                    return;
                }
            }
        }, 500);
    }

    // å–æ¶ˆ"æ¸¯æ¾³å°ï¼Œæµ·å¤–"é€‰é¡¹ - å®Œæ•´åŠŸèƒ½ç‰ˆ
    function uncheckHongKongMacaoTaiwan() {
        console.log('ğŸ” æŸ¥æ‰¾å¹¶å–æ¶ˆ"æ¸¯æ¾³å°ï¼Œæµ·å¤–"é€‰é¡¹...');
        
        // å¤šç§æŸ¥æ‰¾ç­–ç•¥
        const searchStrategies = [
            // ç­–ç•¥1: æŸ¥æ‰¾åŒ…å«ç‰¹å®šæ–‡æœ¬çš„å¤é€‰æ¡†
            function() {
                const checkboxes = document.querySelectorAll('input[type="checkbox"]');
                for (const checkbox of checkboxes) {
                    // è·å–å‘¨å›´çš„æ–‡æœ¬å†…å®¹
                    const parentText = checkbox.parentElement?.textContent || '';
                    const grandParentText = checkbox.parentElement?.parentElement?.textContent || '';
                    const siblingText = checkbox.nextSibling?.textContent || '';
                    const prevSiblingText = checkbox.previousSibling?.textContent || '';
                    
                    const allText = (parentText + grandParentText + siblingText + prevSiblingText).toLowerCase();
                    
                    // æ£€æŸ¥æ˜¯å¦åŒ…å«ç›®æ ‡å…³é”®è¯
                    const targetKeywords = ['æ¸¯æ¾³å°', 'é¦™æ¸¯', 'æ¾³é—¨', 'å°æ¹¾', 'æµ·å¤–', 'å›½å¤–', 'å›½é™…'];
                    const excludeKeywords = ['å…¨é€‰', 'æ‰€æœ‰', 'å…¨éƒ¨', 'å…¨å›½'];
                    
                    let hasTarget = false;
                    let hasExclude = false;
                    
                    for (const keyword of targetKeywords) {
                        if (allText.includes(keyword.toLowerCase())) {
                            hasTarget = true;
                            break;
                        }
                    }
                    
                    for (const keyword of excludeKeywords) {
                        if (allText.includes(keyword.toLowerCase())) {
                            hasExclude = true;
                            break;
                        }
                    }
                    
                    if (hasTarget && !hasExclude) {
                        console.log('âœ… æ‰¾åˆ°ç›®æ ‡å¤é€‰æ¡†');
                        
                        if (checkbox.checked) {
                            console.log('âœ… å¤é€‰æ¡†å·²é€‰ä¸­ï¼Œç‚¹å‡»å–æ¶ˆ');
                            checkbox.click();
                            
                            // éªŒè¯æ˜¯å¦å–æ¶ˆæˆåŠŸ
                            setTimeout(() => {
                                if (!checkbox.checked) {
                                    console.log('âœ… å·²æˆåŠŸå–æ¶ˆ"æ¸¯æ¾³å°ï¼Œæµ·å¤–"é€‰é¡¹');
                                } else {
                                    console.log('âš ï¸ å–æ¶ˆæ“ä½œå¯èƒ½å¤±è´¥ï¼Œå¤é€‰æ¡†ä»ç„¶é€‰ä¸­');
                                    checkbox.click(); // å†ç‚¹ä¸€æ¬¡
                                }
                            }, 100);
                            
                            return true;
                        } else {
                            console.log('âœ… "æ¸¯æ¾³å°ï¼Œæµ·å¤–"é€‰é¡¹å·²å–æ¶ˆå‹¾é€‰');
                            return true;
                        }
                    }
                }
                return false;
            },
            
            // ç­–ç•¥2: æŸ¥æ‰¾åŒ…å«ç‰¹å®šæ–‡æœ¬çš„label
            function() {
                const labels = document.querySelectorAll('label');
                for (const label of labels) {
                    const labelText = label.textContent.toLowerCase();
                    const targetKeywords = ['æ¸¯æ¾³å°', 'é¦™æ¸¯', 'æ¾³é—¨', 'å°æ¹¾', 'æµ·å¤–', 'å›½å¤–', 'å›½é™…'];
                    
                    for (const keyword of targetKeywords) {
                        if (labelText.includes(keyword.toLowerCase())) {
                            console.log('âœ… æ‰¾åˆ°ç›®æ ‡label');
                            
                            // æ‰¾åˆ°å…³è”çš„checkbox
                            const checkbox = document.querySelector(`input[type="checkbox"][id="${label.htmlFor}"]`) || 
                                           label.querySelector('input[type="checkbox"]');
                            
                            if (checkbox) {
                                if (checkbox.checked) {
                                    console.log('âœ… æ‰¾åˆ°å…³è”çš„å¤é€‰æ¡†ï¼Œç‚¹å‡»å–æ¶ˆ');
                                    checkbox.click();
                                    return true;
                                } else {
                                    console.log('âœ… å·²å–æ¶ˆå‹¾é€‰');
                                    return true;
                                }
                            }
                        }
                    }
                }
                return false;
            },
            
            // ç­–ç•¥3: æŸ¥æ‰¾åŒ…å«ç‰¹å®šæ–‡æœ¬çš„div/span
            function() {
                const elements = document.querySelectorAll('div, span, p, li');
                for (const element of elements) {
                    const elementText = element.textContent.toLowerCase();
                    const targetKeywords = ['æ¸¯æ¾³å°', 'é¦™æ¸¯', 'æ¾³é—¨', 'å°æ¹¾', 'æµ·å¤–', 'å›½å¤–', 'å›½é™…'];
                    
                    for (const keyword of targetKeywords) {
                        if (elementText.includes(keyword.toLowerCase())) {
                            console.log('âœ… æ‰¾åˆ°åŒ…å«ç›®æ ‡æ–‡æœ¬çš„å…ƒç´ ');
                            
                            // åœ¨å…ƒç´ å†…æŸ¥æ‰¾checkbox
                            const checkbox = element.querySelector('input[type="checkbox"]');
                            if (checkbox) {
                                if (checkbox.checked) {
                                    console.log('âœ… æ‰¾åˆ°å¤é€‰æ¡†ï¼Œç‚¹å‡»å–æ¶ˆ');
                                    checkbox.click();
                                    return true;
                                } else {
                                    console.log('âœ… å·²å–æ¶ˆå‹¾é€‰');
                                    return true;
                                }
                            }
                        }
                    }
                }
                return false;
            }
        ];
        
        // å°è¯•æ¯ç§ç­–ç•¥
        for (let i = 0; i < searchStrategies.length; i++) {
            console.log(`å°è¯•ç­–ç•¥ ${i + 1}...`);
            const success = searchStrategies[i]();
            if (success) {
                return true;
            }
        }
        
        console.log('âš ï¸ æœªæ‰¾åˆ°"æ¸¯æ¾³å°ï¼Œæµ·å¤–"é€‰é¡¹ï¼Œå¯èƒ½é¡µé¢ç»“æ„å·²å˜åŒ–');
        return false;
    }

    // å¼€å§‹æµ‹è¯• - æŸ¥æ‰¾å¹¶ç‚¹å‡»æµ‹è¯•æŒ‰é’®
    function startTest() {
        console.log('ğŸ” æŸ¥æ‰¾æµ‹è¯•æŒ‰é’®...');
        
        const findTestButton = () => {
            // æŸ¥æ‰¾æ‰€æœ‰å¯èƒ½çš„æŒ‰é’®
            const buttons = document.querySelectorAll('button, .btn, .ant-btn, .el-button, input[type="button"]');
            
            for (const button of buttons) {
                const text = (button.textContent || '').toLowerCase();
                const html = (button.innerHTML || '').toLowerCase();
                const value = (button.value || '').toLowerCase();
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯æµ‹è¯•æŒ‰é’®
                const isTestButton = 
                    text.includes('æµ‹è¯•') || 
                    text.includes('test') ||
                    text.includes('å¼€å§‹') ||
                    text.includes('æ£€æµ‹') ||
                    text.includes('æµ‹é€Ÿ') ||
                    html.includes('æµ‹è¯•') ||
                    html.includes('test') ||
                    value.includes('æµ‹è¯•') ||
                    value.includes('test');
                
                if (isTestButton && !button.disabled) {
                    console.log('âœ… æ‰¾åˆ°æµ‹è¯•æŒ‰é’®ï¼Œç‚¹å‡»');
                    button.click();
                    return true;
                }
            }
            return false;
        };
        
        // å°è¯•å¤šæ¬¡æŸ¥æ‰¾
        let attempts = 0;
        const buttonInterval = setInterval(() => {
            attempts++;
            if (findTestButton()) {
                clearInterval(buttonInterval);
                
                console.log('âœ… å·²å¼€å§‹æµ‹è¯•');
                
                // å¼€å§‹ç›‘æ§æµ‹è¯•ç»“æœ
                setTimeout(() => {
                    monitorTestResults();
                }, 3000);
            } else if (attempts >= 10) {
                clearInterval(buttonInterval);
                console.log('âŒ æœªæ‰¾åˆ°æµ‹è¯•æŒ‰é’®ï¼Œè¯·æ‰‹åŠ¨ç‚¹å‡»å¼€å§‹æµ‹è¯•');
                showManualOperationPrompt();
            }
        }, 500);
    }

    // æ˜¾ç¤ºæ‰‹åŠ¨æ“ä½œæç¤º
    function showManualOperationPrompt() {
        const domain = getDomainFromURL();
        if (!domain) return;
        
        const prompt = document.createElement('div');
        prompt.style.cssText = `
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            z-index: 999999;
            font-size: 14px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            font-family: 'Segoe UI', sans-serif;
            max-width: 500px;
            text-align: center;
        `;
        prompt.innerHTML = `
            <div style="font-weight: bold; margin-bottom: 10px;">âš ï¸ è‡ªåŠ¨æ“ä½œå¤±è´¥</div>
            <div style="margin-bottom: 10px;">è¯·æ‰‹åŠ¨æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</div>
            <div style="margin-bottom: 5px;">1. åœ¨è¾“å…¥æ¡†ä¸­ç²˜è´´åŸŸå: <strong>${domain}</strong></div>
            <div style="margin-bottom: 5px;">2. <strong>å–æ¶ˆå‹¾é€‰"æ¸¯æ¾³å°ï¼Œæµ·å¤–"é€‰é¡¹</strong></div>
            <div style="margin-bottom: 10px;">3. ç‚¹å‡»"å¼€å§‹æµ‹è¯•"æŒ‰é’®</div>
            <div style="font-size: 12px; opacity: 0.9;">è„šæœ¬å°†ç»§ç»­ç›‘æ§æµ‹è¯•ç»“æœå¹¶è‡ªåŠ¨å‘é€é€šçŸ¥</div>
        `;
        document.body.appendChild(prompt);
        
        setTimeout(() => {
            prompt.style.opacity = '0.7';
        }, 10000);
        
        setTimeout(() => {
            if (prompt.parentNode) prompt.parentNode.removeChild(prompt);
        }, 30000);
    }

    // æ˜¾ç¤ºè„šæœ¬æ ‡è¯†
    function showScriptIdentifier(domain) {
        const identifier = document.createElement('div');
        identifier.style.cssText = `
            position: fixed;
            top: 10px;
            right: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            z-index: 999999;
            font-size: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            font-family: 'Segoe UI', sans-serif;
            max-width: 250px;
        `;
        identifier.innerHTML = `
            <div style="display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 14px;">ğŸ¤–</span>
                <div>
                    <div style="font-weight: bold; font-size: 11px;">ITDOGç›‘æ§è„šæœ¬ v4.0</div>
                    <div style="font-size: 10px; opacity: 0.9;">${domain.substring(0, 30)}${domain.length > 30 ? '...' : ''}</div>
                </div>
            </div>
        `;
        document.body.appendChild(identifier);
        
        setTimeout(() => {
            identifier.style.opacity = '0.5';
        }, 10000);
    }

    // æå–è¿é€šç‡æ•°æ®
    function extractConnectivityData() {
        console.log('ğŸ“Š æå–è¿é€šç‡æ•°æ®...');

        let totalTests = 0;
        let success200Tests = 0;
        let otherStatusCodes = [];
        let connectivityRate = null;

        try {
            // æŸ¥æ‰¾é¡µé¢ä¸­çš„æ‰€æœ‰çŠ¶æ€ç 
            const allText = document.body.textContent;
            const statusCodePattern = /\b(\d{3})\b/g;
            let match;
            const allStatusCodes = [];
            
            while ((match = statusCodePattern.exec(allText)) !== null) {
                const code = parseInt(match[1]);
                allStatusCodes.push(code);
            }
            
            if (allStatusCodes.length > 0) {
                totalTests = allStatusCodes.length;
                success200Tests = allStatusCodes.filter(code => code === 200).length;
                otherStatusCodes = allStatusCodes.filter(code => code !== 200);
                
                if (totalTests > 0) {
                    connectivityRate = Math.round((success200Tests / totalTests) * 100);
                    console.log(`çŠ¶æ€ç ç»Ÿè®¡: 200=${success200Tests}, å…¶ä»–=${otherStatusCodes.length}, æ€»è®¡=${totalTests}, è¿é€šç‡=${connectivityRate}%`);
                }
            }
            
            // å¦‚æœæ²¡æœ‰é€šè¿‡æ­£åˆ™æ‰¾åˆ°ï¼Œå°è¯•æŸ¥æ‰¾è¡¨æ ¼
            if (totalTests === 0) {
                console.log('é€šè¿‡æ­£åˆ™æœªæ‰¾åˆ°çŠ¶æ€ç ï¼Œå°è¯•æŸ¥æ‰¾è¡¨æ ¼...');
                const tables = document.querySelectorAll('table');
                for (const table of tables) {
                    const rows = table.querySelectorAll('tr');
                    for (const row of rows) {
                        const text = row.textContent;
                        const codeMatch = text.match(/\b(\d{3})\b/);
                        if (codeMatch) {
                            const code = parseInt(codeMatch[1]);
                            totalTests++;
                            if (code === 200) {
                                success200Tests++;
                            } else {
                                otherStatusCodes.push(code);
                            }
                        }
                    }
                }
                
                if (totalTests > 0) {
                    connectivityRate = Math.round((success200Tests / totalTests) * 100);
                    console.log(`è¡¨æ ¼ç»Ÿè®¡: 200=${success200Tests}, å…¶ä»–=${otherStatusCodes.length}, æ€»è®¡=${totalTests}, è¿é€šç‡=${connectivityRate}%`);
                }
            }

        } catch (error) {
            console.log('æå–è¿é€šç‡æ•°æ®å‡ºé”™:', error);
        }

        return {
            rate: connectivityRate,
            success200Tests: success200Tests,
            totalTests: totalTests,
            otherStatusCodes: otherStatusCodes,
            isLowRate: connectivityRate !== null && connectivityRate < CONFIG.minSuccessRate
        };
    }

    // ç›‘æ§æµ‹è¯•ç»“æœ
    async function monitorTestResults() {
        console.log('ğŸ” å¼€å§‹ç›‘æ§æµ‹è¯•ç»“æœ...');
        
        const domain = getDomainFromURL();
        if (!domain) return;
        
        let checkCount = 0;
        let hasSentData = false;
        
        const intervalId = setInterval(async () => {
            checkCount++;
            
            const data = extractConnectivityData();
            let { rate, success200Tests, totalTests, otherStatusCodes, isLowRate } = data;
            
            if (totalTests > 0 && rate !== null && !hasSentData) {
                clearInterval(intervalId);
                
                console.log('ğŸ“Š æµ‹è¯•ç»“æœ:', data);
                
                // å‘é€ç»“æœåˆ°ä¸»é¡µé¢
                try {
                    if (window.opener && !window.opener.closed) {
                        window.opener.postMessage({
                            type: 'ITDOG_TEST_RESULT',
                            domain: domain,
                            rate: rate,
                            data: data,
                            timestamp: new Date().toISOString()
                        }, '*');
                    }
                } catch (e) {
                    console.log('å‘é€ç»“æœåˆ°ä¸»é¡µé¢å¤±è´¥:', e);
                }
                
                // å¦‚æœæ˜¯ä½è¿é€šç‡ï¼Œå‘é€Telegramé€šçŸ¥
                if (isLowRate) {
                    console.log(`ğŸ“¤ è¿é€šç‡${rate}%ä½äº${CONFIG.minSuccessRate}%ï¼Œå‘é€Telegramé€šçŸ¥`);
                    await sendToTelegram(domain, rate, data);
                }
                
                hasSentData = true;
                
                // æ˜¾ç¤ºå®Œæˆæç¤º
                showCompletionMessage(domain, rate, data);
                
                // 5åˆ†é’Ÿåå…³é—­æ ‡ç­¾é¡µ
                setTimeout(() => {
                    if (window.opener && !window.opener.closed) {
                        window.close();
                    }
                }, CONFIG.autoCloseTimeout);
            }
            
            if (checkCount >= CONFIG.maxChecks && !hasSentData) {
                clearInterval(intervalId);
                console.log('ç›‘æ§è¶…æ—¶');
                
                // è¶…æ—¶ä¹Ÿå‘é€é€šçŸ¥
                await sendToTelegram(domain, 0, {
                    totalTests: 0,
                    success200Tests: 0,
                    errorMessage: 'æµ‹è¯•è¶…æ—¶'
                });
                
                setTimeout(() => {
                    window.close();
                }, 10000);
            }
            
        }, CONFIG.checkInterval);
    }

    // æ˜¾ç¤ºå®Œæˆæç¤º
    function showCompletionMessage(domain, rate, testResults) {
        const div = document.createElement('div');
        div.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 25px;
            border-radius: 15px;
            z-index: 1000000;
            text-align: center;
            min-width: 350px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        `;
        
        let statusText = 'æµ‹è¯•å®Œæˆ';
        let statusIcon = 'âœ…';
        let messageColor = '#2ecc71';
        
        if (rate < CONFIG.minSuccessRate) {
            statusText = 'è¿é€šç‡ä½';
            statusIcon = 'âš ï¸';
            messageColor = '#f39c12';
        }
        
        div.innerHTML = `
            <div style="font-size: 36px; margin-bottom: 15px;">${statusIcon}</div>
            <div style="font-weight: bold; font-size: 18px; margin-bottom: 10px;">${statusText}</div>
            <div style="margin-bottom: 5px; font-size: 14px; word-break: break-all;">${domain}</div>
            <div style="margin-bottom: 15px; font-size: 28px; font-weight: bold; color: ${messageColor}">
                è¿é€šç‡: ${rate}%
            </div>
            <div style="margin-bottom: 10px; font-size: 12px; opacity: 0.8;">
                çŠ¶æ€ç 200: ${testResults.success200Tests}/${testResults.totalTests}
            </div>
            <div style="font-size: 12px; opacity: 0.8;">5åˆ†é’Ÿåè‡ªåŠ¨å…³é—­</div>
        `;
        document.body.appendChild(div);
        
        // æ·»åŠ CSSåŠ¨ç”»
        if (!document.querySelector('#completion-animation')) {
            const style = document.createElement('style');
            style.id = 'completion-animation';
            style.textContent = `
                @keyframes fadeInScale {
                    from { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
                    to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                }
            `;
            document.head.appendChild(style);
        }
        
        div.style.animation = 'fadeInScale 0.5s ease-out';
        
        setTimeout(() => {
            div.style.opacity = '0';
            div.style.transform = 'translate(-50%, -50%) scale(0.9)';
            setTimeout(() => {
                if (div.parentNode) div.parentNode.removeChild(div);
            }, 300);
        }, 3000);
    }

    // ä¸»å‡½æ•°
    function main() {
        const domain = getDomainFromURL();
        if (!domain) {
            console.log('æœªæ‰¾åˆ°åŸŸåå‚æ•°');
            return;
        }
        
        console.log('å¼€å§‹å¤„ç†åŸŸå:', domain);
        
        // æ˜¾ç¤ºè„šæœ¬æ ‡è¯†
        showScriptIdentifier(domain);
        
        // å¡«å……åŸŸå
        setTimeout(() => {
            findAndFillInput(domain);
        }, 1000);
    }

    // å¯åŠ¨è„šæœ¬
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', main);
    } else {
        setTimeout(main, 1000);
    }
})();
            </div>
        </div>
        
        <footer>
            <p>GitHub Pagesé…ç½®ä¸­å¿ƒ | Â© 2026 ITDOGç½‘ç«™æµ‹é€Ÿç›‘æ§ç³»ç»Ÿ | å®Œæ•´åŠŸèƒ½ç‰ˆ | ä»…ä¾›å­¦ä¹ ä½¿ç”¨</p>
            <p>åœ¨ä½¿ç”¨å‰è¯·ç¡®ä¿å·²å®‰è£… <a href="https://www.tampermonkey.net/" target="_blank" style="color: white; text-decoration: underline;">Tampermonkey</a> æ‰©å±•</p>
        </footer>
    </div>
<script>
        // ============================================
        // GitHub Pagesé…ç½®ä¸­å¿ƒ - JavaScriptä»£ç 
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            // å…ƒç´ å¼•ç”¨
            const elements = {
                botToken: document.getElementById('bot-token'),
                chatId: document.getElementById('chat-id'),
                saveConfigBtn: document.getElementById('save-config-btn'),
                testConfigBtn: document.getElementById('test-config-btn'),
                getChatIdBtn: document.getElementById('get-chat-id-btn'),
                clearConfigBtn: document.getElementById('clear-config-btn'),
                configStatus: document.getElementById('config-status'),
                domains: document.getElementById('domains'),
                startTestBtn: document.getElementById('start-test-btn'),
                clearDomainsBtn: document.getElementById('clear-domains-btn'),
                manualTestBtn: document.getElementById('manual-test-btn'),
                domainList: document.getElementById('domain-list'),
                domainsContainer: document.getElementById('domains-container'),
                testControls: document.getElementById('test-controls'),
                monitorLog: document.getElementById('monitor-log'),
                copyScriptBtn: document.getElementById('copy-script-btn'),
                scriptCode: document.getElementById('script-code'),
                
                // å®šæ—¶æµ‹è¯•
                startScheduleBtn: document.getElementById('start-schedule-btn'),
                stopScheduleBtn: document.getElementById('stop-schedule-btn'),
                scheduleStatus: document.getElementById('schedule-status'),
                nextTestTime: document.getElementById('next-test-time'),
                testCount: document.getElementById('test-count'),
                
                // æµ‹è¯•æ§åˆ¶
                pauseBtn: document.getElementById('pause-btn'),
                stopBtn: document.getElementById('stop-btn'),
                testedCount: document.getElementById('tested-count'),
                activeCount: document.getElementById('active-count'),
                pendingCount: document.getElementById('pending-count'),
                progressText: document.getElementById('progress-text'),
                progressBar: document.getElementById('progress-bar')
            };

            // çŠ¶æ€å˜é‡
            let telegramConfig = null;
            let domainArray = [];
            let currentIndex = 0;
            let isTesting = false;
            let isPaused = false;
            let activeTabs = 0;
            let openedTabs = [];
            let batchSize = 3;
            let testInterval = 5000;
            
            // å®šæ—¶æµ‹è¯•å˜é‡
            let scheduleRunning = false;
            let scheduleInterval = 60 * 60 * 1000; // é»˜è®¤1å°æ—¶
            let scheduleTimer = null;
            let testCycleCount = 0;
            let nextTestTimestamp = null;

            // åŠ è½½é…ç½®
            function loadConfig() {
                try {
                    const configStr = localStorage.getItem('telegram_config');
                    if (configStr) {
                        telegramConfig = JSON.parse(configStr);
                        elements.botToken.value = telegramConfig.botToken || '';
                        elements.chatId.value = telegramConfig.chatId || '';
                        showStatus('å·²åŠ è½½ä¿å­˜çš„é…ç½®', 'success');
                    }
                    
                    // åŠ è½½å®šæ—¶è®¾ç½®
                    const scheduleConfig = localStorage.getItem('schedule_config');
                    if (scheduleConfig) {
                        const config = JSON.parse(scheduleConfig);
                        scheduleInterval = config.interval || 60 * 60 * 1000;
                        testCycleCount = config.cycleCount || 0;
                        
                        // æ¿€æ´»å¯¹åº”çš„æŒ‰é’®
                        document.querySelectorAll('.schedule-btn').forEach(btn => {
                            const minutes = parseInt(btn.dataset.minutes);
                            if (minutes === scheduleInterval / 60000) {
                                btn.classList.add('active');
                            }
                        });
                        
                        if (config.running) {
                            startSchedule();
                        }
                    }
                    
                    // åŠ è½½åŸŸååˆ—è¡¨
                    const domainsConfig = localStorage.getItem('domains_config');
                    if (domainsConfig) {
                        elements.domains.value = domainsConfig;
                    }
                } catch (error) {
                    console.log('åŠ è½½é…ç½®å¤±è´¥:', error);
                }
            }

            // ä¿å­˜é…ç½®
            function saveConfig() {
                const botToken = elements.botToken.value.trim();
                const chatId = elements.chatId.value.trim();
                
                if (!botToken) {
                    showStatus('è¯·è¾“å…¥Bot Token', 'error');
                    return;
                }
                
                if (!chatId) {
                    showStatus('è¯·è¾“å…¥Chat ID', 'error');
                    return;
                }
                
                if (!botToken.match(/^\d+:[A-Za-z0-9_-]+$/)) {
                    showStatus('Bot Tokenæ ¼å¼ä¸æ­£ç¡®', 'error');
                    return;
                }
                
                try {
                    telegramConfig = {
                        botToken: botToken,
                        chatId: chatId,
                        lastUpdated: new Date().toISOString()
                    };
                    
                    localStorage.setItem('telegram_config', JSON.stringify(telegramConfig));
                    showStatus('é…ç½®ä¿å­˜æˆåŠŸ', 'success');
                    console.log('Telegramé…ç½®å·²ä¿å­˜');
                } catch (error) {
                    showStatus('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
                    console.log('ä¿å­˜é…ç½®å¤±è´¥:', error);
                }
            }

            // è·å–Chat ID
            function getChatId() {
                const botToken = elements.botToken.value.trim();
                
                if (!botToken) {
                    showStatus('è¯·è¾“å…¥Bot Token', 'error');
                    return;
                }
                
                if (!botToken.match(/^\d+:[A-Za-z0-9_-]+$/)) {
                    showStatus('Bot Tokenæ ¼å¼ä¸æ­£ç¡®', 'error');
                    return;
                }
                
                showStatus('æ­£åœ¨è·å–Chat ID...', 'info');
                
                fetch(`https://api.telegram.org/bot${botToken}/getUpdates`)
                    .then(response => response.json())
                    .then(data => {
                        if (!data.ok) {
                            showStatus('è¯·æ±‚å¤±è´¥: ' + data.description, 'error');
                            return;
                        }
                        
                        if (!data.result || data.result.length === 0) {
                            showStatus('æ²¡æœ‰æ‰¾åˆ°æ¶ˆæ¯ï¼Œè¯·å…ˆç»™æœºå™¨äººå‘é€ä¸€æ¡æ¶ˆæ¯', 'error');
                            return;
                        }
                        
                        // æ˜¾ç¤ºæ‰¾åˆ°çš„Chat ID
                        let message = 'æ‰¾åˆ°çš„Chat ID:\n\n';
                        data.result.forEach((update, index) => {
                            if (update.message && update.message.chat) {
                                const chat = update.message.chat;
                                const from = update.message.from;
                                const date = new Date(update.message.date * 1000).toLocaleString();
                                
                                message += `${index + 1}. ç±»å‹: ${chat.type}\n`;
                                message += `   Chat ID: ${chat.id}\n`;
                                message += `   æ ‡é¢˜: ${chat.title || 'ç§èŠ'}\n`;
                                message += `   å‘é€è€…: ${from.first_name} (${from.username || 'æ— ç”¨æˆ·å'})\n`;
                                message += `   æ—¶é—´: ${date}\n\n`;
                                
                                // å¦‚æœæ˜¯ç§èŠï¼Œè‡ªåŠ¨å¡«å……Chat ID
                                if (chat.type === 'private') {
                                    elements.chatId.value = chat.id;
                                    showStatus('å·²è‡ªåŠ¨å¡«å……ç§èŠChat ID', 'success');
                                    return;
                                }
                            }
                        });
                        
                        // æ˜¾ç¤ºé€‰æ‹©å¯¹è¯æ¡†
                        const selectedId = prompt(message + '\nè¯·é€‰æ‹©è¦ä½¿ç”¨çš„Chat IDï¼ˆè¾“å…¥æ•°å­—ï¼‰:');
                        if (selectedId && data.result[selectedId - 1] && data.result[selectedId - 1].message) {
                            const chatId = data.result[selectedId - 1].message.chat.id;
                            elements.chatId.value = chatId;
                            showStatus('Chat IDå·²è®¾ç½®', 'success');
                        }
                    })
                    .catch(error => {
                        showStatus('ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
                    });
            }

            // æ¸…é™¤é…ç½®
            function clearConfig() {
                if (confirm('ç¡®å®šè¦æ¸…é™¤Telegramé…ç½®å—ï¼Ÿ')) {
                    telegramConfig = null;
                    elements.botToken.value = '';
                    elements.chatId.value = '';
                    localStorage.removeItem('telegram_config');
                    showStatus('é…ç½®å·²æ¸…é™¤', 'info');
                }
            }

            // æµ‹è¯•é…ç½®
            function testConfig() {
                if (!telegramConfig) {
                    showStatus('è¯·å…ˆä¿å­˜é…ç½®', 'error');
                    return;
                }
                
                const { botToken, chatId } = telegramConfig;
                
                showStatus('æ­£åœ¨æµ‹è¯•Telegramè¿æ¥...', 'info');
                addLog('æ­£åœ¨æµ‹è¯•Telegramè¿æ¥...');
                
                const now = new Date();
                const currentTime = now.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                }).replace(/\//g, '-');
                
                const testMessage = `âœ… ITDOGç›‘æ§ç³»ç»Ÿæµ‹è¯•æ¶ˆæ¯\\n\\nğŸ•’ å‘é€æ—¶é—´: ${currentTime}\\nğŸ“Š æµ‹è¯•çŠ¶æ€: è¿æ¥æ­£å¸¸\\nğŸ”§ é…ç½®éªŒè¯: æˆåŠŸ\\n\\nç³»ç»Ÿå·²å‡†å¤‡å°±ç»ªï¼`;
                
                fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat_id: chatId,
                        text: testMessage,
                        parse_mode: 'HTML',
                        disable_web_page_preview: true
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.ok) {
                        showStatus('âœ… Telegramè¿æ¥æµ‹è¯•æˆåŠŸï¼Œè¯·æ£€æŸ¥Telegramæ¶ˆæ¯', 'success');
                        addLog('âœ… Telegramè¿æ¥æµ‹è¯•æˆåŠŸ');
                    } else {
                        showStatus('âŒ Telegramè¿æ¥å¤±è´¥: ' + (data.description || 'æœªçŸ¥é”™è¯¯'), 'error');
                        addLog('âŒ Telegramè¿æ¥å¤±è´¥: ' + data.description);
                        
                        // å¦‚æœæ˜¯Chat IDé—®é¢˜
                        if (data.description && data.description.includes('chat') && data.description.includes('group')) {
                            showStatus('âš ï¸ å¯èƒ½æ˜¯Chat IDå·²æ”¹å˜ï¼Œè¯·ä½¿ç”¨"è·å–Chat ID"æŒ‰é’®é‡æ–°è·å–', 'error');
                        }
                    }
                })
                .catch(error => {
                    showStatus('âŒ ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
                    addLog('âŒ ç½‘ç»œé”™è¯¯: ' + error.message);
                });
            }

            // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
            function showStatus(message, type) {
                elements.configStatus.textContent = message;
                elements.configStatus.className = 'status-message';
                
                if (type === 'success') {
                    elements.configStatus.classList.add('status-success');
                } else if (type === 'error') {
                    elements.configStatus.classList.add('status-error');
                } else {
                    elements.configStatus.classList.add('status-info');
                }
                
                elements.configStatus.style.display = 'block';
                
                setTimeout(() => {
                    if (type !== 'info') {
                        elements.configStatus.style.display = 'none';
                    }
                }, 5000);
            }

            // æ·»åŠ æ—¥å¿—
            function addLog(message) {
                const now = new Date();
                const timeString = now.toLocaleTimeString();
                
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                logEntry.innerHTML = `<span style="color: #6c757d;">[${timeString}]</span> ${message}`;
                
                elements.monitorLog.appendChild(logEntry);
                elements.monitorLog.scrollTop = elements.monitorLog.scrollHeight;
                
                // ä¿æŒæ—¥å¿—æ•°é‡ä¸è¶…è¿‡100æ¡
                const logEntries = elements.monitorLog.querySelectorAll('.log-entry');
                if (logEntries.length > 100) {
                    for (let i = 0; i < logEntries.length - 100; i++) {
                        logEntries[i].remove();
                    }
                }
            }

            // å¼€å§‹æ‰¹é‡æµ‹è¯•
            function startBatchTest() {
                const domains = elements.domains.value.trim();
                if (!domains) {
                    alert('è¯·è¾“å…¥è¦æµ‹è¯•çš„ç½‘ç«™åœ°å€');
                    return;
                }
                
                // ä¿å­˜åŸŸååˆ—è¡¨
                localStorage.setItem('domains_config', domains);
                
                domainArray = domains.split('\n')
                    .map(domain => domain.trim())
                    .filter(domain => domain.length > 0)
                    .map(domain => {
                        if (!domain.startsWith('http://') && !domain.startsWith('https://')) {
                            return 'https://' + domain;
                        }
                        return domain;
                    });
                
                if (domainArray.length === 0) return;
                
                // æ˜¾ç¤ºåŸŸååˆ—è¡¨
                elements.domainsContainer.innerHTML = '';
                domainArray.forEach((domain, index) => {
                    const item = document.createElement('div');
                    item.className = 'domain-item';
                    item.innerHTML = `
                        <div class="domain-name">${index + 1}. ${domain}</div>
                        <div class="domain-status status-pending" id="status-${index}">ç­‰å¾…</div>
                    `;
                    elements.domainsContainer.appendChild(item);
                });
                
                elements.domainList.style.display = 'block';
                elements.testControls.style.display = 'block';
                elements.monitorLog.style.display = 'block';
                
                // é‡ç½®çŠ¶æ€
                currentIndex = 0;
                isTesting = true;
                isPaused = false;
                activeTabs = 0;
                openedTabs = [];
                
                elements.testedCount.textContent = '0';
                elements.activeCount.textContent = '0';
                elements.pendingCount.textContent = domainArray.length;
                elements.progressText.textContent = `0/${domainArray.length}`;
                elements.progressBar.style.width = '0%';
                
                addLog(`å¼€å§‹æ‰¹é‡æµ‹è¯•ï¼Œå…± ${domainArray.length} ä¸ªåŸŸå`);
                
                // å¼€å§‹æ‰“å¼€æ ‡ç­¾é¡µ
                openNextBatch();
            }

            // æ‰“å¼€ä¸‹ä¸€æ‰¹æ¬¡
            function openNextBatch() {
                if (!isTesting || isPaused || currentIndex >= domainArray.length) {
                    if (currentIndex >= domainArray.length && activeTabs === 0) {
                        addLog('âœ… æ‰€æœ‰åŸŸåæµ‹è¯•å®Œæˆ');
                        isTesting = false;
                    }
                    return;
                }
                
                const batchCount = Math.min(batchSize, domainArray.length - currentIndex);
                addLog(`æ‰“å¼€æ‰¹æ¬¡ ${Math.floor(currentIndex / batchSize) + 1} (${batchCount}ä¸ªåŸŸå)`);
                
                for (let i = 0; i < batchCount; i++) {
                    const domainIndex = currentIndex + i;
                    const domain = domainArray[domainIndex];
                    
                    // æ›´æ–°çŠ¶æ€
                    const statusElement = document.getElementById(`status-${domainIndex}`);
                    if (statusElement) {
                        statusElement.textContent = 'æµ‹è¯•ä¸­';
                        statusElement.className = 'domain-status status-testing';
                    }
                    
                    // å»¶è¿Ÿæ‰“å¼€
                    setTimeout(() => {
                        openITDOGTab(domain, domainIndex);
                    }, i * 1000);
                }
                
                currentIndex += batchCount;
                
                // æ›´æ–°UI
                updateProgress();
                
                // å®‰æ’ä¸‹ä¸€æ‰¹æ¬¡
                if (currentIndex < domainArray.length) {
                    setTimeout(() => {
                        if (!isPaused) {
                            openNextBatch();
                        }
                    }, testInterval);
                }
            }

            // åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€ITDOG
            function openITDOGTab(domain, index) {
                try {
                    const cleanDomain = domain.replace(/^https?:\/\//, '');
                    const url = `https://www.itdog.cn/http/?domain=${encodeURIComponent(cleanDomain)}`;
                    
                    // åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€
                    const tab = window.open(url, '_blank');
                    
                    if (tab) {
                        activeTabs++;
                        openedTabs.push({
                            tab: tab,
                            index: index,
                            domain: domain,
                            openedAt: Date.now()
                        });
                        
                        // ç›‘å¬æ ‡ç­¾é¡µå…³é—­
                        const checkClose = setInterval(() => {
                            if (tab.closed) {
                                clearInterval(checkClose);
                                activeTabs--;
                                
                                // æ›´æ–°çŠ¶æ€
                                const statusElement = document.getElementById(`status-${index}`);
                                if (statusElement) {
                                    statusElement.textContent = 'å·²å®Œæˆ';
                                    statusElement.className = 'domain-status status-success';
                                }
                                
                                addLog(`æ ‡ç­¾é¡µå…³é—­: ${domain}`);
                                
                                // æ£€æŸ¥æ˜¯å¦å…¨éƒ¨å®Œæˆ
                                if (currentIndex >= domainArray.length && activeTabs === 0) {
                                    addLog('âœ… æ‰€æœ‰æµ‹è¯•å®Œæˆ');
                                    isTesting = false;
                                    
                                    // å¦‚æœæ˜¯å®šæ—¶æµ‹è¯•ï¼Œæ›´æ–°çŠ¶æ€
                                    if (scheduleRunning) {
                                        updateScheduleStatus();
                                    }
                                }
                            }
                        }, 1000);
                        
                        addLog(`æ ‡ç­¾é¡µå·²æ‰“å¼€: ${domain}`);
                    } else {
                        addLog(`âŒ æ— æ³•æ‰“å¼€æ ‡ç­¾é¡µ: ${domain} (å¯èƒ½è¢«æµè§ˆå™¨é˜»æ­¢)`);
                        const statusElement = document.getElementById(`status-${index}`);
                        if (statusElement) {
                            statusElement.textContent = 'å¤±è´¥';
                            statusElement.className = 'domain-status status-error';
                        }
                    }
                } catch (error) {
                    addLog(`âŒ æ‰“å¼€æ ‡ç­¾é¡µå‡ºé”™: ${error.message}`);
                }
            }

            // æ›´æ–°è¿›åº¦
            function updateProgress() {
                elements.testedCount.textContent = Math.min(currentIndex, domainArray.length);
                elements.activeCount.textContent = activeTabs;
                elements.pendingCount.textContent = Math.max(0, domainArray.length - currentIndex);
                elements.progressText.textContent = `${Math.min(currentIndex, domainArray.length)}/${domainArray.length}`;
                
                const progressPercent = (Math.min(currentIndex, domainArray.length) / domainArray.length) * 100;
                elements.progressBar.style.width = `${progressPercent}%`;
            }

            // æš‚åœæµ‹è¯•
            function pauseTest() {
                if (!isTesting) return;
                
                if (isPaused) {
                    isPaused = false;
                    elements.pauseBtn.innerHTML = '<i class="fas fa-pause btn-icon"></i> æš‚åœ';
                    addLog('ç»§ç»­æµ‹è¯•');
                    openNextBatch();
                } else {
                    isPaused = true;
                    elements.pauseBtn.innerHTML = '<i class="fas fa-play btn-icon"></i> ç»§ç»­';
                    addLog('æµ‹è¯•æš‚åœ');
                }
            }

            // åœæ­¢æµ‹è¯•
            function stopTest() {
                if (!isTesting && openedTabs.length === 0) return;
                
                isTesting = false;
                isPaused = false;
                
                // å…³é—­æ‰€æœ‰æ‰“å¼€çš„æ ‡ç­¾é¡µ
                openedTabs.forEach(item => {
                    try {
                        if (item.tab && !item.tab.closed) {
                            item.tab.close();
                        }
                    } catch (e) {
                        console.log('å…³é—­æ ‡ç­¾é¡µå¤±è´¥:', e);
                    }
                });
                
                openedTabs = [];
                activeTabs = 0;
                
                addLog('æµ‹è¯•å·²åœæ­¢');
                
                // é‡ç½®çŠ¶æ€æ˜¾ç¤º
                for (let i = 0; i < domainArray.length; i++) {
                    const statusElement = document.getElementById(`status-${i}`);
                    if (statusElement) {
                        statusElement.textContent = 'å·²å–æ¶ˆ';
                        statusElement.className = 'domain-status status-pending';
                    }
                }
            }

            // æ‰‹åŠ¨æµ‹è¯•ä¸€æ¬¡
            function manualTest() {
                const domains = elements.domains.value.trim();
                if (!domains) {
                    alert('è¯·å…ˆè®¾ç½®è¦æµ‹è¯•çš„ç½‘ç«™åˆ—è¡¨');
                    return;
                }
                
                if (isTesting) {
                    alert('å½“å‰æ­£åœ¨æµ‹è¯•ä¸­ï¼Œè¯·ç¨åå†è¯•');
                    return;
                }
                
                startBatchTest();
            }

            // å¯åŠ¨å®šæ—¶æµ‹è¯•
            function startSchedule() {
                const domains = elements.domains.value.trim();
                if (!domains) {
                    alert('è¯·å…ˆè®¾ç½®è¦æµ‹è¯•çš„ç½‘ç«™åˆ—è¡¨');
                    return;
                }
                
                if (scheduleRunning) {
                    alert('å®šæ—¶æµ‹è¯•å·²ç»åœ¨è¿è¡Œä¸­');
                    return;
                }
                
                if (!telegramConfig) {
                    alert('è¯·å…ˆé…ç½®Telegramä¿¡æ¯');
                    return;
                }
                
                // è·å–é€‰ä¸­çš„é—´éš”
                const activeBtn = document.querySelector('.schedule-btn.active');
                let minutes = activeBtn ? parseInt(activeBtn.dataset.minutes) : 60;
                
                // æ£€æŸ¥è‡ªå®šä¹‰è¾“å…¥
                const customInput = document.getElementById('custom-interval');
                if (customInput.value) {
                    minutes = parseInt(customInput.value) || minutes;
                }
                
                scheduleInterval = minutes * 60 * 1000;
                
                scheduleRunning = true;
                elements.startScheduleBtn.style.display = 'none';
                elements.stopScheduleBtn.style.display = 'flex';
                document.querySelector('.timer-status').style.display = 'block';
                
                // ä¿å­˜å®šæ—¶é…ç½®
                saveScheduleConfig();
                
                addLog(`ğŸš€ å¯åŠ¨å®šæ—¶æµ‹è¯•ï¼Œæ¯ ${minutes} åˆ†é’Ÿæµ‹è¯•ä¸€æ¬¡`);
                
                // ç«‹å³æ‰§è¡Œä¸€æ¬¡æµ‹è¯•
                startBatchTest();
                
                // è®¾ç½®å®šæ—¶å™¨
                scheduleTimer = setInterval(() => {
                    if (scheduleRunning) {
                        testCycleCount++;
                        addLog(`â° å®šæ—¶æ—¶é—´åˆ°ï¼Œå¼€å§‹ç¬¬ ${testCycleCount + 1} æ¬¡æµ‹è¯•`);
                        startBatchTest();
                        updateScheduleStatus();
                        saveScheduleConfig();
                    }
                }, scheduleInterval);
                
                updateScheduleStatus();
            }

            // åœæ­¢å®šæ—¶æµ‹è¯•
            function stopSchedule() {
                if (!scheduleRunning) return;
                
                scheduleRunning = false;
                
                if (scheduleTimer) {
                    clearInterval(scheduleTimer);
                    scheduleTimer = null;
                }
                
                elements.startScheduleBtn.style.display = 'flex';
                elements.stopScheduleBtn.style.display = 'none';
                
                addLog('å®šæ—¶æµ‹è¯•å·²åœæ­¢');
                
                // åœæ­¢å½“å‰æ­£åœ¨è¿›è¡Œçš„æµ‹è¯•
                if (isTesting) {
                    stopTest();
                }
                
                // ä¿å­˜é…ç½®
                saveScheduleConfig();
            }

            // æ›´æ–°å®šæ—¶çŠ¶æ€
            function updateScheduleStatus() {
                if (!scheduleRunning) return;
                
                elements.scheduleStatus.textContent = 'è¿è¡Œä¸­';
                elements.testCount.textContent = testCycleCount + 1;
                
                // è®¡ç®—ä¸‹æ¬¡æµ‹è¯•æ—¶é—´
                const nextTime = new Date(Date.now() + scheduleInterval);
                elements.nextTestTime.textContent = nextTime.toLocaleTimeString('zh-CN', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: false 
                });
            }

            // ä¿å­˜å®šæ—¶é…ç½®
            function saveScheduleConfig() {
                const scheduleConfig = {
                    interval: scheduleInterval,
                    cycleCount: testCycleCount,
                    running: scheduleRunning,
                    lastUpdated: new Date().toISOString()
                };
                localStorage.setItem('schedule_config', JSON.stringify(scheduleConfig));
            }

            // å¤åˆ¶è„šæœ¬
            function copyScript() {
                elements.scriptCode.style.display = 'block';
                
                const githubPagesUrl = window.location.origin + window.location.pathname;
                let scriptText = elements.scriptCode.textContent;
                scriptText = scriptText.replace('YOUR_GITHUB_PAGES_URL_HERE', githubPagesUrl);
                
                navigator.clipboard.writeText(scriptText)
                    .then(() => {
                        const originalText = elements.copyScriptBtn.innerHTML;
                        elements.copyScriptBtn.innerHTML = '<i class="fas fa-check"></i> å·²å¤åˆ¶åˆ°å‰ªè´´æ¿';
                        elements.copyScriptBtn.style.background = '#2ecc71';
                        
                        setTimeout(() => {
                            elements.copyScriptBtn.innerHTML = originalText;
                            elements.copyScriptBtn.style.background = '';
                        }, 2000);
                        
                        showStatus('è„šæœ¬å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œè¯·åœ¨Tampermonkeyä¸­å®‰è£…', 'success');
                    })
                    .catch(err => {
                        showStatus('å¤åˆ¶å¤±è´¥: ' + err.message, 'error');
                    });
            }

            // ç›‘å¬æ¥è‡ªTampermonkeyè„šæœ¬çš„æ¶ˆæ¯
            window.addEventListener('message', function(event) {
                // å¤„ç†é…ç½®è¯·æ±‚
                if (event.data.type === 'REQUEST_TELEGRAM_CONFIG') {
                    if (telegramConfig) {
                        event.source.postMessage({
                            type: 'TELEGRAM_CONFIG',
                            config: telegramConfig
                        }, event.origin);
                        addLog('å‘é€Telegramé…ç½®ç»™è„šæœ¬');
                    }
                    return;
                }
                
                // å¤„ç†æµ‹è¯•ç»“æœ
                if (event.data.type === 'ITDOG_TEST_RESULT') {
                    const { domain, rate, data, timestamp } = event.data;
                    
                    const time = new Date(timestamp).toLocaleTimeString();
                    
                    // æŸ¥æ‰¾åŸŸåç´¢å¼•
                    const domainIndex = domainArray.findIndex(d => d.includes(domain.replace(/^https?:\/\//, '')));
                    
                    if (domainIndex !== -1) {
                        const statusElement = document.getElementById(`status-${domainIndex}`);
                        if (statusElement) {
                            // æ ¹æ®è¿é€šç‡è®¾ç½®çŠ¶æ€
                            if (rate < 90) {
                                statusElement.textContent = 'è¿é€šç‡ä½';
                                statusElement.className = 'domain-status status-warning';
                                addLog(`âš ï¸ ${domain} - è¿é€šç‡: ${rate}% (ä½äº90%)`);
                            } else {
                                statusElement.textContent = 'æµ‹è¯•å®Œæˆ';
                                statusElement.className = 'domain-status status-success';
                                addLog(`âœ… ${domain} - è¿é€šç‡: ${rate}%`);
                            }
                        }
                    }
                }
            });

            // äº‹ä»¶ç›‘å¬
            elements.saveConfigBtn.addEventListener('click', saveConfig);
            elements.testConfigBtn.addEventListener('click', testConfig);
            elements.getChatIdBtn.addEventListener('click', getChatId);
            elements.clearConfigBtn.addEventListener('click', clearConfig);
            elements.startTestBtn.addEventListener('click', startBatchTest);
            elements.clearDomainsBtn.addEventListener('click', () => {
                elements.domains.value = '';
            });
            elements.manualTestBtn.addEventListener('click', manualTest);
            elements.pauseBtn.addEventListener('click', pauseTest);
            elements.stopBtn.addEventListener('click', stopTest);
            elements.copyScriptBtn.addEventListener('click', copyScript);
            elements.startScheduleBtn.addEventListener('click', startSchedule);
            elements.stopScheduleBtn.addEventListener('click', stopSchedule);

            // å®šæ—¶é¢‘ç‡é€‰æ‹©
            document.querySelectorAll('.schedule-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.schedule-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                });
            });

            // åˆå§‹åŒ–
            loadConfig();
            
            // è®¾ç½®ç¤ºä¾‹åŸŸå
            elements.domains.value = `https://www.alibabacloud.com
www.dynadot.com
itdog.cn
godaddy.com
github.com
google.com`;
            
            console.log('GitHub Pagesé…ç½®ä¸­å¿ƒå·²åŠ è½½ - å®Œæ•´åŠŸèƒ½ç‰ˆ');
        });
    </script>
</body>
</html>
