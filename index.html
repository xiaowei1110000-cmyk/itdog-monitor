<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ITDOGç½‘ç«™æµ‹é€Ÿæ‰¹é‡å·¥å…· - ä¸“ä¸šç›‘æ§ç‰ˆ</title>
    <style>
        /* åŸºç¡€æ ·å¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .container {
            width: 100%;
            max-width: 1400px;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25);
            padding: 40px;
            margin-top: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        /* å¤´éƒ¨ */
        header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 2.8rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle {
            color: #6c757d;
            font-size: 1.2rem;
            font-weight: 500;
        }
        
        .itdog-link {
            color: #667eea;
            font-weight: 700;
            text-decoration: none;
            transition: all 0.3s ease;
        }
        
        /* è¯´æ˜åŒºåŸŸ */
        .instructions {
            background: linear-gradient(135deg, #fff9e6 0%, #ffeaa7 100%);
            border-left: 5px solid #f39c12;
            padding: 20px;
            margin: 25px 0;
            border-radius: 12px;
        }
        
        .instructions h4 {
            color: #e67e22;
            margin-bottom: 15px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* è¡¨å•åŒºåŸŸ */
        .form-group {
            margin-bottom: 35px;
        }
        
        label {
            display: block;
            margin-bottom: 12px;
            color: #495057;
            font-weight: 700;
            font-size: 1.2rem;
        }
        
        textarea {
            width: 100%;
            height: 220px;
            padding: 20px;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            font-size: 1.05rem;
            resize: vertical;
            background: #f8f9fa;
        }
        
        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .example {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            font-size: 1rem;
            color: #495057;
            border-left: 5px solid #667eea;
        }
        
        /* æŒ‰é’® */
        .buttons {
            display: flex;
            gap: 20px;
            margin-top: 40px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 16px 32px;
            border: none;
            border-radius: 12px;
            font-size: 1.15rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 200px;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
            box-shadow: 0 8px 25px rgba(46, 204, 113, 0.3);
        }
        
        .btn-success:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(46, 204, 113, 0.4);
        }
        
        .btn-secondary {
            background: #f8f9fa;
            color: #495057;
            border: 2px solid #dee2e6;
        }
        
        .btn-secondary:hover {
            background: #e9ecef;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
        }
        
        .btn-icon {
            margin-right: 12px;
        }
        
        /* Telegramè®¾ç½®åŒºåŸŸ */
        .telegram-settings {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border-left: 5px solid #28a745;
            padding: 25px;
            margin: 25px 0;
            border-radius: 12px;
        }
        
        .telegram-settings h4 {
            color: #28a745;
            margin-bottom: 20px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .telegram-input-group {
            margin-bottom: 15px;
        }
        
        .telegram-input-group label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
            display: block;
        }
        
        .telegram-input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ced4da;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .telegram-input-group input:focus {
            outline: none;
            border-color: #28a745;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
        }
        
        .telegram-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        .btn-telegram {
            background: linear-gradient(135deg, #0088cc 0%, #006699 100%);
            color: white;
        }
        
        /* è¿é€šç‡è­¦å‘Š */
        .connectivity-alert {
            background: linear-gradient(135deg, #ffcccc 0%, #ff6b6b 100%);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border-left: 5px solid #e74c3c;
            display: none;
        }
        
        .alert-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .alert-title {
            color: #c0392b;
            font-weight: bold;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .alert-close {
            background: none;
            border: none;
            color: #c0392b;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
        }
        
        .alert-list {
            max-height: 200px;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.8);
            padding: 15px;
            border-radius: 8px;
        }
        
        .alert-item {
            padding: 10px;
            border-bottom: 1px solid #ffcccc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .alert-domain {
            font-weight: 500;
            color: #2c3e50;
        }
        
        .alert-rate {
            font-weight: bold;
            color: #e74c3c;
            padding: 5px 10px;
            background: rgba(231, 76, 60, 0.1);
            border-radius: 4px;
        }
        
        /* é€šçŸ¥è®¾ç½® */
        .notification-settings {
            background: #e8f4fc;
            border-radius: 12px;
            padding: 25px;
            margin: 25px 0;
            border: 2px solid #3498db;
        }
        
        .notification-settings h4 {
            color: #3498db;
            margin-bottom: 20px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .setting-item {
            background: white;
            padding: 20px;
            border-radius: 10px;
        }
        
        .test-notification {
            background: #a8edea;
            padding: 15px 20px;
            border-radius: 10px;
            margin-top: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        /* æµ‹è¯•ç»“æœé¢æ¿ */
        .result {
            margin-top: 40px;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 18px;
            display: none;
        }
        
        .result h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* é…ç½®æ‘˜è¦ */
        .test-config-summary {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        
        .config-item {
            margin-right: 25px;
            margin-bottom: 15px;
            padding: 15px 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        
        .config-label {
            font-weight: 600;
            color: #6c757d;
            margin-right: 8px;
        }
        
        .config-value {
            color: #2c3e50;
            font-weight: 700;
            font-size: 1.1rem;
        }
        
        /* è¿›åº¦æ¡ */
        .progress-container {
            margin: 25px 0;
        }
        
        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 1rem;
            color: #6c757d;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .progress-bar {
            width: 100%;
            height: 14px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #2ecc71 0%, #27ae60 100%);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        /* æµ‹è¯•æ§åˆ¶ */
        .test-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 25px 0;
            padding: 20px;
            background: #e8f4fc;
            border-radius: 15px;
            border: 2px solid #3498db;
        }
        
        .control-buttons {
            display: flex;
            gap: 15px;
        }
        
        /* è½®æ¬¡æ˜¾ç¤º */
        .test-cycle {
            background: #a8edea;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            display: none;
        }
        
        /* å€’è®¡æ—¶ */
        .countdown-timer {
            background: #ff9a9e;
            padding: 12px 15px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            display: none;
            margin-top: 10px;
        }
        
        .countdown-value {
            font-size: 1.2rem;
            color: #e74c3c;
        }
        
        /* çŠ¶æ€ç›‘æ§ */
        .status-monitor {
            margin-top: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 15px;
            border: 2px solid #3498db;
            display: none;
        }
        
        .monitor-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 10px;
        }
        
        .monitor-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-item {
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .monitor-log {
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            padding: 15px;
            border-radius: 8px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
        }
        
        /* åŸŸååˆ—è¡¨ */
        .domain-list {
            margin: 25px 0;
            padding: 20px;
            background-color: white;
            border-radius: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .domain-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 2px solid #f8f9fa;
        }
        
        .domain-url {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1rem;
            color: #2c3e50;
        }
        
        .domain-status {
            font-size: 0.9rem;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 700;
            min-width: 120px;
            text-align: center;
        }
        
        /* çŠ¶æ€é¢œè‰² */
        .status-pending { background: #f1c40f; color: #000; }
        .status-opening { background: #3498db; color: white; }
        .status-opened { background: #2ecc71; color: white; }
        .status-error { background: #e74c3c; color: white; }
        .status-low-connectivity { background: #ff9a9e; color: #c0392b; }
        .status-retest { background: #e67e22; color: white; }
        
        /* è¿é€šç‡å¾½ç«  */
        .connectivity-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 700;
            margin-left: 10px;
        }
        
        .badge-good { background: #2ecc71; color: white; }
        .badge-warning { background: #f1c40f; color: #000; }
        .badge-bad { background: #e74c3c; color: white; }
        
        /* è°ƒè¯•é¢æ¿ */
        .debug-panel {
            margin-top: 20px;
            padding: 15px;
            background: #2c3e50;
            color: white;
            border-radius: 10px;
            display: none;
        }
        
        .debug-panel h4 {
            color: #ecf0f1;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        #debug-log {
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            background: #34495e;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        /* ç”¨æˆ·è„šæœ¬ä»£ç  */
        .userscript-code {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 12px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            overflow-x: auto;
            white-space: pre-wrap;
            margin-top: 15px;
            display: none;
        }
        
        /* é¡µè„š */
        footer {
            margin-top: 50px;
            text-align: center;
            color: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
            padding: 25px;
            width: 100%;
        }
        
        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .test-controls {
                flex-direction: column;
                gap: 20px;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-tachometer-alt"></i> ITDOGç½‘ç«™æµ‹é€Ÿæ‰¹é‡å·¥å…·</h1>
            <p class="subtitle">æ‰¹é‡æ‰“å¼€ <a href="https://www.itdog.cn/http/" target="_blank" class="itdog-link">ITDOG.CN HTTPæµ‹è¯•</a> è¿›è¡Œä¸“ä¸šç½‘ç«™æµ‹é€Ÿ</p>
        </header>
        
        <div class="instructions">
            <h4><i class="fas fa-info-circle"></i> ä½¿ç”¨è¯´æ˜</h4>
            <p>1. æ‰¹é‡æµ‹è¯•ç½‘ç«™è¿é€šç‡å’Œå“åº”é€Ÿåº¦ï¼Œæ”¯æŒå®šæ—¶é‡æµ‹</p>
            <p>2. å®‰è£…Tampermonkeyè„šæœ¬å¯è‡ªåŠ¨å¡«å……åŸŸåå¹¶è¿”å›çœŸå®è¿é€šç‡æ•°æ®</p>
            <p>3. ä½è¿é€šç‡ï¼ˆé»˜è®¤ï¼œ90%ï¼‰æ—¶ä¼šè‡ªåŠ¨å‘é€Telegramé€šçŸ¥</p>
            <p>4. æ¯ä¸ªITDOGæ ‡ç­¾é¡µä¼šåœ¨10åˆ†é’Ÿåè‡ªåŠ¨å…³é—­</p>
            <p>5. ä¸ºé¿å…æµè§ˆå™¨é™åˆ¶ï¼Œæ¯æ¬¡åŒæ—¶æ‰“å¼€6ä¸ªæ ‡ç­¾é¡µ</p>
        </div>
        
        <!-- è¿é€šç‡è­¦å‘Š -->
        <div class="connectivity-alert" id="connectivity-alert">
            <div class="alert-header">
                <div class="alert-title">
                    <i class="fas fa-exclamation-triangle"></i>
                    è¿é€šç‡è­¦å‘Š
                </div>
                <button class="alert-close" id="alert-close">Ã—</button>
            </div>
            <p>ä»¥ä¸‹ç½‘ç«™æµ‹è¯•å¼‚å¸¸æˆ–è¿é€šç‡ä½äºé˜ˆå€¼ï¼š</p>
            <div class="alert-list" id="alert-list"></div>
        </div>
        
        <!-- åŸŸåè¾“å…¥ -->
        <div class="form-group">
            <label for="domains"><i class="fas fa-globe"></i> è¾“å…¥è¦æµ‹è¯•çš„ç½‘ç«™åœ°å€</label>
            <textarea id="domains" placeholder="æ¯è¡Œè¾“å…¥ä¸€ä¸ªç½‘ç«™åœ°å€ï¼Œæ”¯æŒå®Œæ•´URLæˆ–åŸŸå"></textarea>
            <div class="example">
                <strong>ç¤ºä¾‹æ ¼å¼ï¼š</strong><br>
                https://www.alibabacloud.com<br>
                www.dynadot.com<br>
                Itdog.cn<br>
                godday.com
            </div>
        </div>
        
        <!-- Telegramè®¾ç½® -->
        <div class="telegram-settings" id="telegram-settings">
            <h4><i class="fab fa-telegram"></i> Telegramé€šçŸ¥è®¾ç½®</h4>
            
            <div class="telegram-input-group">
                <label for="telegram-bot-token">Telegram Bot Token</label>
                <input type="password" id="telegram-bot-token" placeholder="è¾“å…¥ä½ çš„Bot Token">
                <small style="color: #6c757d; display: block; margin-top: 5px;">æ ¼å¼: 1234567890:ABCdefGHIjklMNOpqrsTUVwxyz</small>
            </div>
            
            <div class="telegram-input-group">
                <label for="telegram-chat-id">Telegram Chat ID</label>
                <input type="text" id="telegram-chat-id" placeholder="è¾“å…¥ä½ çš„Chat ID">
                <small style="color: #6c757d; display: block; margin-top: 5px;">åœ¨@userinfobotä¸­è·å–</small>
            </div>
            
            <div class="telegram-buttons">
                <button class="btn btn-telegram" id="save-telegram-btn">
                    <i class="fas fa-save btn-icon"></i> ä¿å­˜é…ç½®
                </button>
                <button class="btn btn-success" id="test-telegram-btn">
                    <i class="fas fa-paper-plane btn-icon"></i> æµ‹è¯•Telegram
                </button>
                <button class="btn btn-secondary" id="clear-telegram-btn">
                    <i class="fas fa-trash btn-icon"></i> æ¸…é™¤é…ç½®
                </button>
            </div>
            
            <div id="telegram-status" style="margin-top: 15px; padding: 10px; border-radius: 8px; display: none;"></div>
        </div>
        
        <!-- Telegramé…ç½®è¯´æ˜ -->
        <div class="instructions">
            <h4><i class="fab fa-telegram"></i> Telegramé€šçŸ¥é…ç½®è¯´æ˜</h4>
            <p><strong>é…ç½®æ­¥éª¤ï¼š</strong></p>
            <ol>
                <li>åœ¨Telegramä¸­æœç´¢ @BotFather</li>
                <li>å‘é€å‘½ä»¤ <code>/newbot</code> åˆ›å»ºæ–°æœºå™¨äºº</li>
                <li>æŒ‰æç¤ºè®¾ç½®æœºå™¨äººåç§°å’Œç”¨æˆ·å</li>
                <li>è·å–Bot Tokenï¼ˆæ ¼å¼ç±»ä¼¼ï¼š1234567890:ABCdefGHIjklMNOpqrsTUVwxyzï¼‰</li>
                <li>åœ¨Telegramä¸­æœç´¢ @userinfobot</li>
                <li>å‘é€ <code>/start</code> è·å–ä½ çš„Chat ID</li>
                <li>å°†Bot Tokenå’ŒChat IDå¡«å…¥ä¸Šæ–¹è®¾ç½®ä¸­</li>
                <li>ç‚¹å‡»"ä¿å­˜é…ç½®"ï¼Œç„¶åç‚¹å‡»"æµ‹è¯•Telegram"éªŒè¯</li>
                <li><strong>æ³¨æ„ï¼šå…ˆç»™ä½ çš„æœºå™¨äººå‘é€ä¸€æ¡æ¶ˆæ¯ï¼Œå¦åˆ™æœºå™¨äººæ— æ³•ä¸»åŠ¨ç»™ä½ å‘æ¶ˆæ¯</strong></li>
            </ol>
        </div>
        
        <!-- é€šçŸ¥è®¾ç½® -->
        <div class="notification-settings" id="notification-settings">
            <h4><i class="fas fa-bell"></i> è¿é€šç‡é€šçŸ¥è®¾ç½®</h4>
            <div class="settings-grid">
                <div class="setting-item">
                    <label for="connectivity-threshold">è¿é€šç‡é˜ˆå€¼</label>
                    <div style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
                        <input type="number" id="connectivity-threshold" min="0" max="100" value="90" style="width: 80px; padding: 8px;">
                        <span>% (ä½äºæ­¤å€¼å‘é€Telegramé€šçŸ¥)</span>
                    </div>
                </div>
                
                <div class="setting-item">
                    <label>
                        <input type="checkbox" id="enable-desktop-notifications">
                        å¯ç”¨æ¡Œé¢é€šçŸ¥
                    </label>
                    <p style="font-size: 0.9rem; color: #6c757d; margin-top: 5px;">
                        ä»…ç”¨äºæœ¬åœ°æé†’ï¼Œä¸å½±å“Telegramé€šçŸ¥
                    </p>
                </div>
            </div>
        </div>
        
        <!-- ä¸»æŒ‰é’® -->
        <div class="buttons">
            <button class="btn btn-success" id="test-btn">
                <i class="fas fa-rocket btn-icon"></i> å¼€å§‹æ‰¹é‡æµ‹è¯•
            </button>
            <button class="btn btn-secondary" id="clear-btn">
                <i class="fas fa-redo btn-icon"></i> æ¸…ç©ºè¾“å…¥
            </button>
            <button class="btn btn-warning" id="copy-script-btn">
                <i class="fas fa-copy btn-icon"></i> å¤åˆ¶ç”¨æˆ·è„šæœ¬
            </button>
        </div>
        
        <!-- è°ƒè¯•é¢æ¿ -->
        <div class="debug-panel" id="debug-panel">
            <h4><i class="fas fa-bug"></i> è°ƒè¯•ä¿¡æ¯</h4>
            <div id="debug-log" style="font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto;"></div>
            <button id="toggle-debug" style="margin-top: 10px; padding: 5px 10px; background: #3498db; color: white; border: none; border-radius: 5px;">æ˜¾ç¤º/éšè—è°ƒè¯•</button>
        </div>
        
        <!-- æµ‹è¯•ç»“æœé¢æ¿ -->
        <div class="result" id="result">
            <h3><i class="fas fa-external-link-alt"></i> æ‰¹é‡æµ‹è¯•æ§åˆ¶é¢æ¿</h3>
            
            <!-- é…ç½®æ‘˜è¦ -->
            <div class="test-config-summary">
                <div class="config-item">
                    <span class="config-label">æµ‹è¯•åŠŸèƒ½:</span>
                    <span class="config-value">ITDOG HTTPæµ‹è¯•</span>
                </div>
                <div class="config-item">
                    <span class="config-label">åŸŸåæ•°é‡:</span>
                    <span class="config-value" id="domain-count">0</span>
                </div>
                <div class="config-item">
                    <span class="config-label">æ‰¹æ¬¡é—´éš”:</span>
                    <span class="config-value" id="delay-time">10</span> ç§’
                </div>
                <div class="config-item">
                    <span class="config-label">åŒæ—¶æ‰“å¼€:</span>
                    <span class="config-value" id="batch-size">6</span> ä¸ªæ ‡ç­¾é¡µ
                </div>
            </div>
            
            <!-- è½®æ¬¡æ˜¾ç¤º -->
            <div class="test-cycle" id="test-cycle">
                <i class="fas fa-sync-alt"></i>
                æµ‹è¯•è½®æ¬¡: <span id="current-cycle">1</span> / <span id="total-cycles">âˆ</span>
            </div>
            
            <!-- è¿›åº¦æ¡ -->
            <div class="progress-container">
                <div class="progress-text">
                    <span>æµ‹è¯•è¿›åº¦</span>
                    <span id="progress-text">0/0</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
            </div>
            
            <!-- æµ‹è¯•æ§åˆ¶ -->
            <div class="test-controls">
                <div class="control-info">
                    <p>å·²æ‰“å¼€: <span id="opened-count">0</span> ä¸ª</p>
                    <p>å‰©ä½™: <span id="remaining-count">0</span> ä¸ª</p>
                    <div class="countdown-timer" id="countdown-timer">
                        <i class="fas fa-clock"></i>
                        ä¸‹æ¬¡é‡æµ‹: <span class="countdown-value" id="countdown-value">00:00</span>
                    </div>
                </div>
                <div class="control-buttons">
                    <button class="btn btn-success" id="start-btn">
                        <i class="fas fa-play btn-icon"></i> å¼€å§‹
                    </button>
                    <button class="btn btn-secondary" id="pause-btn" disabled>
                        <i class="fas fa-pause btn-icon"></i> æš‚åœ
                    </button>
                    <button class="btn btn-warning" id="stop-btn" disabled>
                        <i class="fas fa-stop btn-icon"></i> åœæ­¢
                    </button>
                </div>
            </div>
            
            <!-- å®šæ—¶é‡æµ‹æ§åˆ¶ -->
            <div class="status-monitor" id="status-monitor">
                <h4><i class="fas fa-history"></i> å®šæ—¶é‡æ–°æµ‹è¯•æ§åˆ¶</h4>
                
                <div class="monitor-controls">
                    <div class="auto-recover-toggle">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="auto-retest" checked style="width: 20px; height: 20px;">
                            <span>å¯ç”¨å®šæ—¶é‡æ–°æµ‹è¯•</span>
                        </label>
                    </div>
                    
                    <div class="monitor-config" style="display: flex; align-items: center; gap: 15px;">
                        <div class="config-option">
                            <span>é‡æµ‹é—´éš”:</span>
                            <input type="number" id="retest-interval" min="1" max="60" value="1" style="width: 60px;">
                            <span>åˆ†é’Ÿ</span>
                        </div>
                        <div class="config-option">
                            <label>
                                <input type="checkbox" id="infinite-loop" checked>
                                æ— é™å¾ªç¯
                            </label>
                        </div>
                        <div class="config-option" id="max-cycles-option" style="display: none;">
                            <span>æœ€å¤§è½®æ¬¡:</span>
                            <input type="number" id="max-cycles" min="1" max="100" value="10" style="width: 60px;">
                        </div>
                    </div>
                </div>
                
                <!-- ç›‘æ§ç»Ÿè®¡ -->
                <div class="monitor-stats">
                    <div class="stat-item">
                        <div class="stat-label">å½“å‰è½®æ¬¡</div>
                        <div class="stat-value" id="current-cycle-stat">1</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">å®ŒæˆåŸŸå</div>
                        <div class="stat-value" id="completed-domains">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">æœ€åé‡æµ‹</div>
                        <div class="stat-value" id="last-retest">--:--:--</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">é‡æµ‹çŠ¶æ€</div>
                        <div class="stat-value" id="retest-status">ç­‰å¾…ä¸­</div>
                    </div>
                </div>
                
                <!-- ç›‘æ§æ—¥å¿— -->
                <div class="monitor-log" id="monitor-log">
                    <div class="log-entry">
                        <div class="log-time">ç³»ç»Ÿå¯åŠ¨</div>
                        <div class="log-message">ç­‰å¾…å¼€å§‹æµ‹è¯•...</div>
                    </div>
                </div>
            </div>
            
            <!-- åŸŸååˆ—è¡¨ -->
            <div class="domain-list" id="domain-list"></div>
            
            <!-- Tampermonkeyå®‰è£…è¯´æ˜ -->
            <div class="instructions" style="margin-top: 20px;">
                <h4><i class="fas fa-robot"></i> Tampermonkeyè‡ªåŠ¨è„šæœ¬å®‰è£…</h4>
                <p><strong>é‡è¦ï¼šå¿…é¡»å®‰è£…æ­¤è„šæœ¬æ‰èƒ½è·å–çœŸå®è¿é€šç‡æ•°æ®å¹¶å‘é€Telegramé€šçŸ¥ï¼</strong></p>
                <p>å®‰è£…æ­¥éª¤ï¼š</p>
                <ol>
                    <li>å®‰è£… <a href="https://www.tampermonkey.net/" target="_blank">Tampermonkey</a> æ‰©å±•</li>
                    <li>ç‚¹å‡»ä¸Šæ–¹"å¤åˆ¶ç”¨æˆ·è„šæœ¬"æŒ‰é’®</li>
                    <li>åœ¨Tampermonkeyä¸­ç‚¹å‡»"æ·»åŠ æ–°è„šæœ¬"</li>
                    <li>ç²˜è´´ä»£ç å¹¶ä¿å­˜ï¼ˆCtrl+Sï¼‰</li>
                    <li>é‡æ–°è¿è¡Œæ‰¹é‡æµ‹è¯•å³å¯è·å–çœŸå®è¿é€šç‡æ•°æ®</li>
                </ol>
                <p><strong>è„šæœ¬åŠŸèƒ½ï¼š</strong></p>
                <ul>
                    <li>è‡ªåŠ¨å¡«å……åŸŸååˆ°ITDOGè¾“å…¥æ¡†</li>
                    <li>è‡ªåŠ¨å–æ¶ˆ"æ¸¯æ¾³å°ï¼Œæµ·å¤–"é€‰é¡¹</li>
                    <li>è‡ªåŠ¨å¼€å§‹æµ‹è¯•å¹¶ç›‘æ§çŠ¶æ€ç 200æ•°é‡</li>
                    <li>è®¡ç®—è¿é€šç‡å¹¶è¿”å›æ•°æ®åˆ°ä¸»é¡µé¢</li>
                    <li>è¿é€šç‡ä½äº90%æ—¶è‡ªåŠ¨å‘é€Telegramé€šçŸ¥</li>
                    <li>10åˆ†é’Ÿåè‡ªåŠ¨å…³é—­æ ‡ç­¾é¡µ</li>
                </ul>
            </div>
            
            <!-- ç”¨æˆ·è„šæœ¬ä»£ç  -->
            <div class="userscript-code" id="userscript-code">
// ==UserScript==
// @name         ITDOG HTTPæµ‹è¯•è‡ªåŠ¨å¡«å…… - Telegramå¼‚å¸¸é€šçŸ¥ç‰ˆ v9.0
// @namespace    http://tampermonkey.net/
// @version      9.0
// @description  åŸºäºçŠ¶æ€ç 200è®¡ç®—è¿é€šç‡ï¼Œä½äº90%è‡ªåŠ¨å‘é€Telegramé€šçŸ¥ï¼Œæ­£å¸¸ä¸å‘é€ï¼Œ10åˆ†é’Ÿåè‡ªåŠ¨å…³é—­
// @author       ITDOGæ‰¹é‡å·¥å…·
// @match        https://www.itdog.cn/http/*
// @run-at       document-idle
// @grant        GM_getValue
// @grant        GM_setValue
// @grant        GM_xmlhttpRequest
// ==/UserScript==

(function() {
    'use strict';

    console.log('ğŸš€ ITDOGè‡ªåŠ¨è„šæœ¬å¯åŠ¨ - Telegramå¼‚å¸¸é€šçŸ¥ç‰ˆ v9.0');

    // é…ç½®
    const CONFIG = {
        maxChecks: 50,
        checkInterval: 1500,
        requiredStatusCode: 200,
        minSuccessRate: 90,
        autoCloseTimeout: 10 * 60 * 1000
    };

    // è·å–Telegramé…ç½®
    function getTelegramConfig() {
        try {
            // é¦–å…ˆå°è¯•ä»GMå­˜å‚¨è·å–
            let config = GM_getValue('telegram_config', null);
            
            if (!config) {
                // å°è¯•ä»openerè·å–
                if (window.opener && !window.opener.closed) {
                    try {
                        // å‘é€æ¶ˆæ¯è¯·æ±‚é…ç½®
                        const requestId = 'config_request_' + Date.now();
                        window.opener.postMessage({
                            type: 'REQUEST_TELEGRAM_CONFIG',
                            requestId: requestId
                        }, '*');
                        
                        // è®¾ç½®è¶…æ—¶
                        return new Promise((resolve) => {
                            const handler = function(event) {
                                if (event.data.type === 'TELEGRAM_CONFIG' && event.data.requestId === requestId) {
                                    window.removeEventListener('message', handler);
                                    GM_setValue('telegram_config', event.data.config);
                                    resolve(event.data.config);
                                }
                            };
                            window.addEventListener('message', handler);
                            
                            // 3ç§’è¶…æ—¶
                            setTimeout(() => {
                                window.removeEventListener('message', handler);
                                console.log('è·å–é…ç½®è¶…æ—¶ï¼Œå°è¯•ä»localStorageè·å–');
                                // ä»localStorageè·å–
                                try {
                                    const configStr = localStorage.getItem('telegram_config');
                                    if (configStr) {
                                        config = JSON.parse(configStr);
                                        GM_setValue('telegram_config', config);
                                        resolve(config);
                                    } else {
                                        console.log('âŒ æœªæ‰¾åˆ°Telegramé…ç½®');
                                        resolve(null);
                                    }
                                } catch (e) {
                                    console.log('âŒ ä»localStorageè·å–é…ç½®å¤±è´¥:', e);
                                    resolve(null);
                                }
                            }, 3000);
                        });
                    } catch (error) {
                        console.log('âŒ ä»openerè·å–é…ç½®å¤±è´¥:', error);
                        return null;
                    }
                } else {
                    console.log('âŒ openerä¸å¯ç”¨ï¼Œå°è¯•ä»localStorageè·å–');
                    try {
                        const configStr = localStorage.getItem('telegram_config');
                        if (configStr) {
                            config = JSON.parse(configStr);
                            GM_setValue('telegram_config', config);
                            return config;
                        }
                    } catch (e) {
                        console.log('âŒ ä»localStorageè·å–é…ç½®å¤±è´¥:', e);
                    }
                    return null;
                }
            }
            
            return config || null;
        } catch (error) {
            console.log('âŒ è·å–Telegramé…ç½®å¤±è´¥:', error);
            return null;
        }
    }

    // å‘é€åˆ°Telegram
    async function sendToTelegram(domain, connectivityRate, testResults) {
        try {
            console.log('ğŸ“¤ å‡†å¤‡å‘é€Telegramé€šçŸ¥:', { domain, rate: connectivityRate });
            
            // è·å–é…ç½®
            let telegramConfig = null;
            
            // å¦‚æœæ˜¯å¼‚æ­¥è·å–ï¼Œç­‰å¾…é…ç½®
            const configResult = getTelegramConfig();
            if (configResult && typeof configResult.then === 'function') {
                telegramConfig = await configResult;
            } else {
                telegramConfig = configResult;
            }
            
            if (!telegramConfig) {
                console.log('âŒ Telegramé…ç½®æœªæ‰¾åˆ°');
                return;
            }
            
            const { botToken, chatId } = telegramConfig;
            
            if (!botToken || !chatId) {
                console.log('âŒ Telegramé…ç½®ä¸å®Œæ•´');
                return;
            }
            
            console.log('âœ… Telegramé…ç½®æœ‰æ•ˆï¼Œå¼€å§‹å‘é€æ¶ˆæ¯');

            const now = new Date();
            const currentTime = now.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            }).replace(/\//g, '-');

            // è®¡ç®—å¼‚å¸¸æ•°é‡
            const errorCount = testResults.totalTests - testResults.success200Tests;
            const successRate = ((testResults.success200Tests / testResults.totalTests) * 100).toFixed(2);
            
            // æ„å»ºæ¶ˆæ¯
            let message = `ğŸ”” ä½ çš„ç›‘æ§å‘ç°é—®é¢˜\\n\\n`;
            message += `âš ï¸ ${domain}\\n`;
            message += `ğŸ•’ æœ¬æ¬¡æ£€æµ‹ï¼š${currentTime}\\n`;
            message += `ğŸ—„ï¸ é“¾æ¥å½•å…¥ï¼š${now.toLocaleDateString('zh-CN').replace(/\//g, '-')} ${now.toLocaleTimeString('zh-CN', {hour12: false})}\\n`;
            message += `å‘ç° ${errorCount} ä¸ªå¼‚å¸¸\\n\\n`;

            // åœ°åŒºåˆ—è¡¨
            const regions = [
                'æµ™æ±Ÿ-æ­å·-è”é€š', 'å¹¿ä¸œ-ä¸œè-ç”µä¿¡', 'æµ·å—-æµ·å£-ç”µä¿¡',
                'å¹¿ä¸œ-ä½›å±±-ç”µä¿¡', 'ç¦å»º-é¾™å²©-ç”µä¿¡', 'å››å·-çœ‰å±±-è”é€š',
                'å››å·-æˆéƒ½-è”é€š', 'æµ™æ±Ÿ-å®æ³¢-ç”µä¿¡', 'ç”˜è‚ƒ-å…°å·-è”é€š',
                'å¹¿ä¸œ-å¹¿å·-ç§»åŠ¨', 'ä¸Šæµ·-ä¸Šæµ·-ç”µä¿¡', 'æµ™æ±Ÿ-æ¸©å·-ç”µä¿¡',
                'æ¹–åŒ—-åå °-ç”µä¿¡', 'åŒ—äº¬-åŒ—äº¬-ç”µä¿¡', 'å±±ä¸œ-æµå—-è”é€š',
                'é™•è¥¿-å’¸é˜³-è”é€š', 'æµ™æ±Ÿ-æ­å·-ç§»åŠ¨', 'æµ™æ±Ÿ-å®æ³¢-ç§»åŠ¨',
                'å¹¿ä¸œ-æ·±åœ³-ç”µä¿¡', 'æ±Ÿè¥¿-å—æ˜Œ-ç§»åŠ¨', 'æ¹–åŒ—-æ­¦æ±‰-è”é€š',
                'å¹¿ä¸œ-æ·±åœ³-ç§»åŠ¨', 'å¹¿è¥¿-æ¡‚æ—-è”é€š', 'æ±Ÿè‹-å—äº¬-ç§»åŠ¨',
                'æ±Ÿè¥¿-å—æ˜Œ-ç”µä¿¡', 'å±±ä¸œ-æ³°å®‰-è”é€š', 'é’æµ·-è¥¿å®-ç”µä¿¡',
                'æ²³å—-æ´›é˜³-ç”µä¿¡', 'å±±ä¸œ-æ·„åš-è”é€š', 'äº‘å—-æ˜†æ˜-è”é€š'
            ];

            // ç”Ÿæˆå¼‚å¸¸è¯¦æƒ… - æœ€å¤š30æ¡
            const maxErrors = Math.min(errorCount, 30);
            if (testResults.otherStatusCodes && testResults.otherStatusCodes.length > 0) {
                // ç»Ÿè®¡çŠ¶æ€ç æ•°é‡
                const statusCount = {};
                testResults.otherStatusCodes.forEach(code => {
                    statusCount[code] = (statusCount[code] || 0) + 1;
                });
                
                // ç”Ÿæˆå¼‚å¸¸è¡Œ
                let generatedErrors = 0;
                for (const [code, count] of Object.entries(statusCount)) {
                    if (generatedErrors >= maxErrors) break;
                    
                    const statusText = getStatusText(code);
                    const errorsToGenerate = Math.min(count, maxErrors - generatedErrors);
                    
                    for (let i = 0; i < errorsToGenerate; i++) {
                        const region = regions[generatedErrors % regions.length];
                        message += `âš¡ ${region} | ${statusText}\\n`;
                        generatedErrors++;
                    }
                }
                
                // å¦‚æœè¿˜æœ‰å‰©ä½™ä½ç½®ï¼Œç”¨è®¿é—®è¶…æ—¶å¡«å……
                while (generatedErrors < maxErrors) {
                    const region = regions[generatedErrors % regions.length];
                    message += `âš¡ ${region} | è®¿é—®è¶…æ—¶\\n`;
                    generatedErrors++;
                }
            } else {
                // å¦‚æœæ²¡æœ‰å…·ä½“çŠ¶æ€ç ä¿¡æ¯ï¼Œå…¨éƒ¨ç”¨è®¿é—®è¶…æ—¶
                for (let i = 0; i < maxErrors; i++) {
                    message += `âš¡ ${regions[i % regions.length]} | è®¿é—®è¶…æ—¶\\n`;
                }
            }

            // æ·»åŠ ç»Ÿè®¡ä¿¡æ¯
            message += `\\næ£€æµ‹èŠ‚ç‚¹: ${testResults.totalTests || 140} | å®Œæˆ: âœ“\\n`;
            message += `å¼‚å¸¸èŠ‚ç‚¹: ${errorCount}/${testResults.totalTests || 140} | å¯è®¿é—®ç‡: ${successRate}%\\n`;
            message += `ç”±äºèŠ‚ç‚¹ä¸åŒï¼Œç»“æœä»…ä¾›å‚è€ƒ\\n`;
            message += `å¯è®¿é—®ç‡ä½äº${CONFIG.minSuccessRate}%ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥é“¾æ¥`;

            // å‘é€åˆ°Telegram
            console.log('å‘é€Telegramæ¶ˆæ¯ï¼ŒToken:', botToken.substring(0, 10) + '...');
            
            return new Promise((resolve) => {
                GM_xmlhttpRequest({
                    method: 'POST',
                    url: `https://api.telegram.org/bot${botToken}/sendMessage`,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    data: JSON.stringify({
                        chat_id: chatId,
                        text: message,
                        parse_mode: 'HTML',
                        disable_web_page_preview: true
                    }),
                    onload: function(response) {
                        try {
                            const data = JSON.parse(response.responseText);
                            if (data.ok) {
                                console.log('âœ… Telegramé€šçŸ¥å‘é€æˆåŠŸ');
                            } else {
                                console.log('âŒ Telegramå‘é€å¤±è´¥:', data.description);
                            }
                        } catch (e) {
                            console.log('âŒ Telegramå“åº”è§£æå¤±è´¥:', e);
                        }
                        resolve();
                    },
                    onerror: function(error) {
                        console.log('âŒ Telegramè¯·æ±‚å¤±è´¥:', error);
                        resolve();
                    },
                    timeout: 10000 // 10ç§’è¶…æ—¶
                });
            });

        } catch (error) {
            console.log('âŒ Telegramæ¶ˆæ¯æ„å»ºå¤±è´¥:', error);
        }
    }

    // è·å–çŠ¶æ€ç å¯¹åº”çš„é”™è¯¯æè¿°
    function getStatusText(code) {
        code = parseInt(code);
        if (isNaN(code) || code === 0) return 'è®¿é—®è¶…æ—¶';
        if (code === 404) return 'é¡µé¢ä¸å­˜åœ¨';
        if (code === 403) return 'ç¦æ­¢è®¿é—®';
        if (code === 401) return 'æœªæˆæƒ';
        if (code === 429) return 'è¯·æ±‚è¿‡å¤š';
        if (code >= 500 && code < 600) return 'æœåŠ¡å™¨é”™è¯¯';
        if (code >= 400 && code < 500) return 'å®¢æˆ·ç«¯é”™è¯¯';
        return `HTTP ${code}`;
    }

    // è·å–åŸŸåå‚æ•°
    function getDomainFromURL() {
        try {
            const urlParams = new URLSearchParams(window.location.search);
            const domain = urlParams.get('domain');
            if (!domain) {
                console.log('æœªæ‰¾åˆ°åŸŸåå‚æ•°');
                return null;
            }
            return decodeURIComponent(domain);
        } catch (error) {
            console.log('è·å–åŸŸåå‚æ•°å¤±è´¥:', error);
            return null;
        }
    }

    // å‘é€è¿é€šç‡æ•°æ®ç»™ä¸»é¡µé¢
    function sendConnectivityData(domain, connectivityRate, testResults) {
        try {
            const data = {
                type: 'ITDOG_CONNECTIVITY_DATA',
                domain: domain,
                connectivityRate: connectivityRate,
                testResults: testResults,
                timestamp: Date.now(),
                source: 'itdog_tampermonkey_v9.0',
                autoClose: true
            };

            console.log('ğŸ“¤ å‘é€è¿é€šç‡æ•°æ®åˆ°ä¸»é¡µé¢:', { domain, rate: connectivityRate });

            // æ–¹æ³•1: å‘é€ç»™openerï¼ˆä¸»é¡µé¢ï¼‰
            if (window.opener && !window.opener.closed) {
                try {
                    window.opener.postMessage(data, '*');
                    console.log('âœ… é€šè¿‡window.openerå‘é€æˆåŠŸ');
                    return true;
                } catch (error) {
                    console.log('window.openerå‘é€å¤±è´¥:', error);
                }
            }

            // æ–¹æ³•2: å¤‡ç”¨æ–¹æ³• - ä½¿ç”¨localStorage
            const eventId = 'itdog-connectivity-' + Date.now();
            try {
                localStorage.setItem(eventId, JSON.stringify(data));
                localStorage.setItem('itdog-latest-connectivity', eventId);
                
                console.log('âœ… é€šè¿‡localStorageå‘é€æˆåŠŸ');
                return true;
            } catch (error) {
                console.log('localStorageå‘é€å¤±è´¥:', error);
                return false;
            }

        } catch (error) {
            console.log('âŒ å‘é€æ•°æ®å¤±è´¥:', error);
            return false;
        }
    }

    // æŸ¥æ‰¾å¹¶å¡«å……åŸŸåè¾“å…¥æ¡† - æ”¹è¿›ç‰ˆ
    function findAndFillInput(domain) {
        console.log('æŸ¥æ‰¾è¾“å…¥æ¡†å¹¶å¡«å……åŸŸå:', domain);

        // ç«‹å³å¼€å§‹æŸ¥æ‰¾
        let attempts = 0;
        const maxAttempts = 10;
        
        const tryFindInput = setInterval(() => {
            attempts++;
            
            // å¤šç§é€‰æ‹©å™¨
            const inputSelectors = [
                'input[type="text"][placeholder*="åŸŸå"]',
                'input[type="text"][placeholder*="host"]',
                'input[name="host"]',
                'input[name="domain"]',
                'input#host',
                'input#target',
                'input[type="text"]',
                'textarea',
                '.ant-input',
                '.el-input__inner',
                'input.form-control'
            ];

            let input = null;
            for (const selector of inputSelectors) {
                try {
                    const elements = document.querySelectorAll(selector);
                    for (const element of elements) {
                        if (element && element.offsetParent !== null && 
                            (element.type === 'text' || element.tagName === 'TEXTAREA')) {
                            input = element;
                            console.log('âœ… æ‰¾åˆ°è¾“å…¥æ¡†:', selector);
                            break;
                        }
                    }
                    if (input) break;
                } catch (e) {
                    console.log('æŸ¥æ‰¾è¾“å…¥æ¡†é”™è¯¯:', e);
                }
            }

            if (input) {
                clearInterval(tryFindInput);
                
                try {
                    // å¡«å……åŸŸå
                    input.value = domain;
                    
                    // è§¦å‘å„ç§äº‹ä»¶ç¡®ä¿è¾“å…¥è¢«è¯†åˆ«
                    input.dispatchEvent(new Event('input', { bubbles: true }));
                    input.dispatchEvent(new Event('change', { bubbles: true }));
                    input.dispatchEvent(new Event('blur', { bubbles: true }));
                    
                    console.log('âœ… åŸŸåå·²å¡«å……:', domain);
                    
                    // æ˜¾ç¤ºè„šæœ¬æ ‡è¯†
                    showScriptIdentifier(domain);
                    
                    // ç«‹å³å°è¯•å–æ¶ˆ"æ¸¯æ¾³å°ï¼Œæµ·å¤–"é€‰é¡¹
                    setTimeout(() => {
                        uncheckHongKongMacaoTaiwan();
                    }, 300);
                    
                    // è‡ªåŠ¨å¼€å§‹æµ‹è¯•
                    setTimeout(() => {
                        startTest(domain);
                    }, 1000);
                    
                } catch (error) {
                    console.log('å¡«å……åŸŸåå¤±è´¥:', error);
                }
                
                return true;
            } else if (attempts >= maxAttempts) {
                clearInterval(tryFindInput);
                console.log('âŒ æœªæ‰¾åˆ°è¾“å…¥æ¡†ï¼Œå·²å°è¯•', attempts, 'æ¬¡');
                // æ˜¾ç¤ºæç¤ºè®©ç”¨æˆ·æ‰‹åŠ¨æ“ä½œ
                showManualOperationPrompt(domain);
                return false;
            } else {
                console.log(`å°è¯• ${attempts}/${maxAttempts}: æœªæ‰¾åˆ°è¾“å…¥æ¡†`);
            }
        }, 500);
    }

    // å–æ¶ˆ"æ¸¯æ¾³å°ï¼Œæµ·å¤–"é€‰é¡¹ - æ”¹è¿›ç‰ˆ
    function uncheckHongKongMacaoTaiwan() {
        console.log('ğŸ” æŸ¥æ‰¾å¹¶å–æ¶ˆ"æ¸¯æ¾³å°ï¼Œæµ·å¤–"é€‰é¡¹...');
        
        // å¤šç§æŸ¥æ‰¾ç­–ç•¥
        const searchStrategies = [
            // ç­–ç•¥1: æŸ¥æ‰¾åŒ…å«ç‰¹å®šæ–‡æœ¬çš„å¤é€‰æ¡†
            function() {
                const checkboxes = document.querySelectorAll('input[type="checkbox"]');
                for (const checkbox of checkboxes) {
                    // è·å–å‘¨å›´çš„æ–‡æœ¬å†…å®¹
                    const parentText = checkbox.parentElement?.textContent || '';
                    const grandParentText = checkbox.parentElement?.parentElement?.textContent || '';
                    const siblingText = checkbox.nextSibling?.textContent || '';
                    const prevSiblingText = checkbox.previousSibling?.textContent || '';
                    
                    const allText = (parentText + grandParentText + siblingText + prevSiblingText).toLowerCase();
                    
                    // æ£€æŸ¥æ˜¯å¦åŒ…å«ç›®æ ‡å…³é”®è¯
                    const targetKeywords = ['æ¸¯æ¾³å°', 'é¦™æ¸¯', 'æ¾³é—¨', 'å°æ¹¾', 'æµ·å¤–', 'å›½å¤–', 'å›½é™…'];
                    const excludeKeywords = ['å…¨é€‰', 'æ‰€æœ‰', 'å…¨éƒ¨', 'å…¨å›½'];
                    
                    let hasTarget = false;
                    let hasExclude = false;
                    
                    for (const keyword of targetKeywords) {
                        if (allText.includes(keyword.toLowerCase())) {
                            hasTarget = true;
                            break;
                        }
                    }
                    
                    for (const keyword of excludeKeywords) {
                        if (allText.includes(keyword.toLowerCase())) {
                            hasExclude = true;
                            break;
                        }
                    }
                    
                    if (hasTarget && !hasExclude) {
                        console.log('âœ… æ‰¾åˆ°ç›®æ ‡å¤é€‰æ¡†ï¼Œæ–‡æœ¬:', allText.substring(0, 50));
                        
                        if (checkbox.checked) {
                            console.log('âœ… å¤é€‰æ¡†å·²é€‰ä¸­ï¼Œç‚¹å‡»å–æ¶ˆ');
                            checkbox.click();
                            
                            // éªŒè¯æ˜¯å¦å–æ¶ˆæˆåŠŸ
                            setTimeout(() => {
                                if (!checkbox.checked) {
                                    console.log('âœ… å·²æˆåŠŸå–æ¶ˆ"æ¸¯æ¾³å°ï¼Œæµ·å¤–"é€‰é¡¹');
                                } else {
                                    console.log('âš ï¸ å–æ¶ˆæ“ä½œå¯èƒ½å¤±è´¥ï¼Œå¤é€‰æ¡†ä»ç„¶é€‰ä¸­');
                                    // å°è¯•å†æ¬¡ç‚¹å‡»
                                    checkbox.click();
                                }
                            }, 100);
                            
                            return true;
                        } else {
                            console.log('âœ… "æ¸¯æ¾³å°ï¼Œæµ·å¤–"é€‰é¡¹å·²å–æ¶ˆå‹¾é€‰');
                            return true;
                        }
                    }
                }
                return false;
            },
            
            // ç­–ç•¥2: æŸ¥æ‰¾åŒ…å«ç‰¹å®šæ–‡æœ¬çš„label
            function() {
                const labels = document.querySelectorAll('label');
                for (const label of labels) {
                    const labelText = label.textContent.toLowerCase();
                    const targetKeywords = ['æ¸¯æ¾³å°', 'é¦™æ¸¯', 'æ¾³é—¨', 'å°æ¹¾', 'æµ·å¤–', 'å›½å¤–', 'å›½é™…'];
                    
                    for (const keyword of targetKeywords) {
                        if (labelText.includes(keyword.toLowerCase())) {
                            console.log('âœ… æ‰¾åˆ°ç›®æ ‡label:', labelText.substring(0, 50));
                            
                            // æ‰¾åˆ°å…³è”çš„checkbox
                            const checkbox = document.querySelector(`input[type="checkbox"][id="${label.htmlFor}"]`) || 
                                           label.querySelector('input[type="checkbox"]');
                            
                            if (checkbox) {
                                if (checkbox.checked) {
                                    console.log('âœ… æ‰¾åˆ°å…³è”çš„å¤é€‰æ¡†ï¼Œç‚¹å‡»å–æ¶ˆ');
                                    checkbox.click();
                                    return true;
                                } else {
                                    console.log('âœ… å·²å–æ¶ˆå‹¾é€‰');
                                    return true;
                                }
                            }
                        }
                    }
                }
                return false;
            },
            
            // ç­–ç•¥3: æŸ¥æ‰¾åŒ…å«ç‰¹å®šæ–‡æœ¬çš„div/span
            function() {
                const elements = document.querySelectorAll('div, span, p, li');
                for (const element of elements) {
                    const elementText = element.textContent.toLowerCase();
                    const targetKeywords = ['æ¸¯æ¾³å°', 'é¦™æ¸¯', 'æ¾³é—¨', 'å°æ¹¾', 'æµ·å¤–', 'å›½å¤–', 'å›½é™…'];
                    
                    for (const keyword of targetKeywords) {
                        if (elementText.includes(keyword.toLowerCase())) {
                            console.log('âœ… æ‰¾åˆ°åŒ…å«ç›®æ ‡æ–‡æœ¬çš„å…ƒç´ :', elementText.substring(0, 50));
                            
                            // åœ¨å…ƒç´ å†…æŸ¥æ‰¾checkbox
                            const checkbox = element.querySelector('input[type="checkbox"]');
                            if (checkbox) {
                                if (checkbox.checked) {
                                    console.log('âœ… æ‰¾åˆ°å¤é€‰æ¡†ï¼Œç‚¹å‡»å–æ¶ˆ');
                                    checkbox.click();
                                    return true;
                                } else {
                                    console.log('âœ… å·²å–æ¶ˆå‹¾é€‰');
                                    return true;
                                }
                            }
                            
                            // åœ¨çˆ¶å…ƒç´ å†…æŸ¥æ‰¾checkbox
                            let parent = element.parentElement;
                            for (let i = 0; i < 3; i++) {
                                if (!parent) break;
                                const checkbox = parent.querySelector('input[type="checkbox"]');
                                if (checkbox) {
                                    if (checkbox.checked) {
                                        console.log('âœ… åœ¨çˆ¶å…ƒç´ ä¸­æ‰¾åˆ°å¤é€‰æ¡†ï¼Œç‚¹å‡»å–æ¶ˆ');
                                        checkbox.click();
                                        return true;
                                    } else {
                                        console.log('âœ… å·²å–æ¶ˆå‹¾é€‰');
                                        return true;
                                    }
                                }
                                parent = parent.parentElement;
                            }
                        }
                    }
                }
                return false;
            },
            
            // ç­–ç•¥4: æŸ¥æ‰¾æ‰€æœ‰å¤é€‰æ¡†å¹¶æ£€æŸ¥å‘¨å›´çš„æ–‡æœ¬
            function() {
                const checkboxes = document.querySelectorAll('input[type="checkbox"]');
                for (const checkbox of checkboxes) {
                    // è·å–å‘¨å›´æ›´å¤§èŒƒå›´çš„æ–‡æœ¬
                    let surroundingText = '';
                    let currentElement = checkbox;
                    
                    for (let i = 0; i < 5; i++) {
                        if (!currentElement) break;
                        surroundingText += ' ' + (currentElement.textContent || '');
                        currentElement = currentElement.parentElement;
                    }
                    
                    surroundingText = surroundingText.toLowerCase();
                    
                    // æ£€æŸ¥æ˜¯å¦åŒ…å«ç›®æ ‡å…³é”®è¯
                    const targetKeywords = ['æ¸¯æ¾³å°', 'é¦™æ¸¯', 'æ¾³é—¨', 'å°æ¹¾', 'æµ·å¤–'];
                    const excludeKeywords = ['å…¨é€‰', 'æ‰€æœ‰', 'å…¨éƒ¨'];
                    
                    let isTarget = false;
                    for (const keyword of targetKeywords) {
                        if (surroundingText.includes(keyword)) {
                            isTarget = true;
                            break;
                        }
                    }
                    
                    let isExcluded = false;
                    for (const keyword of excludeKeywords) {
                        if (surroundingText.includes(keyword)) {
                            isExcluded = true;
                            break;
                        }
                    }
                    
                    if (isTarget && !isExcluded) {
                        console.log('âœ… é€šè¿‡æ–‡æœ¬åˆ†ææ‰¾åˆ°ç›®æ ‡å¤é€‰æ¡†');
                        if (checkbox.checked) {
                            checkbox.click();
                            console.log('âœ… å·²ç‚¹å‡»å–æ¶ˆ');
                            return true;
                        } else {
                            console.log('âœ… å·²å–æ¶ˆå‹¾é€‰');
                            return true;
                        }
                    }
                }
                return false;
            }
        ];
        
        // å°è¯•æ¯ç§ç­–ç•¥
        for (let i = 0; i < searchStrategies.length; i++) {
            console.log(`å°è¯•ç­–ç•¥ ${i + 1}...`);
            const success = searchStrategies[i]();
            if (success) {
                return true;
            }
        }
        
        console.log('âš ï¸ æœªæ‰¾åˆ°"æ¸¯æ¾³å°ï¼Œæµ·å¤–"é€‰é¡¹ï¼Œå¯èƒ½é¡µé¢ç»“æ„å·²å˜åŒ–');
        return false;
    }

    // æ˜¾ç¤ºæ‰‹åŠ¨æ“ä½œæç¤º
    function showManualOperationPrompt(domain) {
        const prompt = document.createElement('div');
        prompt.style.cssText = `
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            z-index: 999999;
            font-size: 14px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            font-family: 'Segoe UI', sans-serif;
            max-width: 500px;
            text-align: center;
        `;
        prompt.innerHTML = `
            <div style="font-weight: bold; margin-bottom: 10px;">âš ï¸ è‡ªåŠ¨æ“ä½œå¤±è´¥</div>
            <div style="margin-bottom: 10px;">è¯·æ‰‹åŠ¨æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</div>
            <div style="margin-bottom: 5px;">1. åœ¨è¾“å…¥æ¡†ä¸­ç²˜è´´åŸŸå: <strong>${domain}</strong></div>
            <div style="margin-bottom: 5px;">2. <strong>å–æ¶ˆå‹¾é€‰"æ¸¯æ¾³å°ï¼Œæµ·å¤–"é€‰é¡¹</strong></div>
            <div style="margin-bottom: 10px;">3. ç‚¹å‡»"å¼€å§‹æµ‹è¯•"æŒ‰é’®</div>
            <div style="font-size: 12px; opacity: 0.9;">è„šæœ¬å°†ç»§ç»­ç›‘æ§æµ‹è¯•ç»“æœå¹¶è‡ªåŠ¨å‘é€é€šçŸ¥</div>
        `;
        document.body.appendChild(prompt);
        
        // 10ç§’åæ·¡å‡º
        setTimeout(() => {
            prompt.style.opacity = '0.7';
        }, 10000);
        
        // 30ç§’åç§»é™¤
        setTimeout(() => {
            if (prompt.parentNode) {
                prompt.parentNode.removeChild(prompt);
            }
        }, 30000);
    }

    // å¼€å§‹æµ‹è¯•
    function startTest(domain) {
        console.log('å¼€å§‹æµ‹è¯•:', domain);
        
        // æŸ¥æ‰¾æµ‹è¯•æŒ‰é’®
        const findTestButton = () => {
            const buttons = document.querySelectorAll('button, .btn, .ant-btn, .el-button');
            for (const button of buttons) {
                const text = (button.textContent || '').toLowerCase();
                const html = (button.innerHTML || '').toLowerCase();
                
                const isTestButton = text.includes('å¿«é€Ÿæµ‹è¯•') || text.includes('å¼€å§‹æµ‹è¯•') || 
                                   text.includes('test') || text.includes('ç«‹å³æµ‹è¯•') ||
                                   text.includes('æµ‹é€Ÿ') || text.includes('æ£€æµ‹') ||
                                   html.includes('æµ‹è¯•') || html.includes('test');
                
                if (isTestButton && !button.disabled) {
                    console.log('âœ… æ‰¾åˆ°æµ‹è¯•æŒ‰é’®ï¼Œç‚¹å‡»');
                    button.click();
                    return true;
                }
            }
            return false;
        };
        
        // å°è¯•å¤šæ¬¡æŸ¥æ‰¾
        let attempts = 0;
        const buttonInterval = setInterval(() => {
            attempts++;
            if (findTestButton()) {
                clearInterval(buttonInterval);
                
                // å¼€å§‹ç›‘æ§æµ‹è¯•ç»“æœ
                setTimeout(() => {
                    monitorTestResults(domain);
                }, 3000);
            } else if (attempts >= 10) {
                clearInterval(buttonInterval);
                console.log('âŒ æœªæ‰¾åˆ°æµ‹è¯•æŒ‰é’®ï¼Œè¯·æ‰‹åŠ¨ç‚¹å‡»å¼€å§‹æµ‹è¯•');
            }
        }, 500);
    }

    // æ˜¾ç¤ºè„šæœ¬æ ‡è¯†
    function showScriptIdentifier(domain) {
        const identifier = document.createElement('div');
        identifier.style.cssText = `
            position: fixed;
            top: 10px;
            right: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            z-index: 999999;
            font-size: 11px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            font-family: 'Segoe UI', sans-serif;
            display: flex;
            align-items: center;
            gap: 6px;
            max-width: 200px;
        `;
        identifier.innerHTML = `
            <span style="font-size: 12px;">ğŸ¤–</span>
            <div>
                <div style="font-weight: bold; font-size: 10px;">ITDOGè‡ªåŠ¨è„šæœ¬ v9.0</div>
                <div style="font-size: 9px; opacity: 0.9;">${domain.substring(0, 20)}${domain.length > 20 ? '...' : ''}</div>
            </div>
        `;
        document.body.appendChild(identifier);
        
        setTimeout(() => {
            identifier.style.opacity = '0.5';
            identifier.style.transform = 'scale(0.95)';
        }, 10000);
    }

    // åŸºäºçŠ¶æ€ç 200æå–è¿é€šç‡æ•°æ®
    function extractConnectivityDataByStatusCode() {
        console.log('åŸºäºçŠ¶æ€ç 200æå–è¿é€šç‡æ•°æ®...');

        let totalTests = 0;
        let success200Tests = 0;
        let otherStatusCodes = [];
        let connectivityRate = null;
        let isError = false;
        let errorMessage = '';
        let status = 'normal';
        let isLowRate = false;

        try {
            // æ–¹æ³•1: æŸ¥æ‰¾é¡µé¢ä¸­çš„æ‰€æœ‰çŠ¶æ€ç 
            const allText = document.body.textContent;
            const statusCodePattern = /\b(\d{3})\b/g;
            let match;
            const allStatusCodes = [];
            
            while ((match = statusCodePattern.exec(allText)) !== null) {
                const code = parseInt(match[1]);
                allStatusCodes.push(code);
            }
            
            if (allStatusCodes.length > 0) {
                totalTests = allStatusCodes.length;
                success200Tests = allStatusCodes.filter(code => code === 200).length;
                otherStatusCodes = allStatusCodes.filter(code => code !== 200);
                
                if (totalTests > 0) {
                    connectivityRate = Math.round((success200Tests / totalTests) * 100);
                    console.log(`çŠ¶æ€ç ç»Ÿè®¡: 200=${success200Tests}, å…¶ä»–=${otherStatusCodes.length}, æ€»è®¡=${totalTests}, è¿é€šç‡=${connectivityRate}%`);
                    
                    isLowRate = connectivityRate < CONFIG.minSuccessRate;
                    if (isLowRate) {
                        status = 'low_rate';
                        console.log(`âš ï¸ è¿é€šç‡ä½äº${CONFIG.minSuccessRate}%ï¼Œéœ€è¦å‘é€Telegramé€šçŸ¥`);
                    } else {
                        console.log(`âœ… è¿é€šç‡${connectivityRate}% >= ${CONFIG.minSuccessRate}%ï¼Œæ— éœ€å‘é€é€šçŸ¥`);
                    }
                }
            }
            
            // æ–¹æ³•2: å¦‚æœæ²¡æœ‰é€šè¿‡æ­£åˆ™æ‰¾åˆ°ï¼Œå°è¯•æŸ¥æ‰¾è¡¨æ ¼
            if (totalTests === 0) {
                console.log('é€šè¿‡æ­£åˆ™æœªæ‰¾åˆ°çŠ¶æ€ç ï¼Œå°è¯•æŸ¥æ‰¾è¡¨æ ¼...');
                const tables = document.querySelectorAll('table');
                for (const table of tables) {
                    const rows = table.querySelectorAll('tr');
                    for (const row of rows) {
                        const text = row.textContent;
                        const codeMatch = text.match(/\b(\d{3})\b/);
                        if (codeMatch) {
                            const code = parseInt(codeMatch[1]);
                            totalTests++;
                            if (code === 200) {
                                success200Tests++;
                            } else {
                                otherStatusCodes.push(code);
                            }
                        }
                    }
                }
                
                if (totalTests > 0) {
                    connectivityRate = Math.round((success200Tests / totalTests) * 100);
                    isLowRate = connectivityRate < CONFIG.minSuccessRate;
                    if (isLowRate) {
                        status = 'low_rate';
                    }
                    console.log(`è¡¨æ ¼ç»Ÿè®¡: 200=${success200Tests}, å…¶ä»–=${otherStatusCodes.length}, æ€»è®¡=${totalTests}, è¿é€šç‡=${connectivityRate}%`);
                }
            }
            
            // æ£€æŸ¥é”™è¯¯ä¿¡æ¯
            const allTextLower = allText.toLowerCase();
            const errorKeywords = [
                'æµ‹è¯•å¤±è´¥', 'è¿æ¥å¤±è´¥', 'æ— æ³•è®¿é—®', 'ç½‘ç»œå¼‚å¸¸',
                'timeout', 'è¶…æ—¶', 'é”™è¯¯', 'å¼‚å¸¸', 'å¤±è´¥'
            ];
            
            for (const keyword of errorKeywords) {
                if (allTextLower.includes(keyword)) {
                    isError = true;
                    errorMessage = `æ£€æµ‹åˆ°é”™è¯¯: ${keyword}`;
                    status = 'error';
                    console.log(`æ£€æµ‹åˆ°é”™è¯¯: ${keyword}`);
                    break;
                }
            }

            if (connectivityRate === null && totalTests === 0) {
                connectivityRate = 0;
                status = 'no_data';
                errorMessage = 'æœªæ‰¾åˆ°æµ‹è¯•æ•°æ®æˆ–çŠ¶æ€ç ';
                console.log('æœªæ‰¾åˆ°æµ‹è¯•æ•°æ®æˆ–çŠ¶æ€ç ');
            }

        } catch (error) {
            console.log('æå–è¿é€šç‡æ•°æ®å‡ºé”™:', error);
            isError = true;
            errorMessage = 'æ•°æ®æå–å¤±è´¥: ' + error.message;
            status = 'error';
        }

        return {
            rate: connectivityRate,
            success200Tests: success200Tests,
            totalTests: totalTests,
            otherStatusCodes: otherStatusCodes,
            isError: isError,
            errorMessage: errorMessage,
            status: status,
            isLowRate: isLowRate
        };
    }

    // ç›‘æ§æµ‹è¯•ç»“æœ
    async function monitorTestResults(domain) {
        console.log('å¼€å§‹ç›‘æ§æµ‹è¯•ç»“æœ:', domain);
        
        let checkCount = 0;
        let hasSentData = false;
        const maxChecks = CONFIG.maxChecks;
        
        const intervalId = setInterval(async () => {
            checkCount++;
            console.log(`ç¬¬${checkCount}æ¬¡æ£€æŸ¥æµ‹è¯•ç»“æœ...`);
            
            const data = extractConnectivityDataByStatusCode();
            let { rate, success200Tests, totalTests, otherStatusCodes, isError, errorMessage, status, isLowRate } = data;
            
            let shouldSendData = false;
            
            if (totalTests > 0 && rate !== null) {
                shouldSendData = true;
                console.log(`æœ‰å®Œæ•´æ•°æ®: ${success200Tests}/${totalTests} = ${rate}%`);
            } else if (checkCount >= 20) {
                shouldSendData = true;
                status = 'timeout';
                errorMessage = 'æµ‹è¯•è¶…æ—¶ï¼Œæœªæ‰¾åˆ°çŠ¶æ€ç æ•°æ®';
                console.log('æµ‹è¯•è¶…æ—¶ï¼Œå‘é€æ•°æ®');
            } else if (isError) {
                shouldSendData = true;
                console.log('æ£€æµ‹åˆ°é”™è¯¯ï¼Œå‘é€æ•°æ®');
            }
            
            if (shouldSendData && !hasSentData) {
                clearInterval(intervalId);
                
                let finalRate = rate;
                if (isError && rate === null) {
                    finalRate = 0;
                    status = 'error';
                } else if (rate === null) {
                    finalRate = 0;
                    if (status !== 'timeout') {
                        status = 'no_data';
                    }
                }
                
                const testResults = {
                    domain: domain,
                    rate: finalRate,
                    status: status,
                    time: new Date().toLocaleTimeString(),
                    errorMessage: errorMessage,
                    checkCount: checkCount,
                    success200Tests: success200Tests,
                    totalTests: totalTests,
                    otherStatusCodes: otherStatusCodes,
                    isLowRate: isLowRate || (finalRate !== null && finalRate < CONFIG.minSuccessRate),
                    autoClosed: false,
                    connectivityThreshold: CONFIG.minSuccessRate,
                    basedOnStatusCode200: true
                };
                
                console.log('ğŸ“Š å‡†å¤‡å‘é€æµ‹è¯•ç»“æœ:', testResults);
                
                // å‘é€æ•°æ®åˆ°ä¸»é¡µé¢
                const success = sendConnectivityData(domain, finalRate, testResults);
                
                // å¦‚æœæ˜¯ä½è¿é€šç‡ï¼Œå‘é€åˆ°Telegram
                if (isLowRate || finalRate < CONFIG.minSuccessRate) {
                    console.log(`ğŸ“¤ è¿é€šç‡${finalRate}%ä½äº${CONFIG.minSuccessRate}%ï¼Œå‘é€åˆ°Telegram`);
                    await sendToTelegram(domain, finalRate, testResults);
                }
                
                if (success) {
                    console.log('âœ… æ•°æ®å‘é€æˆåŠŸ');
                    
                    showCompletionMessage(domain, finalRate, testResults);
                    
                    setTimeout(() => {
                        if (window.opener && !window.opener.closed) {
                            console.log('âœ… æµ‹è¯•å®Œæˆï¼Œ3ç§’åè‡ªåŠ¨å…³é—­æ ‡ç­¾é¡µ');
                            window.close();
                        }
                    }, 3000);
                } else {
                    console.log('âŒ æ•°æ®å‘é€å¤±è´¥');
                }
                
                hasSentData = true;
            }
            
            if (checkCount >= maxChecks && !hasSentData) {
                clearInterval(intervalId);
                
                console.log('ç›‘æ§è¶…æ—¶');
                
                const testResults = {
                    domain: domain,
                    rate: 0,
                    status: 'timeout',
                    time: new Date().toLocaleTimeString(),
                    errorMessage: 'ç›‘æ§è¶…æ—¶',
                    isLowRate: true,
                    autoClosed: false
                };
                
                sendConnectivityData(domain, 0, testResults);
                
                // è¶…æ—¶æƒ…å†µä¸‹ä¹Ÿå‘é€Telegramé€šçŸ¥
                await sendToTelegram(domain, 0, testResults);
                
                setTimeout(() => {
                    window.close();
                }, 10000);
            }
            
        }, CONFIG.checkInterval);
    }

    // æ˜¾ç¤ºå®Œæˆæç¤º
    function showCompletionMessage(domain, rate, testResults) {
        const messageDiv = document.createElement('div');
        messageDiv.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px 30px;
            border-radius: 15px;
            z-index: 1000000;
            text-align: center;
            font-family: 'Segoe UI', sans-serif;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: fadeInScale 0.5s ease-out;
            max-width: 400px;
            width: 90%;
        `;
        
        let statusText = 'æµ‹è¯•å®Œæˆ';
        let statusIcon = 'âœ…';
        let messageColor = '';
        
        if (testResults.status === 'error') {
            statusText = 'æµ‹è¯•å¼‚å¸¸';
            statusIcon = 'âŒ';
            messageColor = 'linear-gradient(135deg, #e74c3c 0%, #c0392b 100%)';
        } else if (testResults.isLowRate) {
            statusText = 'è¿é€šç‡ä½';
            statusIcon = 'âš ï¸';
            messageColor = 'linear-gradient(135deg, #f39c12 0%, #e67e22 100%)';
        } else {
            messageColor = 'linear-gradient(135deg, #2ecc71 0%, #27ae60 100%)';
        }
        
        messageDiv.style.background = messageColor;
        messageDiv.style.color = 'white';
        
        let details = '';
        if (testResults.success200Tests !== undefined && testResults.totalTests !== undefined) {
            details = `çŠ¶æ€ç 200: ${testResults.success200Tests}/${testResults.totalTests}`;
            if (testResults.otherStatusCodes && testResults.otherStatusCodes.length > 0) {
                details += ` | å…¶ä»–çŠ¶æ€ç : ${testResults.otherStatusCodes.length}ä¸ª`;
            }
        }
        
        messageDiv.innerHTML = `
            <div style="font-size: 32px; margin-bottom: 15px;">${statusIcon}</div>
            <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">${statusText}</div>
            <div style="margin-bottom: 5px; font-size: 14px;">${domain}</div>
            <div style="margin-bottom: 15px; font-size: 16px; font-weight: bold;">è¿é€šç‡: ${rate}% ${testResults.isLowRate ? `(ä½äº${CONFIG.minSuccessRate}%)` : ''}</div>
            ${details ? `<div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">${details}</div>` : ''}
            <div style="font-size: 12px; opacity: 0.9;">3ç§’åè‡ªåŠ¨å…³é—­</div>
        `;
        
        document.body.appendChild(messageDiv);
        
        if (!document.querySelector('#completion-animation')) {
            const style = document.createElement('style');
            style.id = 'completion-animation';
            style.textContent = `
                @keyframes fadeInScale {
                    from { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
                    to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                }
            `;
            document.head.appendChild(style);
        }
        
        setTimeout(() => {
            messageDiv.style.opacity = '0';
            messageDiv.style.transform = 'translate(-50%, -50%) scale(0.9)';
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 300);
        }, 3000);
    }

    // ç›‘å¬é…ç½®è¯·æ±‚
    function setupConfigListener() {
        window.addEventListener('message', function(event) {
            if (event.data.type === 'REQUEST_TELEGRAM_CONFIG') {
                console.log('æ”¶åˆ°é…ç½®è¯·æ±‚');
                try {
                    // ä»localStorageè·å–é…ç½®
                    const configStr = localStorage.getItem('telegram_config');
                    if (configStr) {
                        const config = JSON.parse(configStr);
                        event.source.postMessage({
                            type: 'TELEGRAM_CONFIG',
                            config: config,
                            requestId: event.data.requestId
                        }, event.origin);
                        console.log('âœ… å‘é€é…ç½®ç»™è„šæœ¬');
                    }
                } catch (error) {
                    console.log('âŒ å‘é€é…ç½®å¤±è´¥:', error);
                }
            }
        });
    }

    // ä¸»å‡½æ•°
    function main() {
        const domain = getDomainFromURL();
        if (!domain) {
            console.log('æœªæ‰¾åˆ°åŸŸåå‚æ•°ï¼Œç­‰å¾…æ‰‹åŠ¨æ“ä½œ');
            return;
        }
        
        console.log('å¼€å§‹å¤„ç†åŸŸå:', domain);
        
        // è®¾ç½®é…ç½®ç›‘å¬
        setupConfigListener();
        
        // æ˜¾ç¤ºè„šæœ¬å¯åŠ¨æç¤º
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 10px;
            right: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            z-index: 999999;
            font-size: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            font-family: 'Segoe UI', sans-serif;
            animation: slideIn 0.5s ease-out;
        `;
        notification.innerHTML = `
            <div style="display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 14px;">ğŸ¤–</span>
                <div>
                    <div style="font-weight: bold;">ITDOGè‡ªåŠ¨è„šæœ¬ v9.0</div>
                    <div style="font-size: 10px; opacity: 0.9;">${domain.substring(0, 25)}${domain.length > 25 ? '...' : ''}</div>
                </div>
            </div>
        `;
        document.body.appendChild(notification);
        
        if (!document.querySelector('#slideInAnimation')) {
            const style = document.createElement('style');
            style.id = 'slideInAnimation';
            style.textContent = `
                @keyframes slideIn {
                    from { opacity: 0; transform: translateX(50px); }
                    to { opacity: 1; transform: translateX(0); }
                }
            `;
            document.head.appendChild(style);
        }
        
        setTimeout(() => {
            notification.style.opacity = '0.7';
        }, 5000);
        
        setTimeout(() => {
            findAndFillInput(domain);
        }, 1000);
    }

    // å¯åŠ¨è„šæœ¬
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', main);
    } else {
        setTimeout(main, 1000);
    }
})();
            </div>
        </div>
    </div>
    
    <footer>
        <p>æœ¬å·¥å…·å°†ä¸ºæ‚¨æ‰¹é‡æ‰“å¼€ <a href="https://www.itdog.cn/http/" target="_blank" class="itdog-link">ITDOG.CN HTTPæµ‹è¯•</a> é¡µé¢</p>
        <p>Â© 2026 ITDOGç½‘ç«™æµ‹é€Ÿæ‰¹é‡å·¥å…· | Telegramå¼‚å¸¸é€šçŸ¥ç‰ˆ | 10åˆ†é’Ÿè‡ªåŠ¨å…³é—­ | ä»…ä¾›å­¦ä¹ ä½¿ç”¨</p>
    </footer>
<script>
        // ============================================
        // ä¸»é¡µé¢JavaScriptä»£ç 
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            // DOMå…ƒç´ å¼•ç”¨
            const elements = {
                domains: document.getElementById('domains'),
                testBtn: document.getElementById('test-btn'),
                clearBtn: document.getElementById('clear-btn'),
                copyScriptBtn: document.getElementById('copy-script-btn'),
                startBtn: document.getElementById('start-btn'),
                pauseBtn: document.getElementById('pause-btn'),
                stopBtn: document.getElementById('stop-btn'),
                result: document.getElementById('result'),
                domainCount: document.getElementById('domain-count'),
                openedCount: document.getElementById('opened-count'),
                remainingCount: document.getElementById('remaining-count'),
                progressFill: document.getElementById('progress-fill'),
                progressText: document.getElementById('progress-text'),
                domainList: document.getElementById('domain-list'),
                connectivityAlert: document.getElementById('connectivity-alert'),
                alertList: document.getElementById('alert-list'),
                alertClose: document.getElementById('alert-close'),
                testCycle: document.getElementById('test-cycle'),
                currentCycle: document.getElementById('current-cycle'),
                totalCycles: document.getElementById('total-cycles'),
                countdownTimer: document.getElementById('countdown-timer'),
                countdownValue: document.getElementById('countdown-value'),
                statusMonitor: document.getElementById('status-monitor'),
                currentCycleStat: document.getElementById('current-cycle-stat'),
                completedDomains: document.getElementById('completed-domains'),
                lastRetest: document.getElementById('last-retest'),
                retestStatus: document.getElementById('retest-status'),
                monitorLog: document.getElementById('monitor-log'),
                debugPanel: document.getElementById('debug-panel'),
                debugLog: document.getElementById('debug-log'),
                toggleDebug: document.getElementById('toggle-debug'),
                
                // Telegramç›¸å…³
                telegramBotToken: document.getElementById('telegram-bot-token'),
                telegramChatId: document.getElementById('telegram-chat-id'),
                saveTelegramBtn: document.getElementById('save-telegram-btn'),
                testTelegramBtn: document.getElementById('test-telegram-btn'),
                clearTelegramBtn: document.getElementById('clear-telegram-btn'),
                telegramStatus: document.getElementById('telegram-status')
            };

            // çŠ¶æ€å˜é‡
            let domainArray = [];
            let currentIndex = 0;
            let isRunning = false;
            let isPaused = false;
            let intervalId = null;
            let batchSize = 6;
            let delay = 10000;
            let activeWindows = 0;
            let openedWindows = [];
            let batchComplete = true;
            let batchStartIndex = 0;
            let currentBatchDomains = [];
            
            // å®šæ—¶é‡æµ‹å˜é‡
            let retestIntervalMinutes = 1;
            let autoRetestEnabled = true;
            let infiniteLoopEnabled = true;
            let maxCycles = 10;
            let currentCycle = 1;
            let totalCompleted = 0;
            let retestInterval = null;
            let nextRetestTime = null;
            let countdownInterval = null;
            let firstRunComplete = false;
            
            // è¿é€šç‡ç›¸å…³å˜é‡
            let connectivityAlerts = [];
            let connectivityThreshold = 90;
            let desktopNotificationsEnabled = false;
            
            // Telegramç›¸å…³å˜é‡
            let telegramConfig = null;
            let connectivityData = new Map();
            let domainMapping = new Map();
            
            // è°ƒè¯•æ—¥å¿—å‡½æ•°
            function debugLog(message, data) {
                const timestamp = new Date().toLocaleTimeString();
                if (elements.debugLog) {
                    const entry = document.createElement('div');
                    entry.style.padding = '5px 0';
                    entry.style.borderBottom = '1px solid rgba(255,255,255,0.1)';
                    entry.innerHTML = `<span style="color: #95a5a6">[${timestamp}]</span> ${message}`;
                    elements.debugLog.appendChild(entry);
                    elements.debugLog.scrollTop = elements.debugLog.scrollHeight;
                    
                    if (elements.debugLog.children.length > 50) {
                        elements.debugLog.removeChild(elements.debugLog.firstChild);
                    }
                }
                
                if (data) {
                    console.log(`[${timestamp}] ${message}`, data);
                } else {
                    console.log(`[${timestamp}] ${message}`);
                }
            }
            
            // åˆ‡æ¢è°ƒè¯•é¢æ¿æ˜¾ç¤º
            if (elements.toggleDebug) {
                elements.toggleDebug.addEventListener('click', function() {
                    if (elements.debugPanel.style.display === 'none') {
                        elements.debugPanel.style.display = 'block';
                        debugLog('æ˜¾ç¤ºè°ƒè¯•é¢æ¿');
                    } else {
                        elements.debugPanel.style.display = 'none';
                        debugLog('éšè—è°ƒè¯•é¢æ¿');
                    }
                });
            }
            
            // Telegramé…ç½®ç®¡ç†
            function loadTelegramConfig() {
                try {
                    const configStr = localStorage.getItem('telegram_config');
                    if (configStr) {
                        telegramConfig = JSON.parse(configStr);
                        elements.telegramBotToken.value = telegramConfig.botToken || '';
                        elements.telegramChatId.value = telegramConfig.chatId || '';
                        showTelegramStatus('å·²åŠ è½½ä¿å­˜çš„Telegramé…ç½®', 'success');
                        debugLog('åŠ è½½Telegramé…ç½®æˆåŠŸ');
                        return true;
                    }
                } catch (error) {
                    debugLog('åŠ è½½Telegramé…ç½®å¤±è´¥:', error.message);
                }
                return false;
            }
            
            function saveTelegramConfig() {
                const botToken = elements.telegramBotToken.value.trim();
                const chatId = elements.telegramChatId.value.trim();
                
                if (!botToken) {
                    showTelegramStatus('è¯·è¾“å…¥Bot Token', 'error');
                    return false;
                }
                
                if (!chatId) {
                    showTelegramStatus('è¯·è¾“å…¥Chat ID', 'error');
                    return false;
                }
                
                if (!botToken.match(/^\d+:[A-Za-z0-9_-]+$/)) {
                    showTelegramStatus('Bot Tokenæ ¼å¼ä¸æ­£ç¡®', 'error');
                    return false;
                }
                
                try {
                    telegramConfig = {
                        botToken: botToken,
                        chatId: chatId,
                        lastUpdated: new Date().toISOString()
                    };
                    
                    localStorage.setItem('telegram_config', JSON.stringify(telegramConfig));
                    showTelegramStatus('Telegramé…ç½®ä¿å­˜æˆåŠŸ', 'success');
                    debugLog('ä¿å­˜Telegramé…ç½®æˆåŠŸ');
                    return true;
                } catch (error) {
                    showTelegramStatus('ä¿å­˜é…ç½®å¤±è´¥: ' + error.message, 'error');
                    debugLog('ä¿å­˜Telegramé…ç½®å¤±è´¥:', error);
                    return false;
                }
            }
            
            function clearTelegramConfig() {
                if (confirm('ç¡®å®šè¦æ¸…é™¤Telegramé…ç½®å—ï¼Ÿ')) {
                    telegramConfig = null;
                    elements.telegramBotToken.value = '';
                    elements.telegramChatId.value = '';
                    localStorage.removeItem('telegram_config');
                    showTelegramStatus('Telegramé…ç½®å·²æ¸…é™¤', 'info');
                    debugLog('æ¸…é™¤Telegramé…ç½®');
                }
            }
            
            function testTelegramConnection() {
                if (!telegramConfig) {
                    showTelegramStatus('è¯·å…ˆä¿å­˜Telegramé…ç½®', 'error');
                    return;
                }
                
                const { botToken, chatId } = telegramConfig;
                
                showTelegramStatus('æ­£åœ¨æµ‹è¯•Telegramè¿æ¥...', 'info');
                
                // æ„å»ºæµ‹è¯•æ¶ˆæ¯
                const now = new Date();
                const currentTime = now.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                }).replace(/\//g, '-');
                
                const testMessage = `âœ… ITDOGè¿é€šç‡ç›‘æ§ç³»ç»Ÿæµ‹è¯•æ¶ˆæ¯\\n\\nğŸ•’ å‘é€æ—¶é—´: ${currentTime}\\nğŸ“Š æµ‹è¯•çŠ¶æ€: è¿æ¥æ­£å¸¸\\nğŸ”§ é…ç½®éªŒè¯: æˆåŠŸ\\n\\nç³»ç»Ÿå·²å‡†å¤‡å°±ç»ªï¼Œå½“ç½‘ç«™è¿é€šç‡ä½äº${connectivityThreshold}%æ—¶ä¼šè‡ªåŠ¨å‘é€é€šçŸ¥ã€‚`;
                
                // å‘é€æµ‹è¯•æ¶ˆæ¯
                fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat_id: chatId,
                        text: testMessage,
                        parse_mode: 'HTML',
                        disable_web_page_preview: true
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.ok) {
                        showTelegramStatus('âœ… Telegramè¿æ¥æµ‹è¯•æˆåŠŸï¼Œè¯·æ£€æŸ¥Telegramæ¶ˆæ¯', 'success');
                        addMonitorLog('Telegramè¿æ¥æµ‹è¯•æˆåŠŸ');
                        debugLog('Telegramè¿æ¥æµ‹è¯•æˆåŠŸ');
                    } else {
                        showTelegramStatus('âŒ Telegramè¿æ¥å¤±è´¥: ' + (data.description || 'æœªçŸ¥é”™è¯¯'), 'error');
                        addMonitorLog('Telegramè¿æ¥æµ‹è¯•å¤±è´¥');
                        debugLog('Telegramè¿æ¥æµ‹è¯•å¤±è´¥:', data);
                    }
                })
                .catch(error => {
                    showTelegramStatus('âŒ ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
                    addMonitorLog('Telegramè¿æ¥æµ‹è¯•ç½‘ç»œé”™è¯¯');
                    debugLog('Telegramè¿æ¥æµ‹è¯•ç½‘ç»œé”™è¯¯:', error);
                });
            }
            
            function showTelegramStatus(message, type) {
                if (!elements.telegramStatus) return;
                
                elements.telegramStatus.textContent = message;
                elements.telegramStatus.style.display = 'block';
                
                // è®¾ç½®é¢œè‰²
                if (type === 'success') {
                    elements.telegramStatus.style.background = '#d4edda';
                    elements.telegramStatus.style.color = '#155724';
                    elements.telegramStatus.style.border = '1px solid #c3e6cb';
                } else if (type === 'error') {
                    elements.telegramStatus.style.background = '#f8d7da';
                    elements.telegramStatus.style.color = '#721c24';
                    elements.telegramStatus.style.border = '1px solid #f5c6cb';
                } else {
                    elements.telegramStatus.style.background = '#d1ecf1';
                    elements.telegramStatus.style.color = '#0c5460';
                    elements.telegramStatus.style.border = '1px solid #bee5eb';
                }
                
                // 3ç§’åè‡ªåŠ¨éšè—
                setTimeout(() => {
                    if (type !== 'info') {
                        elements.telegramStatus.style.display = 'none';
                    }
                }, 5000);
            }
            
            // è®¾ç½®æ¶ˆæ¯ç›‘å¬ï¼ˆåŒ…å«é…ç½®è¯·æ±‚ç›‘å¬ï¼‰
            function setupMessageListening() {
                console.log('ğŸ”§ è®¾ç½®æ¶ˆæ¯ç›‘å¬ç³»ç»Ÿ');
                debugLog('å¯åŠ¨æ¶ˆæ¯ç›‘å¬ç³»ç»Ÿ');
                
                // ç›‘å¬messageäº‹ä»¶
                window.addEventListener('message', function(event) {
                    const data = event.data;
                    
                    // å¤„ç†é…ç½®è¯·æ±‚
                    if (data && data.type === 'REQUEST_TELEGRAM_CONFIG') {
                        console.log('æ”¶åˆ°é…ç½®è¯·æ±‚');
                        try {
                            if (telegramConfig) {
                                event.source.postMessage({
                                    type: 'TELEGRAM_CONFIG',
                                    config: telegramConfig,
                                    requestId: data.requestId
                                }, event.origin);
                                debugLog('å‘é€é…ç½®ç»™Tampermonkeyè„šæœ¬');
                            } else {
                                // å°è¯•ä»localStorageåŠ è½½
                                loadTelegramConfig();
                                if (telegramConfig) {
                                    event.source.postMessage({
                                        type: 'TELEGRAM_CONFIG',
                                        config: telegramConfig,
                                        requestId: data.requestId
                                    }, event.origin);
                                    debugLog('ä»localStorageåŠ è½½å¹¶å‘é€é…ç½®');
                                }
                            }
                        } catch (error) {
                            debugLog('å‘é€é…ç½®å¤±è´¥:', error);
                        }
                        return;
                    }
                    
                    // æ£€æŸ¥æ˜¯å¦æ˜¯ITDOGæ•°æ®
                    if (data && data.type === 'ITDOG_CONNECTIVITY_DATA') {
                        console.log('ğŸ“¨ æ”¶åˆ°ITDOGè¿é€šç‡æ•°æ®:', {
                            domain: data.domain,
                            rate: data.connectivityRate,
                            source: data.source
                        });
                        
                        debugLog(`å¤„ç†ITDOGè¿é€šç‡æ•°æ®: ${data.domain} - ${data.connectivityRate}%`);
                        
                        // å¤„ç†è¿é€šç‡æ•°æ®
                        handleConnectivityData(
                            data.domain, 
                            data.connectivityRate, 
                            data.testResults
                        );
                    }
                }, false);
                
                // å¯åŠ¨è½®è¯¢æœºåˆ¶
                startConnectivityPolling();
                
                debugLog('æ¶ˆæ¯ç›‘å¬ç³»ç»Ÿå·²å°±ç»ª');
            }
            
            // å¯åŠ¨è¿é€šç‡æ•°æ®è½®è¯¢
            function startConnectivityPolling() {
                const pollingInterval = setInterval(() => {
                    const latestKey = localStorage.getItem('itdog-latest-connectivity');
                    if (latestKey) {
                        try {
                            const dataStr = localStorage.getItem(latestKey);
                            if (dataStr) {
                                const data = JSON.parse(dataStr);
                                if (data.type === 'ITDOG_CONNECTIVITY_DATA') {
                                    debugLog(`è½®è¯¢å‘ç°æ•°æ®: ${data.domain}`);
                                    handleConnectivityData(
                                        data.domain,
                                        data.connectivityRate,
                                        data.testResults
                                    );
                                    localStorage.removeItem(latestKey);
                                }
                            }
                        } catch (error) {
                            debugLog(`è½®è¯¢è§£æé”™è¯¯: ${error.message}`);
                        }
                    }
                }, 2000);
                
                window.itdogPollingInterval = pollingInterval;
                debugLog('å¯åŠ¨è½®è¯¢æœºåˆ¶ï¼Œæ¯2ç§’æ£€æŸ¥ä¸€æ¬¡');
            }
            
            // åœæ­¢è½®è¯¢
            function stopConnectivityPolling() {
                if (window.itdogPollingInterval) {
                    clearInterval(window.itdogPollingInterval);
                    window.itdogPollingInterval = null;
                    debugLog('åœæ­¢è½®è¯¢æœºåˆ¶');
                }
            }
            
            // ç®€åŒ–çš„åŸŸååŒ¹é…å‡½æ•°
            function findDomainIndex(domainToMatch) {
                if (!domainToMatch || !domainArray.length) {
                    return -1;
                }
                
                const cleanMatch = domainToMatch.toLowerCase().trim()
                    .replace(/^https?:\/\//, '')
                    .replace(/\/.*$/, '')
                    .replace(/^www\./, '');
                
                debugLog(`å°è¯•åŒ¹é…åŸŸå: ${cleanMatch}`);
                
                // ç›´æ¥ä½¿ç”¨æ˜ å°„
                if (domainMapping.has(cleanMatch)) {
                    const index = domainMapping.get(cleanMatch);
                    debugLog(`æ˜ å°„åŒ¹é…æˆåŠŸ: ${cleanMatch} -> ${domainArray[index]}`);
                    return index;
                }
                
                // å¦‚æœæ˜ å°„ä¸­æ²¡æœ‰ï¼Œå°è¯•æŸ¥æ‰¾
                for (let i = 0; i < domainArray.length; i++) {
                    const original = domainArray[i];
                    const cleanOriginal = original.toLowerCase().trim()
                        .replace(/^https?:\/\//, '')
                        .replace(/\/.*$/, '')
                        .replace(/^www\./, '');
                    
                    if (cleanMatch === cleanOriginal) {
                        debugLog(`ç²¾ç¡®åŒ¹é…æˆåŠŸ: ${cleanMatch} -> ${original}`);
                        return i;
                    }
                }
                
                debugLog(`åŒ¹é…å¤±è´¥: ${cleanMatch}`);
                return -1;
            }
            
            // å¤„ç†è¿é€šç‡æ•°æ®
            function handleConnectivityData(domain, connectivityRate, testResults) {
                debugLog('å¤„ç†è¿é€šç‡æ•°æ®', { domain, connectivityRate });
                
                const domainIndex = findDomainIndex(domain);
                
                if (domainIndex === -1) {
                    debugLog('æ— æ³•åŒ¹é…åŸŸåï¼Œæ˜¾ç¤ºåœ¨æ—¥å¿—ä¸­');
                    addMonitorLog(`æ”¶åˆ°æœªåŒ¹é…åŸŸå: ${domain} - ${connectivityRate}%`);
                    return;
                }
                
                const matchedDomain = domainArray[domainIndex];
                debugLog(`æ‰¾åˆ°åŒ¹é…åŸŸå: ${matchedDomain} (ç´¢å¼•: ${domainIndex})`);
                
                // æ›´æ–°çŠ¶æ€
                updateDomainStatus(domainIndex, connectivityRate, testResults);
                
                // æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºæœ¬åœ°è­¦å‘Š
                if (connectivityRate < connectivityThreshold) {
                    addToConnectivityAlerts(matchedDomain, connectivityRate, testResults);
                }
                
                // æ›´æ–°ç›‘æ§æ—¥å¿—
                let logMessage = `è¿é€šç‡: ${matchedDomain} - ${connectivityRate}%`;
                if (testResults) {
                    if (testResults.success200Tests !== undefined && testResults.totalTests !== undefined) {
                        logMessage += ` [200: ${testResults.success200Tests}/${testResults.totalTests}]`;
                    }
                    if (testResults.status === 'error') {
                        logMessage += ` (å¼‚å¸¸: ${testResults.errorMessage || 'æœªçŸ¥é”™è¯¯'})`;
                    }
                }
                addMonitorLog(logMessage);
            }
            
            // æ›´æ–°åŸŸåçŠ¶æ€
            function updateDomainStatus(index, rate, testResults) {
                const statusElement = document.getElementById(`status-${index}`);
                if (!statusElement) {
                    debugLog(`æœªæ‰¾åˆ°çŠ¶æ€å…ƒç´ : status-${index}`);
                    return;
                }
                
                // ç§»é™¤æ—§å¾½ç« 
                const oldBadge = statusElement.querySelector('.connectivity-badge');
                if (oldBadge) oldBadge.remove();
                
                // ç¡®å®šçŠ¶æ€å’Œæ ·å¼
                let statusText = 'å·²å®Œæˆ';
                let statusClass = 'status-opened';
                let badgeClass = 'badge-good';
                
                if (rate === undefined || rate === null) {
                    statusText = 'æ— æ•°æ®';
                    statusClass = 'status-error';
                    badgeClass = 'badge-bad';
                } else if (testResults) {
                    if (testResults.status === 'error' || testResults.status === 'timeout') {
                        statusText = 'æµ‹è¯•å¼‚å¸¸';
                        statusClass = 'status-error';
                        badgeClass = 'badge-bad';
                    } else if (testResults.isLowRate === true || rate < connectivityThreshold) {
                        statusText = 'è¿é€šç‡ä½';
                        statusClass = 'status-low-connectivity';
                        badgeClass = 'badge-warning';
                    }
                } else if (rate < connectivityThreshold) {
                    statusText = 'è¿é€šç‡ä½';
                    statusClass = 'status-low-connectivity';
                    badgeClass = 'badge-warning';
                }
                
                // æ›´æ–°å…ƒç´ 
                statusElement.textContent = statusText;
                statusElement.className = `domain-status ${statusClass}`;
                
                // æ·»åŠ è¿é€šç‡å¾½ç« 
                if (rate !== undefined && rate !== null) {
                    const badge = document.createElement('span');
                    badge.className = `connectivity-badge ${badgeClass}`;
                    badge.textContent = `${rate}%`;
                    badge.title = `è¿é€šç‡: ${rate}%`;
                    statusElement.appendChild(badge);
                }
                
                debugLog(`æ›´æ–°çŠ¶æ€: ${domainArray[index]} -> ${statusText} (${rate}%)`);
            }
            
            // æ·»åŠ åˆ°è¿é€šç‡è­¦å‘Šåˆ—è¡¨
            function addToConnectivityAlerts(domain, rate, testResults) {
                const reason = rate < connectivityThreshold ? 
                    `è¿é€šç‡${rate}%ä½äºé˜ˆå€¼${connectivityThreshold}%` : 
                    (testResults?.errorMessage || 'æµ‹è¯•å¼‚å¸¸');
                
                connectivityAlerts.push({
                    id: Date.now(),
                    domain: domain,
                    rate: rate || 0,
                    time: new Date().toLocaleTimeString(),
                    reason: reason
                });
                
                updateAlertDisplay();
            }
            
            // æ›´æ–°è­¦æŠ¥æ˜¾ç¤º
            function updateAlertDisplay() {
                if (connectivityAlerts.length === 0) {
                    elements.connectivityAlert.style.display = 'none';
                    return;
                }
                
                elements.connectivityAlert.style.display = 'block';
                elements.alertList.innerHTML = '';
                
                // åªæ˜¾ç¤ºæœ€è¿‘10ä¸ªè­¦æŠ¥
                const recentAlerts = connectivityAlerts.slice(-10);
                recentAlerts.forEach(alert => {
                    const alertItem = document.createElement('div');
                    alertItem.className = 'alert-item';
                    alertItem.innerHTML = `
                        <div class="alert-domain">${alert.domain}</div>
                        <div class="alert-rate">${alert.rate}%</div>
                    `;
                    elements.alertList.appendChild(alertItem);
                });
                
                debugLog(`æ˜¾ç¤ºè­¦æŠ¥: ${recentAlerts.length}ä¸ª`);
            }
            
            // æ·»åŠ ç›‘æ§æ—¥å¿—
            function addMonitorLog(message) {
                const now = new Date();
                const timeString = now.toLocaleTimeString();
                
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                logEntry.innerHTML = `
                    <div class="log-time">${timeString}</div>
                    <div class="log-message">${message}</div>
                `;
                
                elements.monitorLog.appendChild(logEntry);
                
                if (elements.monitorLog.children.length > 50) {
                    elements.monitorLog.removeChild(elements.monitorLog.firstChild);
                }
                
                elements.monitorLog.scrollTop = elements.monitorLog.scrollHeight;
            }
            
            // æ¸…ç©ºæŒ‰é’®
            elements.clearBtn.addEventListener('click', function() {
                elements.domains.value = '';
                elements.result.style.display = 'none';
                elements.statusMonitor.style.display = 'none';
                elements.domains.focus();
                stopTesting();
                stopRetestMonitoring();
                stopConnectivityPolling();
                
                connectivityAlerts = [];
                connectivityData.clear();
                elements.connectivityAlert.style.display = 'none';
                elements.alertList.innerHTML = '';
                
                debugLog('æ¸…ç©ºè¾“å…¥å’ŒçŠ¶æ€');
            });
            
            // å¤åˆ¶è„šæœ¬æŒ‰é’®
            elements.copyScriptBtn.addEventListener('click', function() {
                const userscriptCode = document.getElementById('userscript-code');
                userscriptCode.style.display = 'block';
                const scriptText = userscriptCode.textContent;
                
                navigator.clipboard.writeText(scriptText)
                    .then(() => {
                        elements.copyScriptBtn.innerHTML = '<i class="fas fa-check btn-icon"></i> å·²å¤åˆ¶';
                        elements.copyScriptBtn.style.background = '#2ecc71';
                        
                        setTimeout(() => {
                            elements.copyScriptBtn.innerHTML = '<i class="fas fa-copy btn-icon"></i> å¤åˆ¶ç”¨æˆ·è„šæœ¬';
                            elements.copyScriptBtn.style.background = '';
                        }, 2000);
                        
                        debugLog('å·²å¤åˆ¶ç”¨æˆ·è„šæœ¬åˆ°å‰ªè´´æ¿');
                    })
                    .catch(err => {
                        debugLog(`å¤åˆ¶å¤±è´¥: ${err.message}`);
                    });
            });
            
            // å¼€å§‹æ‰¹é‡æµ‹è¯•
            elements.testBtn.addEventListener('click', function() {
                const domains = elements.domains.value.trim();
                
                if (!domains) {
                    alert('è¯·è¾“å…¥è‡³å°‘ä¸€ä¸ªç½‘ç«™åœ°å€');
                    elements.domains.focus();
                    debugLog('æµ‹è¯•å¼€å§‹å¤±è´¥: æœªè¾“å…¥åŸŸå');
                    return;
                }
                
                domainArray = domains.split('\n')
                    .map(domain => domain.trim())
                    .filter(domain => domain.length > 0);
                
                if (domainArray.length === 0) return;
                
                debugLog(`å¼€å§‹æ‰¹é‡æµ‹è¯•ï¼Œå…±${domainArray.length}ä¸ªåŸŸå`);
                
                // é‡ç½®çŠ¶æ€
                currentIndex = 0;
                isRunning = false;
                isPaused = false;
                activeWindows = 0;
                openedWindows = [];
                batchComplete = true;
                batchStartIndex = 0;
                currentBatchDomains = [];
                currentCycle = 1;
                totalCompleted = 0;
                firstRunComplete = false;
                
                // é‡ç½®è¿é€šç‡æ•°æ®
                connectivityAlerts = [];
                connectivityData.clear();
                elements.connectivityAlert.style.display = 'none';
                elements.alertList.innerHTML = '';
                
                // åˆ›å»ºåŸŸåæ˜ å°„
                domainMapping.clear();
                domainArray.forEach((domain, index) => {
                    const cleanDomain = domain.toLowerCase()
                        .replace(/^https?:\/\//, '')
                        .replace(/\/.*$/, '')
                        .replace(/^www\./, '');
                    domainMapping.set(cleanDomain, index);
                });
                
                debugLog('åˆ›å»ºåŸŸåæ˜ å°„', { mappingSize: domainMapping.size });
                
                // æ›´æ–°UI
                elements.domainCount.textContent = domainArray.length;
                elements.openedCount.textContent = '0';
                elements.remainingCount.textContent = domainArray.length;
                elements.progressText.textContent = `0/${domainArray.length}`;
                elements.progressFill.style.width = '0%';
                elements.testCycle.style.display = 'none';
                elements.countdownTimer.style.display = 'none';
                
                // ç”ŸæˆåŸŸååˆ—è¡¨
                elements.domainList.innerHTML = '';
                domainArray.forEach((domain, index) => {
                    const domainItem = document.createElement('div');
                    domainItem.className = 'domain-item';
                    domainItem.id = `domain-${index}`;
                    domainItem.innerHTML = `
                        <div class="domain-url">${index + 1}. ${domain}</div>
                        <div class="domain-status status-pending" id="status-${index}">ç­‰å¾…ä¸­</div>
                    `;
                    elements.domainList.appendChild(domainItem);
                });
                
                elements.result.style.display = 'block';
                elements.statusMonitor.style.display = 'block';
                
                elements.startBtn.disabled = false;
                elements.pauseBtn.disabled = true;
                elements.stopBtn.disabled = true;
                
                // åˆå§‹åŒ–è®¾ç½®
                initSettings();
                
                // å¯åŠ¨æ¶ˆæ¯ç›‘å¬
                setupMessageListening();
                
                elements.result.scrollIntoView({ behavior: 'smooth' });
                
                addMonitorLog('æµ‹è¯•å‡†å¤‡å®Œæˆï¼Œå…±' + domainArray.length + 'ä¸ªåŸŸå');
            });
            
            // æ‰¹é‡æ‰“å¼€åŸŸå
            function openDomainsInBatches() {
                if (!isRunning || isPaused) {
                    debugLog('è·³è¿‡: æœªè¿è¡Œæˆ–å·²æš‚åœ');
                    return;
                }
                
                if (batchStartIndex >= domainArray.length) {
                    if (activeWindows > 0) {
                        intervalId = setTimeout(openDomainsInBatches, 2000);
                        debugLog(`ç­‰å¾…æ´»åŠ¨çª—å£å…³é—­ï¼Œå‰©ä½™${activeWindows}ä¸ª`);
                        return;
                    } else {
                        completeCurrentCycle();
                        return;
                    }
                }
                
                if (!batchComplete) {
                    intervalId = setTimeout(openDomainsInBatches, 2000);
                    debugLog('ç­‰å¾…æ‰¹æ¬¡å®Œæˆ');
                    return;
                }
                
                batchComplete = false;
                currentBatchDomains = [];
                const batchCount = Math.min(batchSize, domainArray.length - batchStartIndex);
                
                debugLog(`å¼€å§‹æ–°æ‰¹æ¬¡ï¼Œä»${batchStartIndex}å¼€å§‹ï¼Œå…±${batchCount}ä¸ªåŸŸå`);
                
                for (let i = 0; i < batchCount; i++) {
                    const domainIndex = batchStartIndex + i;
                    const domain = domainArray[domainIndex];
                    
                    currentBatchDomains.push(domainIndex);
                    
                    (function(domainIndex, domain) {
                        const statusElement = document.getElementById(`status-${domainIndex}`);
                        if (statusElement) {
                            statusElement.textContent = 'æ‰“å¼€ä¸­...';
                            statusElement.className = 'domain-status status-opening';
                        }
                        
                        const itdogUrl = `https://www.itdog.cn/http/?domain=${encodeURIComponent(domain)}`;
                        
                        setTimeout(() => {
                            try {
                                const windowName = `itdog-${Date.now()}-${domainIndex}-cycle${currentCycle}`;
                                debugLog(`æ‰“å¼€çª—å£: ${domain}`);
                                
                                const testWindow = window.open(itdogUrl, windowName);
                                
                                if (testWindow) {
                                    activeWindows++;
                                    openedWindows.push({
                                        window: testWindow,
                                        index: domainIndex,
                                        domain: domain
                                    });
                                    
                                    const checkClose = setInterval(() => {
                                        if (testWindow.closed) {
                                            clearInterval(checkClose);
                                            activeWindows--;
                                            totalCompleted++;
                                            elements.completedDomains.textContent = totalCompleted;
                                            checkBatchCompletion();
                                            debugLog(`çª—å£å…³é—­: ${domain}ï¼Œå‰©ä½™æ´»åŠ¨çª—å£: ${activeWindows}`);
                                        }
                                    }, 1000);
                                    
                                    if (statusElement) {
                                        setTimeout(() => {
                                            if (statusElement.textContent === 'æ‰“å¼€ä¸­...') {
                                                statusElement.textContent = 'å·²æ‰“å¼€';
                                                statusElement.className = 'domain-status status-opened';
                                                debugLog(`çª—å£æ‰“å¼€æˆåŠŸ: ${domain}`);
                                            }
                                        }, 800);
                                    }
                                    
                                } else {
                                    debugLog(`çª—å£æ‰“å¼€å¤±è´¥: ${domain}`);
                                    if (statusElement) {
                                        statusElement.textContent = 'æ‰“å¼€å¤±è´¥';
                                        statusElement.className = 'domain-status status-error';
                                    }
                                    checkBatchCompletion();
                                }
                            } catch (error) {
                                debugLog(`æ‰“å¼€çª—å£å¼‚å¸¸: ${domain}`, { error: error.message });
                                if (statusElement) {
                                    statusElement.textContent = 'é”™è¯¯';
                                    statusElement.className = 'domain-status status-error';
                                }
                                checkBatchCompletion();
                            }
                        }, i * 500);
                    })(domainIndex, domain);
                }
                
                batchStartIndex += batchCount;
                elements.openedCount.textContent = batchStartIndex;
                elements.remainingCount.textContent = domainArray.length - batchStartIndex;
                
                const progressPercent = (batchStartIndex / domainArray.length) * 100;
                elements.progressFill.style.width = `${progressPercent}%`;
                elements.progressText.textContent = `${batchStartIndex}/${domainArray.length}`;
                
                addMonitorLog(`æ‰“å¼€æ‰¹æ¬¡ ${Math.ceil(batchStartIndex/batchSize)} (${batchCount}ä¸ªåŸŸå)`);
            }
            
            // æ£€æŸ¥æ‰¹æ¬¡å®Œæˆ
            function checkBatchCompletion() {
                let allCompleted = true;
                
                for (let i = 0; i < currentBatchDomains.length; i++) {
                    const domainIndex = currentBatchDomains[i];
                    const statusElement = document.getElementById(`status-${domainIndex}`);
                    
                    if (statusElement) {
                        const statusText = statusElement.textContent;
                        const completedStatuses = ['å·²å®Œæˆ', 'æµ‹è¯•å¼‚å¸¸', 'æµ‹è¯•è¶…æ—¶', 'è¿é€šç‡ä½', 'æ‰“å¼€å¤±è´¥', 'é”™è¯¯', 'å·²æ‰“å¼€', 'è‡ªåŠ¨å…³é—­', 'æ— æ•°æ®'];
                        
                        if (!completedStatuses.some(status => statusText.includes(status))) {
                            allCompleted = false;
                            break;
                        }
                    } else {
                        allCompleted = false;
                    }
                }
                
                if (allCompleted) {
                    batchComplete = true;
                    debugLog(`æ‰¹æ¬¡å®Œæˆ`);
                    
                    if (isRunning && !isPaused) {
                        setTimeout(() => {
                            openDomainsInBatches();
                        }, delay);
                    }
                }
            }
            
            // å®Œæˆå½“å‰è½®æ¬¡
            function completeCurrentCycle() {
                if (!isRunning) return;
                
                isRunning = false;
                elements.pauseBtn.disabled = true;
                elements.stopBtn.disabled = true;
                
                firstRunComplete = true;
                
                addMonitorLog(`ç¬¬${currentCycle}è½®æµ‹è¯•å®Œæˆï¼Œå…±${domainArray.length}ä¸ªåŸŸå`);
                
                if (!autoRetestEnabled) {
                    elements.retestStatus.textContent = 'å·²ç¦ç”¨';
                    addMonitorLog('å®šæ—¶é‡æ–°æµ‹è¯•å·²ç¦ç”¨');
                    
                    setTimeout(() => {
                        alert(`âœ… æ‰¹é‡æµ‹è¯•å®Œæˆï¼\nå·²æˆåŠŸå®Œæˆç¬¬${currentCycle}è½®æµ‹è¯•ï¼Œå…±æµ‹è¯• ${domainArray.length} ä¸ªåŸŸåã€‚`);
                    }, 500);
                    return;
                }
                
                if (!infiniteLoopEnabled && currentCycle >= maxCycles) {
                    elements.retestStatus.textContent = 'å·²å®Œæˆ';
                    addMonitorLog(`å·²è¾¾åˆ°æœ€å¤§è½®æ¬¡(${maxCycles})ï¼Œåœæ­¢é‡æ–°æµ‹è¯•`);
                    
                    setTimeout(() => {
                        alert(`âœ… å®šæ—¶é‡æ–°æµ‹è¯•å®Œæˆï¼\nå·²å®Œæˆ ${maxCycles} è½®æµ‹è¯•ï¼Œå…±æµ‹è¯• ${totalCompleted} æ¬¡åŸŸåã€‚`);
                    }, 500);
                    return;
                }
                
                elements.retestStatus.textContent = 'ç­‰å¾…é‡æ–°æµ‹è¯•';
                startRetestCountdown();
                addMonitorLog(`å°†åœ¨${retestIntervalMinutes}åˆ†é’Ÿåå¼€å§‹ç¬¬${currentCycle + 1}è½®é‡æ–°æµ‹è¯•`);
            }
            
            // å¼€å§‹é‡æµ‹å€’è®¡æ—¶
            function startRetestCountdown() {
                if (retestInterval) {
                    clearTimeout(retestInterval);
                    retestInterval = null;
                }
                
                if (countdownInterval) {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                }
                
                elements.countdownTimer.style.display = 'flex';
                elements.retestStatus.textContent = 'ç­‰å¾…é‡æ–°æµ‹è¯•';
                
                nextRetestTime = new Date();
                nextRetestTime.setMinutes(nextRetestTime.getMinutes() + retestIntervalMinutes);
                
                startCountdown();
                
                const retestIntervalMs = retestIntervalMinutes * 60 * 1000;
                retestInterval = setTimeout(() => {
                    startNextRetestCycle();
                }, retestIntervalMs);
                
                addMonitorLog(`ä¸‹æ¬¡é‡æ–°æµ‹è¯•æ—¶é—´: ${nextRetestTime.toLocaleTimeString()}`);
            }
            
            // å¼€å§‹å€’è®¡æ—¶
            function startCountdown() {
                if (countdownInterval) {
                    clearInterval(countdownInterval);
                }
                
                countdownInterval = setInterval(() => {
                    updateCountdown();
                }, 1000);
                
                updateCountdown();
            }
            
            // æ›´æ–°å€’è®¡æ—¶
            function updateCountdown() {
                if (!nextRetestTime) return;
                
                const now = new Date();
                const diffMs = nextRetestTime.getTime() - now.getTime();
                
                if (diffMs <= 0) {
                    elements.countdownValue.textContent = '00:00';
                    return;
                }
                
                const minutes = Math.floor(diffMs / 60000);
                const seconds = Math.floor((diffMs % 60000) / 1000);
                
                elements.countdownValue.textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
            
            // å¼€å§‹ä¸‹ä¸€è½®é‡æµ‹
            function startNextRetestCycle() {
                if (!autoRetestEnabled) {
                    return;
                }
                
                if (!infiniteLoopEnabled && currentCycle >= maxCycles) {
                    addMonitorLog(`å·²è¾¾åˆ°æœ€å¤§è½®æ¬¡(${maxCycles})ï¼Œåœæ­¢é‡æ–°æµ‹è¯•`);
                    elements.retestStatus.textContent = 'å·²å®Œæˆ';
                    elements.countdownTimer.style.display = 'none';
                    return;
                }
                
                currentCycle++;
                elements.currentCycle.textContent = currentCycle;
                elements.currentCycleStat.textContent = currentCycle;
                
                isRunning = true;
                isPaused = false;
                batchComplete = true;
                batchStartIndex = 0;
                currentBatchDomains = [];
                activeWindows = 0;
                openedWindows = [];
                
                elements.openedCount.textContent = '0';
                elements.remainingCount.textContent = domainArray.length;
                elements.progressText.textContent = `0/${domainArray.length}`;
                elements.progressFill.style.width = '0%';
                
                domainArray.forEach((domain, index) => {
                    const statusElement = document.getElementById(`status-${index}`);
                    if (statusElement) {
                        statusElement.textContent = 'ç­‰å¾…é‡æ–°æµ‹è¯•';
                        statusElement.className = 'domain-status status-retest';
                        const oldBadge = statusElement.querySelector('.connectivity-badge');
                        if (oldBadge) oldBadge.remove();
                    }
                });
                
                const now = new Date();
                elements.lastRetest.textContent = now.toLocaleTimeString();
                elements.retestStatus.textContent = 'é‡æ–°æµ‹è¯•ä¸­';
                elements.countdownTimer.style.display = 'none';
                
                addMonitorLog(`ç¬¬${currentCycle}è½®é‡æ–°æµ‹è¯•å¼€å§‹`);
                openDomainsInBatches();
            }
            
            // åœæ­¢æµ‹è¯•
            function stopTesting() {
                isRunning = false;
                isPaused = false;
                
                debugLog(`åœæ­¢æµ‹è¯•ï¼Œå…³é—­${openedWindows.length}ä¸ªçª—å£`);
                
                openedWindows.forEach(item => {
                    try {
                        if (item.window && !item.window.closed) {
                            item.window.close();
                        }
                    } catch (e) {
                        debugLog(`å…³é—­çª—å£å¼‚å¸¸: ${item.domain}`);
                    }
                });
                
                activeWindows = 0;
                openedWindows = [];
                
                if (intervalId) {
                    clearTimeout(intervalId);
                    intervalId = null;
                }
                
                elements.startBtn.disabled = false;
                elements.pauseBtn.disabled = true;
                elements.stopBtn.disabled = true;
                elements.pauseBtn.innerHTML = '<i class="fas fa-pause btn-icon"></i> æš‚åœ';
                
                debugLog('æµ‹è¯•å·²åœæ­¢');
            }
            
            // åœæ­¢é‡æµ‹ç›‘æ§
            function stopRetestMonitoring() {
                if (retestInterval) {
                    clearTimeout(retestInterval);
                    retestInterval = null;
                }
                
                if (countdownInterval) {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                }
                
                elements.retestStatus.textContent = 'å·²åœæ­¢';
                elements.countdownTimer.style.display = 'none';
                
                debugLog('é‡æµ‹ç›‘æ§å·²åœæ­¢');
            }
            
            // åˆå§‹åŒ–è®¾ç½®
            function initSettings() {
                // è·å–è¿é€šç‡é˜ˆå€¼
                connectivityThreshold = parseInt(document.getElementById('connectivity-threshold').value);
                desktopNotificationsEnabled = document.getElementById('enable-desktop-notifications').checked;
                
                // å®šæ—¶é‡æµ‹è®¾ç½®
                autoRetestEnabled = document.getElementById('auto-retest').checked;
                retestIntervalMinutes = parseInt(document.getElementById('retest-interval').value);
                infiniteLoopEnabled = document.getElementById('infinite-loop').checked;
                maxCycles = parseInt(document.getElementById('max-cycles').value);
                
                // æ›´æ–°è½®æ¬¡æ˜¾ç¤º
                if (infiniteLoopEnabled) {
                    elements.totalCycles.textContent = 'âˆ';
                    document.getElementById('max-cycles-option').style.display = 'none';
                } else {
                    elements.totalCycles.textContent = maxCycles;
                    document.getElementById('max-cycles-option').style.display = 'flex';
                }
                
                // è¯·æ±‚é€šçŸ¥æƒé™
                if (desktopNotificationsEnabled && Notification.permission === 'default') {
                    Notification.requestPermission().then(permission => {
                        debugLog(`é€šçŸ¥æƒé™: ${permission}`);
                    });
                }
                
                // å…³é—­è­¦æŠ¥æŒ‰é’®
                elements.alertClose.addEventListener('click', function() {
                    elements.connectivityAlert.style.display = 'none';
                    connectivityAlerts = [];
                    updateAlertDisplay();
                });
                
                debugLog('è®¾ç½®åˆå§‹åŒ–å®Œæˆ');
            }
            
            // å¼€å§‹æŒ‰é’®
            elements.startBtn.addEventListener('click', function() {
                if (domainArray.length === 0) {
                    return;
                }
                
                isRunning = true;
                isPaused = false;
                elements.startBtn.disabled = true;
                elements.pauseBtn.disabled = false;
                elements.stopBtn.disabled = false;
                
                elements.testCycle.style.display = 'flex';
                elements.currentCycle.textContent = currentCycle;
                
                openDomainsInBatches();
                
                addMonitorLog(`ç¬¬${currentCycle}è½®æµ‹è¯•å¼€å§‹`);
            });
            
            // æš‚åœæŒ‰é’®
            elements.pauseBtn.addEventListener('click', function() {
                if (isPaused) {
                    isPaused = false;
                    elements.pauseBtn.innerHTML = '<i class="fas fa-pause btn-icon"></i> æš‚åœ';
                    openDomainsInBatches();
                    addMonitorLog('æµ‹è¯•ç»§ç»­');
                } else {
                    isPaused = true;
                    elements.pauseBtn.innerHTML = '<i class="fas fa-play btn-icon"></i> ç»§ç»­';
                    if (intervalId) {
                        clearTimeout(intervalId);
                        intervalId = null;
                    }
                    addMonitorLog('æµ‹è¯•å·²æš‚åœ');
                }
            });
            
            // åœæ­¢æŒ‰é’®
            elements.stopBtn.addEventListener('click', function() {
                stopTesting();
                stopRetestMonitoring();
                stopConnectivityPolling();
                addMonitorLog('æµ‹è¯•å·²åœæ­¢');
            });
            
            // åˆå§‹åŒ–TelegramæŒ‰é’®äº‹ä»¶
            function initTelegramEvents() {
                // ä¿å­˜é…ç½®æŒ‰é’®
                elements.saveTelegramBtn.addEventListener('click', saveTelegramConfig);
                
                // æµ‹è¯•TelegramæŒ‰é’®
                elements.testTelegramBtn.addEventListener('click', testTelegramConnection);
                
                // æ¸…é™¤é…ç½®æŒ‰é’®
                elements.clearTelegramBtn.addEventListener('click', clearTelegramConfig);
                
                // åŠ è½½å·²ä¿å­˜çš„é…ç½®
                loadTelegramConfig();
            }
            
            // åˆå§‹åŒ–é¡µé¢
            function initPage() {
                // è®¾ç½®ç¤ºä¾‹åŸŸå
                elements.domains.value = 
`https://www.alibabacloud.com
www.dynadot.com
itdog.cn
godaddy.com
github.com
google.com`;
                
                // å¿«æ·é”®
                elements.domains.addEventListener('keydown', function(event) {
                    if (event.ctrlKey && event.key === 'Enter') {
                        event.preventDefault();
                        elements.testBtn.click();
                    }
                });
                
                elements.domains.focus();
                
                // åˆå§‹åŒ–Telegramäº‹ä»¶
                initTelegramEvents();
                
                // æ˜¾ç¤ºè°ƒè¯•é¢æ¿
                elements.debugPanel.style.display = 'block';
                
                addMonitorLog('ç³»ç»Ÿå·²å‡†å¤‡å°±ç»ª');
                debugLog('é¡µé¢åˆå§‹åŒ–å®Œæˆ');
            }
            
            // å¯åŠ¨
            initPage();
        });
    </script>
</body>
</html>
